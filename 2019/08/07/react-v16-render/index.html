<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Microsoft YaHei, Verdana, sans-serif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.que01.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"AL4M83H31B","apiKey":"d30226bc78f2b15b834d9fc9993e3c42","indexName":"hexo","hits":{"per_page":10}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"bounceDownIn","post_body":"bounceDownIn","coll_header":"slideLeftIn","sidebar":"fadeInUp"}},"path":"search.xml"};
  </script>

  <meta name="description" content="è¿™é‡Œæ˜¯V16çš„renderéƒ¨åˆ†ã€‚æ—©ä¹‹å‰å¯¹v15ç›¸å…³é€»è¾‘å¥½å¥½æ•´ç†äº†ä¸€æ¬¡ï¼Œä½†æ˜¯v16æœ€ç»ˆè¿˜æ˜¯è¦çœ‹ä¸€çœ‹ï¼Œçœ‹çœ‹fiberæ˜¯å¦‚ä½•é‡æ„äº†æ•´ä¸ªreactçš„è°ƒå’Œã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="react-fiber-render">
<meta property="og:url" content="http://www.que01.top/2019/08/07/react-v16-render/index.html">
<meta property="og:site_name" content="Que&#39;s Blog">
<meta property="og:description" content="è¿™é‡Œæ˜¯V16çš„renderéƒ¨åˆ†ã€‚æ—©ä¹‹å‰å¯¹v15ç›¸å…³é€»è¾‘å¥½å¥½æ•´ç†äº†ä¸€æ¬¡ï¼Œä½†æ˜¯v16æœ€ç»ˆè¿˜æ˜¯è¦çœ‹ä¸€çœ‹ï¼Œçœ‹çœ‹fiberæ˜¯å¦‚ä½•é‡æ„äº†æ•´ä¸ªreactçš„è°ƒå’Œã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-08-07T09:23:22.000Z">
<meta property="article:modified_time" content="2020-12-17T13:21:55.000Z">
<meta property="article:author" content="que01">
<meta property="article:tag" content="react">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.que01.top/2019/08/07/react-v16-render/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react-fiber-render | Que's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Que's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WebFrontEnd Development</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.que01.top/2019/08/07/react-v16-render/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="que01">
      <meta itemprop="description" content="è‡ªå·±çš„å­¦ä¹ è®°å½•">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Que's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react-fiber-render
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-08-07 17:23:22" itemprop="dateCreated datePublished" datetime="2019-08-07T17:23:22+08:00">2019-08-07</time>
            </span>

          
            <span id="/2019/08/07/react-v16-render/" class="post-meta-item leancloud_visitors" data-flag-title="react-fiber-render" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <div class="post-description">è¿™é‡Œæ˜¯V16çš„renderéƒ¨åˆ†ã€‚æ—©ä¹‹å‰å¯¹v15ç›¸å…³é€»è¾‘å¥½å¥½æ•´ç†äº†ä¸€æ¬¡ï¼Œä½†æ˜¯v16æœ€ç»ˆè¿˜æ˜¯è¦çœ‹ä¸€çœ‹ï¼Œçœ‹çœ‹fiberæ˜¯å¦‚ä½•é‡æ„äº†æ•´ä¸ªreactçš„è°ƒå’Œã€‚</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="å¼€å¤´"><a href="#å¼€å¤´" class="headerlink" title="å¼€å¤´"></a>å¼€å¤´</h1><p>å› ä¸ºæœ€è¿‘é˜…è¯»çš„ä»£ç ä»v15.6.2æ¢åˆ°äº†v16.8.6äº†ï¼Œè¿™ä¹‹é—´çš„ç‰ˆæœ¬å‘å¸ƒæ—¶é—´å¤§æ¦‚æœ‰ä¸€å¹´ä¹‹ä¹…äº†ã€‚å…¶é—´å¾ˆå¤šä¸œè¥¿éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œå°¤å…¶æ˜¯React Fiberç”¨é“¾è¡¨æ›¿ä»£äº†ä¹‹å‰çš„æ ‘ç»“æ„ã€‚æ‰€ä»¥è¿™é‡Œçš„Renderå¿…é¡»é‡æ–°å®ç°ã€‚</p>
<p>è¿™é‡Œæ¢äº†åœ°å›¾è¿™å—è¿˜æ˜¯å¿…é¡»å…ˆçœ‹çœ‹ã€‚</p>
<h1 id="Renderçº¿è·¯-åˆå§‹åŒ–"><a href="#Renderçº¿è·¯-åˆå§‹åŒ–" class="headerlink" title="Renderçº¿è·¯-åˆå§‹åŒ–"></a>Renderçº¿è·¯-åˆå§‹åŒ–</h1><p>æƒ³äº†ä¸ªåŠæ³•ä¸€è¾¹å±•ç¤ºè°ƒç”¨ï¼Œä»¥ä¾¿ç²¾ç®€ä»£ç å±•ç¤ºæ ¸å¿ƒè°ƒç”¨ï¼Œè¿™é‡Œç®—æ˜¯å…¥å£çº§åˆ«çš„è·¯å¾„:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render</span><br><span class="line">  -&gt;legacyRenderSubtreeIntoContainer &#123;</span><br><span class="line">    root = legacyCreateRootFromDOMContainer()</span><br><span class="line">            -&gt; <span class="keyword">new</span> ReactRoot -&gt; createContainer -&gt; createFiberRoot -&gt; <span class="built_in">Object</span>.assign(createHostRootFiber(), &#123;</span><br><span class="line">              current: createHostRootFiber() -&gt; createFiber()</span><br><span class="line">            &#125;)</span><br><span class="line">    root.render() -&gt; ReactRoot.prototype.render() &#123;</span><br><span class="line">      <span class="keyword">const</span> work = <span class="keyword">new</span> ReactWork();</span><br><span class="line">      updateContainer(children, root, <span class="literal">null</span>, work._onCommit)</span><br><span class="line">        -&gt; updateContainerAtExpirationTime</span><br><span class="line">          -&gt; scheduleRootUpdate () &#123;</span><br><span class="line">              flushPassiveEffects();</span><br><span class="line">              enqueueUpdate(current, update) -&gt; appendUpdateToQueue</span><br><span class="line">              scheduleWork(current, expirationTime)</span><br><span class="line">                -&gt; requestWork -&gt; performWorkOnRoot -&gt; (renderRoot -&gt; workLoop) || completeRoot</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆæ¬¡æ¸²æŸ“çš„è·¯å¾„å¤§ä½“æ˜¯: </p>
<ul>
<li>æ ¹æ®ç»™å®šçš„DOMåˆ›å»ºä¸€ä¸ªFiberRootå…ƒç´ ï¼Œç„¶åå°†è¿™ä¸ªFiberRoot.currentæŒ‡å‘createHostRootFiber()ï¼Œæ¥ä¸‹æ¥è°ƒç”¨ReactRootä¸Šçš„renderè¿›è¡Œæ¸²æŸ“ã€‚</li>
<li>ReactRoot.renderä¸€è·¯èµ°åˆ°renderRootã€‚</li>
</ul>
<p>renderRootæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„å‡½æ•°ï¼Œæ ¸å¿ƒçš„è°ƒç”¨workLoopé‡Œé¢ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">isYieldy</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isYieldy) &#123;</span><br><span class="line">    <span class="comment">// Flush work without yielding</span></span><br><span class="line">    <span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Flush asynchronous work until there&#x27;s a higher priority event</span></span><br><span class="line">    <span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span> &amp;&amp; !shouldYieldToRenderer()) &#123;</span><br><span class="line">      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘æ¸²æŸ“è¿‡ç¨‹çš„ä¸­æ–­ï¼Œæ‰€ä»¥æ ¸å¿ƒå°±æ˜¯å¯¹<code>performUnitOfWork(nextUnitOfWork)</code>çš„éå†ï¼Œç›´åˆ°å…¶å€¼è¿”å›nullä¸ºæ­¢ã€‚</p>
<h2 id="éå†ç†è®º"><a href="#éå†ç†è®º" class="headerlink" title="éå†ç†è®º"></a>éå†ç†è®º</h2><p>è¿™é‡Œéå†é€»è¾‘æœ‰ç‚¹æŠ˜è…¾ã€‚ä¸ç²¾ç®€çš„è¯å®åœ¨æœ‰äº›ä¸å¤ªå¥½ç†è§£ã€‚</p>
<p>ç©¶å…¶æ ¹æœ¬ï¼Œä¸ªäººè®¤ä¸ºåŸºäºé“¾è¡¨çš„æ ‘éå†ç¡®å®æœ‰äº›åäººç±»ç›´è§‰â€”â€”ä¸ç„¶Reactä¸€å¼€å§‹ä¹Ÿä¸ä¼šä½¿ç”¨Treeç»“æ„è€Œæ²¡æœ‰è€ƒè™‘ç”¨é“¾è¡¨ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠ4ä¸ªAPI: performUnitOfWork|beginWork|completeUnitOfWork|completeWorkã€‚åœ¨éå†è¿™ä¸ªäº‹æƒ…ä¸Šï¼Œ<strong>æˆ‘ç”¨äº†å‚è€ƒæ–‡ç« é‡Œé¢æåˆ°çš„ä¼ªä»£ç </strong>(æ²¡åŠæ³•ï¼Œè¿™ä¸ªçœ‹æ‡‚äº†åœ¨å®è§‚ä¸Šå¯¹éå†æœ‰äº†æ¦‚å¿µï¼Œç†è§£ç›¸å…³äº‹æƒ…å°±å®¹æ˜“å¤šäº†):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> next = beginWork(workInProgress);</span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">        next = completeUnitOfWork(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;work performed for &#x27;</span> + workInProgress.name);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> returnFiber = workInProgress.return;</span><br><span class="line">        <span class="keyword">let</span> siblingFiber = workInProgress.sibling;</span><br><span class="line"></span><br><span class="line">        nextUnitOfWork = completeWork(workInProgress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is a sibling, return it </span></span><br><span class="line">            <span class="comment">// to perform work for this sibling</span></span><br><span class="line">            <span class="keyword">return</span> siblingFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there&#x27;s no more work in this returnFiber, </span></span><br><span class="line">            <span class="comment">// continue the loop to complete the returnFiber.</span></span><br><span class="line">            workInProgress = returnFiber;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;work completed for &#x27;</span> + workInProgress.name);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€å¥—åŸºäºFiberé“¾è¡¨ç»“æ„ã€ä½†æ˜¯é’ˆå¯¹æ ‘çš„éå†ç®—æ³•ã€‚è¿™é‡Œå°±ç®—æ³•è¯´ä¸€äº›ç†è®ºä¸Šçš„ä¸œè¥¿:</p>
<ol>
<li><p>å¯¹æŒ‡å®šèŠ‚ç‚¹ï¼Œé€’å½’è¿›å…¥ç¬¬ä¸€ä¸ªchildèŠ‚ç‚¹(è¿›å…¥å­èŠ‚ç‚¹ å¦‚æœå­èŠ‚ç‚¹è¿˜æœ‰å­èŠ‚ç‚¹ç›´æ¥è¿›å…¥ å¦‚æ­¤ç±»æ¨)</p>
</li>
<li><p>ç›´åˆ°child===null, å¼€å§‹æŒ¨ä¸ªæŸ¥æ‰¾siblingèŠ‚ç‚¹(å¦‚æœè¯¥èŠ‚ç‚¹æœ‰childï¼Œé‡æ–°æ‰§è¡Œæ•´ä¸ª1&amp;2é€»è¾‘)</p>
</li>
<li><p>ç›´åˆ°siblingèŠ‚ç‚¹===null,è¿”å›ä¸Šä¸€çº§èŠ‚ç‚¹</p>
</li>
<li><p>åœ¨ä¸Šä¸€èŠ‚èŠ‚ç‚¹ä¸Šæ‰¾sibingï¼Œå¦‚æœæœ‰childï¼Œé€’å½’childé‡å¤ä¹‹å‰é€»è¾‘ï¼Œæ²¡æœ‰ç›´æ¥è¿”å›ä¸Šä¸€çº§</p>
</li>
<li><p>æœ€åå¦‚æ­¤é‡å¤ï¼Œä¸€ç›´åˆ°è¿”å›æ ¹èŠ‚ç‚¹ã€‚</p>
</li>
</ol>
<p>è¿™å¥—éå†ç®—æ³•å¯ä»¥å°†æ•´æ£µæ ‘éƒ½éå†åˆ°ã€‚å¦‚æœåªæ˜¯ç†è®ºä¸Šçš„éå†ï¼Œç†è®ºä¸Šå®ƒæ²¡æœ‰ä¹‹å‰æ ‘éå†å¿«ï¼Œå› ä¸ºæ ‘éå†å¯ä»¥å¤šèŠ‚ç‚¹å¹¶è¡Œéå†ï¼Œè€Œè¿™é‡ŒåŸºäºé“¾è¡¨åªèƒ½ä¸€ä¸ªä¸€ä¸ªçº¿æ€§å»éå†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå°±åƒä¹‹å‰åŸºäºæ ‘Treeé‡Œé¢æœ‰ç²—æš´çš„ç›´æ¥æ›¿æ¢æ•´ä¸ªä¸‹çº§ä¸€æ ·ï¼Œè¿™é‡Œçš„çº¿æ€§éå†ä¹Ÿå¯ä»¥å€ŸåŠ©ç±»ä¼¼æ–¹æ³•è¿›è¡Œåˆ¤æ–­è·³è¿‡ä¸€äº›childçš„æ·±å…¥ä»¥å®ç°ç›¸å·®æ— å‡ çš„é«˜æ•ˆéå†ã€‚</p>
<p><strong>è¿™ä¸ªéå†ï¼Œæ˜¯ä»åº•éƒ¨å¾€é¡¶éƒ¨ã€ä»å·¦è¾¹å‘å³è¾¹çš„éå†ã€‚</strong></p>
<p>è‡³äºä¸ºä»€ä¹ˆè¿™é‡Œå…ˆè®²é“ç†å†åé¢è¯´è¯¦ç»†æµç¨‹ï¼Œè¯´åˆ°åº•ï¼Œæ ¹æ®ä»£ç é€†å‘åæ¨æ€è·¯ï¼ŒçœŸçš„æ˜¯ä¸€ä»¶è´¹æ—¶è´¹åŠ›ï¼Œè¿˜æ‰å¤´å‘çš„äº‹æƒ…ã€‚ã€‚ã€‚æœ‰ä¸Šå±‚æ€æƒ³æŒ‡å¯¼ï¼Œå†å»çœ‹å°±ä¸ä¼šèµ°å¼¯è·¯â€”â€”å®åœ¨æ˜¯çœ‹v15æ—¶å€™åƒäº†å¤ªå¤šè¿™æ–¹é¢çš„äºï¼Œè¿™æ¬¡æœ‰ç°æˆæ–‡ç« ï¼Œå°±å¥½å¥½å‚è€ƒä¸€ä¸‹ã€‚ğŸ˜‚</p>
<h2 id="æºç ç»†èŠ‚-renderé˜¶æ®µ"><a href="#æºç ç»†èŠ‚-renderé˜¶æ®µ" class="headerlink" title="æºç ç»†èŠ‚(renderé˜¶æ®µ)"></a>æºç ç»†èŠ‚(renderé˜¶æ®µ)</h2><h3 id="workLoopåŠå‰ç½®è°ƒç”¨"><a href="#workLoopåŠå‰ç½®è°ƒç”¨" class="headerlink" title="workLoopåŠå‰ç½®è°ƒç”¨"></a>workLoopåŠå‰ç½®è°ƒç”¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If this is a nested container, this won&#x27;t be the root.</span></span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line">  <span class="comment">// å›å»æœ€è¿‘çš„çˆ¶ç¥–èŠ‚ç‚¹context</span></span><br><span class="line">  <span class="comment">// å¦‚æœè‡ªå®šä¹‰ç»„ä»¶å®šä¹‰äº†childContextTypesåˆ™è¿”å›è¯¥ç»„ä»¶context</span></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> scheduleRootUpdate(current, element, expirationTime, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime);</span><br><span class="line">  <span class="comment">// React DevToolsä¾èµ–è¯¥å˜é‡ element</span></span><br><span class="line">  update.payload = &#123;element&#125;;</span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">	<span class="comment">// callbackå¿…é¡»ä¸ºfunction å¦åˆ™è¿™é‡Œä¼šæŠ¥é”™</span></span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  flushPassiveEffects();</span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒenqueueUpdateä¸»è¦æ˜¯è°ƒç”¨appendUpdateToQueueã€‚è¿™ä¸ªå‡½æ•°åŸºæœ¬å¯ä»¥ç†è§£ä¸ºå‘updateæ•°ç»„pushä¸€ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">appendUpdateToQueue</span>(<span class="params">queue, update</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// lastUpdate===nullè¯´æ˜ä¹‹å‰æ˜¯ç©ºçš„é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (queue.lastUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        queue.firstUpdate = queue.lastUpdate = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™å°†updateæ”¾åˆ°é“¾è¡¨é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        queue.lastUpdate.next = update;</span><br><span class="line">        queue.lastUpdate = update;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åenqueueUpdateæ‰§è¡Œçš„ç»“æœæ˜¯ç»™fiber.updateQueueä»¥åŠfiber.alternate.updateQueueè¿›è¡Œäº†èµ‹å€¼ã€‚è¿™é‡Œåé¢çœ‹çœ‹å…·ä½“å«ä¹‰ã€‚</p>
<p>æ ¸å¿ƒçš„è°ƒç”¨æ˜¯scheduleWorkã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleWork</span>(<span class="params">fiber: Fiber, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = scheduleWorkToRoot(fiber, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  markPendingPriorityLevel(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">	<span class="comment">// å¦‚æœæ˜¯åœ¨renderé˜¶æ®µ æˆ‘ä»¬ä¸éœ€è¦è§„åˆ’updateè¡Œä¸º</span></span><br><span class="line">    <span class="comment">// å› ä¸ºå¿…é¡»åœ¨å­˜åœ¨åæ‰èƒ½å†å»åšè¿™äº›</span></span><br><span class="line">    !isWorking ||</span><br><span class="line">    isCommitting ||</span><br><span class="line">    <span class="comment">// ç›´åˆ°è¿™ä¸ªrootå’Œæˆ‘ä»¬æ­£è¦renderçš„ä¸ä¸€æ ·</span></span><br><span class="line">    nextRoot !== root</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> rootExpirationTime = root.expirationTime;</span><br><span class="line">    requestWork(root, rootExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) &#123;</span><br><span class="line">    <span class="comment">// Reset this back to zero so subsequent updates don&#x27;t throw.</span></span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// ä¸€äº›æŠ¥é”™ æ— å…³åˆ†æ åˆ </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestWork</span>(<span class="params">root: FiberRoot, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  addRootToSchedule(root, expirationTime);</span><br><span class="line">  <span class="keyword">if</span> (isRendering) &#123;</span><br><span class="line">    <span class="comment">// ç¦æ­¢é€’å½’è°ƒç”¨ åé¢çš„ä»»åŠ¡åœ¨ç»“æŸå†é‡æ–°å¼€å§‹</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isBatchingUpdates) &#123; <span class="comment">// åˆå§‹renderè¿™é‡Œä¸ºfalse</span></span><br><span class="line">    <span class="comment">// åœ¨æ‰¹å¤„ç†ç»“æŸåå¼€å§‹æ¸…æ´—å·¥ä½œ(é’ˆå¯¹è„ç»„ä»¶|Fiber?)</span></span><br><span class="line">    <span class="keyword">if</span> (isUnbatchingUpdates) &#123;</span><br><span class="line">      <span class="comment">// é™¤éè¢«æ’é™¤åœ¨unbatchedUpdatesï¼Œå¦åˆ™ç°åœ¨éœ€è¦å¼€å§‹è¿›è¡Œæ¸…æ´—</span></span><br><span class="line">      nextFlushedRoot = root;</span><br><span class="line">      nextFlushedExpirationTime = Sync;</span><br><span class="line">      performWorkOnRoot(root, Sync, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Get rid of Sync and use current time?</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œæ˜¯åŒæ­¥å¼‚æ­¥å¤„ç†åˆ†æ”¯ è¿™é‡Œæš‚æ—¶çœ‹åŒæ­¥é€»è¾‘</span></span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">    performSyncWork();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    scheduleCallbackWithExpirationTime(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">performSyncWork -&gt; performWork(Sync, <span class="literal">false</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">minExpirationTime: ExpirationTime, isYieldy: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Keep working on roots until there&#x27;s no more work, or until there&#x27;s a higher</span></span><br><span class="line">  <span class="comment">// priority event.</span></span><br><span class="line">  findHighestPriorityRoot();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isYieldy) &#123;</span><br><span class="line">	<span class="comment">// å¼‚æ­¥é€»è¾‘ è¿™é‡Œæš‚æ—¶ä¸ç®¡</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      nextFlushedRoot !== <span class="literal">null</span> &amp;&amp; <span class="comment">// è¿˜æœ‰rootæ²¡æœ‰å¤„ç†å®Œ(å«æœ‰childçš„èŠ‚ç‚¹)</span></span><br><span class="line">      nextFlushedExpirationTime !== NoWork &amp;&amp; <span class="comment">// è¿‡æœŸæ—¶é—´ä¸ä¸ºNoWork</span></span><br><span class="line">      minExpirationTime &lt;= nextFlushedExpirationTime <span class="comment">// æ­¤æ—¶è¿™ä¸¤ä¸ªå˜é‡ç›¸ç­‰</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      performWorkOnRoot(nextFlushedRoot, nextFlushedExpirationTime, <span class="literal">false</span>);</span><br><span class="line">      findHighestPriorityRoot();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nextFlushedExpirationTime !== NoWork) &#123;</span><br><span class="line">    scheduleCallbackWithExpirationTime(</span><br><span class="line">      ((nextFlushedRoot: any): FiberRoot),</span><br><span class="line">      nextFlushedExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Clean-up.</span></span><br><span class="line">  finishRendering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>findHighestPriorityRoot</code>å’Œ<code>performWorkOnRoot</code>å‡½æ•°å¯èƒ½æ˜¯è¿™é‡Œæœ€æ ¸å¿ƒçš„åœ°æ–¹ã€‚</p>
<p><code>findHighestPriorityRoot</code>å‡½æ•°å‘½åå·²ç»è¯´æ˜å®ƒçš„ä½œç”¨: ã€Œæ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§æ ¹ã€ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å’ŒFiberç»“æ„è”ç³»å¾ˆç´§å¯†: <code>Fibler.nextScheduledRoot</code>æ˜¯æ ¸å¿ƒå˜é‡ï¼Œå®ƒä¸»è¦æ˜¯å¯¹firstScheduledRoot(packages/react-reconciler/src/ReactFiberScheduler.js)å˜é‡(é—­åŒ…å˜é‡)è¿›è¡Œæ“ä½œã€‚è¿™ä¸ªå˜é‡è®°å½•æˆ‘ä»¬è¦è¿›è¡Œæ“ä½œçš„èŠ‚ç‚¹æ ¹ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªå‡½æ•°éœ€è¦ä¸€ä¸ªåˆå§‹å€¼ï¼ŒReactFiberScheduler.jsä¸­å®ƒçš„åˆå§‹å€¼ä¸ºnullã€‚é‚£ä¹ˆå®ƒçš„å¸¸è§„å€¼ä»å“ªå„¿æ¥å‘¢?ä»requestWorkä¸­çš„addRootToScheduleå‡½æ•°è°ƒç”¨é‡Œã€‚</p>
<p>è¿™ä¸ªå‡½æ•°è¿™é‡Œä¸è´´ä»£ç ï¼Œè®¤çœŸçœ‹çœ‹ï¼Œå¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬åˆæ¬¡æ¸²æŸ“æ—¶å€™ï¼Œæˆ‘ä»¬å¾—åˆ°è¦æ“ä½œçš„èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ã€‚è€Œä¸”æ ¹èŠ‚ç‚¹çš„nextScheduledRootä¹Ÿè®¾ä¸ºäº†è‡ªèº«ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firstScheduledRoot = lastScheduledRoot = root;</span><br><span class="line">root.nextScheduledRoot = root;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findHighestPriorityRoot</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> highestPriorityWork = NoWork;</span><br><span class="line">  <span class="keyword">let</span> highestPriorityRoot = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastScheduledRoot !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> previousScheduledRoot = lastScheduledRoot;</span><br><span class="line">    <span class="keyword">let</span> root = firstScheduledRoot;</span><br><span class="line">    <span class="keyword">while</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> remainingExpirationTime = root.expirationTime;</span><br><span class="line">      <span class="keyword">if</span> (remainingExpirationTime === NoWork) &#123;</span><br><span class="line"> 		<span class="comment">// åˆå§‹renderä¸èµ°è¿™é‡Œ ç•¥</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (remainingExpirationTime &gt; highestPriorityWork) &#123;</span><br><span class="line">          <span class="comment">// Update the priority, if it&#x27;s higher</span></span><br><span class="line">          highestPriorityWork = remainingExpirationTime;</span><br><span class="line">          highestPriorityRoot = root;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root === lastScheduledRoot) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// åˆå§‹renderåé¢è¢«break ç•¥</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  nextFlushedRoot = highestPriorityRoot;</span><br><span class="line">  nextFlushedExpirationTime = highestPriorityWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ä¹‹ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°ï¼ŒnextFlushedRootè¿™é‡Œè¢«è®¾ç½®ä¸ºrootFiberäº†ã€‚åé¢æ›´æ–°é€»è¾‘æˆ‘ä»¬å†æ¥ç»§ç»­ç ”ç©¶å®ƒæ›´å¤šåˆ†æ”¯ã€‚</p>
<h3 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a>performUnitOfWork</h3><p>æ¥ä¸‹æ¥å°±æ˜¯performWorkOnRootå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¹‹å‰æœ‰ä¼ªä»£ç ã€‚è¿™é‡Œè¿˜æ˜¯è¦çœ‹çœ‹å®é™…ä»£ç ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWorkOnRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  isYieldy: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  isRendering = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥åŒæ­¥è¿˜æ˜¯å¼‚æ­¥</span></span><br><span class="line">  <span class="keyword">if</span> (!isYieldy) &#123;</span><br><span class="line">    <span class="keyword">let</span> finishedWork = root.finishedWork;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// æ­¤æ—¶è¿™ä¸ªrootå·²ç»å¤„ç†å¥½äº†,å¯ä»¥è¿›å…¥commité˜¶æ®µ</span></span><br><span class="line">      completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">	  <span class="comment">// å¦‚æœæœ‰ä¹‹å‰æš‚åœçš„ä»»åŠ¡ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">      <span class="comment">// æˆ‘ä»¬å°†ä¼šé‡æ–°è¿›è¡Œæ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">const</span> timeoutHandle = root.timeoutHandle;</span><br><span class="line">      <span class="keyword">if</span> (timeoutHandle !== noTimeout) &#123;</span><br><span class="line">        root.timeoutHandle = noTimeout;</span><br><span class="line">        <span class="comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span></span><br><span class="line">        cancelTimeout(timeoutHandle);</span><br><span class="line">      &#125;</span><br><span class="line">      renderRoot(root, isYieldy); <span class="comment">// renderRootæ˜¯ä¸€ä¸ªé“¾è¡¨éå†çš„è¿‡ç¨‹</span></span><br><span class="line">      finishedWork = root.finishedWork;</span><br><span class="line">      <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶è¿™ä¸ªrootå·²ç»å¤„ç†å¥½äº†,å¯ä»¥è¿›å…¥commité˜¶æ®µ</span></span><br><span class="line">        completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¼‚æ­¥Flush ç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isRendering = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>renderRootå¯èƒ½æ˜¯æœ€é•¿çš„ä¸€ä¸ªå‡½æ•°äº†ã€‚ã€‚ã€‚</p>
<p>è¿™é‡Œä¿ç•™æ ¸å¿ƒä»£ç </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params">root: FiberRoot, isYieldy: boolean</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç¦æ­¢renderRooté€’å½’è°ƒç”¨ ä¸€æ—¦å¦‚æ­¤åˆ™éœ€è¦æŠ›å‡ºé”™è¯¯</span></span><br><span class="line"></span><br><span class="line">  isWorking = <span class="literal">true</span>; <span class="comment">// ä½œä¸ºç¦æ­¢è¢«é€’å½’è°ƒç”¨çš„Flag</span></span><br><span class="line">  <span class="keyword">const</span> previousDispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">  ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> expirationTime = root.nextExpirationTimeToWorkOn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if we&#x27;re starting from a fresh stack, or if we&#x27;re resuming from</span></span><br><span class="line">  <span class="comment">// previously yielded work.</span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯ä¸€ä¸ªæ–°çš„stackå¼€å§‹ï¼Œè¿˜æ˜¯ä»ä¹‹å‰è¢«ä¸­æ–­çš„åœ°æ–¹å¼€å§‹</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    expirationTime !== nextRenderExpirationTime ||</span><br><span class="line">    root !== nextRoot ||</span><br><span class="line">    nextUnitOfWork === <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Reset the stack and start working from the root.</span></span><br><span class="line">    <span class="comment">// é‡ç½®stack ä»Rootå¼€å§‹å·¥ä½œ</span></span><br><span class="line">    resetStack();</span><br><span class="line">    nextRoot = root;</span><br><span class="line">    nextRenderExpirationTime = expirationTime;</span><br><span class="line">    <span class="comment">// åˆ›å»ºnextUnitOfWork === workInProgress:Fiber;</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿›å…¥äº†è¿™ä¸ªé€»è¾‘ è¿™ä¸ªnextUnitOfWorkå˜é‡ä¼šè¢«workLoopå¼•ç”¨åˆ°</span></span><br><span class="line">    nextUnitOfWork = createWorkInProgress(</span><br><span class="line">      nextRoot.current,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextRenderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    root.pendingCommitExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> didFatal = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  startWorkLoopTimer(nextUnitOfWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoop(isYieldy);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      <span class="comment">// é”™è¯¯å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// Ready to commit.</span></span><br><span class="line">  onComplete(root, rootWorkInProgress, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯workLoop,åœ¨è¿™ä¸ªåˆå§‹renderç¯èŠ‚é‡Œé¢ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªwhileéå†ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶nextUnitOfWorkä¼šæ¯æ¬¡æ›´æ–°ï¼Œç›´åˆ°nextUnitOfWork === nullï¼Œæ­¤æ—¶æ„å‘³ç€æ‰€æœ‰èŠ‚ç‚¹è¢«éå†å®Œæ¯•äº†ã€‚ä¸è¿‡è¿˜æ˜¯çœ‹çœ‹é‡Œé¢é€»è¾‘ã€‚ç²¾ç®€ä¸€ä¸‹ä»£ç :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">workInProgress: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line"></span><br><span class="line">  startWorkTimer(workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">    </span><br><span class="line">  next = beginWork(current, workInProgress, nextRenderExpirationTime);</span><br><span class="line">  workInProgress.memoizedProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    next = completeUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><p>ç„¶åå°±æ˜¯beginWorkâ€”â€”æœ‰ç†ç”±ç›¸ä¿¡ï¼Œè¿™ä¸ªå‡½æ•°ä»¥åŠæ¶‰åŠåˆ°çš„ç›¸å…³å‡½æ•°ï¼Œæ˜¯æ•´ä¸ªrenderç¯èŠ‚é‡Œé¢æœ€å¤æ‚çš„ï¼Œå› ä¸ºå®ƒç›´æ¥è´Ÿè´£äº†Nç§å®ä¾‹çš„å®ä¾‹åŒ–ã€æ›´æ–°ã€æŒ‚è½½ï¼Œå¹¶å°†fiber.childè¿”å›ã€‚</p>
<p>è¿™Nç§å®ä¾‹åŒ…æ‹¬:</p>
<ul>
<li>IndeterminateComponent</li>
<li>LazyComponent</li>
<li>FunctionComponent</li>
<li>ClassComponent</li>
<li>HostRoot</li>
<li>HostComponent</li>
<li>HostText</li>
<li>SuspenseComponent</li>
<li>HostPortal</li>
<li>ForwardRef</li>
<li>Fragment</li>
<li>Mode</li>
<li>Profiler</li>
<li>ContextProvider</li>
<li>ContextConsumer</li>
<li>MemoComponent</li>
<li>SimpleMemoComponent</li>
<li>IncompleteClassComponent</li>
<li>DehydratedSuspenseComponent</li>
</ul>
<p>å®ƒæ˜¯å…·ä½“è´Ÿè´£å°†å„ç§ä¸åŒFiberè¿›è¡Œåˆ†ç±»çš„å‡½æ•°ï¼Œæ¢å¥æ—¶é«¦çš„è¯ï¼Œå®ƒè´Ÿè´£ã€åƒåœ¾åˆ†ç±»ã€ã€‚å½“æˆ‘ä»¬åˆå§‹renderæ—¶å€™ï¼Œèµ°çš„æ˜¯HostRootåˆ†æ”¯ã€‚è¿”å›äº†ä¸€ä¸ª<code>return updateHostRoot(args)</code>ã€‚è¿™é‡Œç”¨å®ƒåšåˆ‡å…¥ç‚¹ï¼Œå…¶ä½™æš‚ä¸”ä¸è®ºã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostRoot</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">  pushHostRootContext(workInProgress);</span><br><span class="line">  <span class="keyword">const</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// workInProgress.pendingProps|workInProgress.prevState</span></span><br><span class="line">  <span class="comment">// workInProgress.prevStateä¸‰ä¸ªå˜é‡å«ä¹‰è¿™é‡Œä¸å¤šè¯´</span></span><br><span class="line">  <span class="comment">// ä¸»è¦æ˜¯è¿½æº¯å…¶èµ‹å€¼æ¥æº</span></span><br><span class="line">  <span class="comment">// å›é¡¾è°ƒç”¨,workInProgressæ˜¯éƒ½æ˜¯ä¸€ä¸ªä¸ªèŠ‚ç‚¹ æˆ–fiber.nextï¼Œæˆ–fiber.child</span></span><br><span class="line">  <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">const</span> prevState = workInProgress.memoizedState;</span><br><span class="line">  <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å…³äºè¿™ä¸ªå‡½æ•°çœ‹åé¢çš„åˆ†æ å®Œäº†å†è·³å›æ¥</span></span><br><span class="line">  <span class="comment">// å®ƒä¸»è¦æ˜¯å¤„ç†updateQueueé˜Ÿåˆ—ï¼Œå¹¶æ›´æ–°äº†workInProgress.memoizedState</span></span><br><span class="line">  processUpdateQueue(</span><br><span class="line">    workInProgress,</span><br><span class="line">    updateQueue,</span><br><span class="line">    nextProps,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> nextState = workInProgress.memoizedState;</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called &quot;element&quot;.</span></span><br><span class="line">  <span class="keyword">const</span> nextChildren = nextState.element;</span><br><span class="line">  <span class="keyword">if</span> (nextChildren === prevChildren) &#123; <span class="comment">// è¿™ä¸ªåˆ†æ”¯åˆå§‹renderä¸ä¼šè¿›æ¥</span></span><br><span class="line">    <span class="comment">// If the state is the same as before, that&#x27;s a bailout because we had</span></span><br><span class="line">    <span class="comment">// no work that expires at this time.</span></span><br><span class="line">    resetHydrationState();</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = workInProgress.stateNode;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// è¿™ä¸ªåˆ†æ”¯åˆå§‹renderä¸ä¼šè¿›æ¥</span></span><br><span class="line">    (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">    root.hydrate &amp;&amp;</span><br><span class="line">    enterHydrationState(workInProgress)</span><br><span class="line">  ) &#123;</span><br><span class="line">    workInProgress.effectTag |= Placement;</span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// åˆå§‹renderä¼šè¿›æ¥</span></span><br><span class="line">    reconcileChildren(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    resetHydrationState();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³è”è°ƒç”¨(processUpdateQueue)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  instance: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  hasForceUpdate = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// ä¸€èˆ¬ç›´æ¥è¿”å›queue ä½†æ˜¯å½“workInProgress.alternate.updateQueue === queue</span></span><br><span class="line">  <span class="comment">// éœ€è¦å°†workInProgress.updateQueueé‡æ–°åšä¸ªå‰¯æœ¬å¹¶èµ‹å€¼å›å»ï¼Œå†è¿”å›è¿™ä¸ªå‰¯æœ¬</span></span><br><span class="line">  queue = ensureWorkInProgressQueueIsAClone(workInProgress, queue);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™äº›å€¼å¯èƒ½åœ¨åé¢è¿­ä»£ä¸­è¢«æ›´æ”¹ã€‚æ³¨æ„æ˜¯letä¸æ˜¯const</span></span><br><span class="line">  <span class="keyword">let</span> newBaseState = queue.baseState;</span><br><span class="line">  <span class="keyword">let</span> newFirstUpdate = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> newExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Iterate through the list of updates to compute the result.</span></span><br><span class="line">  <span class="keyword">let</span> update = queue.firstUpdate;</span><br><span class="line">  <span class="keyword">let</span> resultState = newBaseState;</span><br><span class="line">  <span class="keyword">while</span> (update !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123; <span class="comment">// è¿™é‡Œåˆ†æ”¯æš‚æ—¶å¯ä»¥å¿½ç•¥</span></span><br><span class="line">      <span class="comment">// æ­¤æ›´æ–°æ²¡æœ‰è¶³å¤Ÿçš„ä¼˜å…ˆçº§ã€‚è·³è¿‡å®ƒã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯ç¬¬ä¸€æ¬¡è·³è¿‡çš„æ›´æ–°.ä¸‹æ¬¡æ›´æ–°åˆ—è¡¨ä¸­å®ƒå°†æ’ç¬¬ä¸€ä¸ª</span></span><br><span class="line">        newFirstUpdate = update;</span><br><span class="line">        <span class="comment">// ç”±äºè¿™æ˜¯ç¬¬ä¸€æ¬¡è·³è¿‡çš„æ›´æ–°, å½“å‰ç»“æœæ˜¯&#x27;the new base state&#x27;.</span></span><br><span class="line">        newBaseState = resultState;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç”±äºæ­¤æ›´æ–°å°†ä¿ç•™åœ¨åˆ—è¡¨ä¸­ï¼Œå› æ­¤è¯·æ›´æ–°å‰©ä½™çš„åˆ°æœŸæ—¶é—´ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (newExpirationTime &lt; updateExpirationTime) &#123;</span><br><span class="line">        newExpirationTime = updateExpirationTime;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ­¤æ›´æ–°ç¡®å®å…·æœ‰è¶³å¤Ÿçš„ä¼˜å…ˆçº§ã€‚å¤„ç†å®ƒå¹¶è®¡ç®—æ–°ç»“æœã€‚</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">// è¿™ä¸ªåˆ†æ”¯åšäº†ä¸€ä¸‹è¿™äº›äº‹:</span></span><br><span class="line">      <span class="comment">// 1.æ ¹æ®update.tagç­‰å‚æ•°ï¼Œå¾—åˆ°ç›®æ ‡update.payloadçš„å¤„ç†åçš„Stateå€¼ </span></span><br><span class="line">      <span class="comment">// 2.æ ¹æ®update.callbackè®¾ç½®queueçš„firstEffectã€lastEffectå±æ€§</span></span><br><span class="line">      <span class="comment">//   ä»¥åŠqueue.lastEffect.nextEffectå±æ€§</span></span><br><span class="line">      <span class="comment">// 3.å¯¹queue.nextæ‰§è¡Œä¸Šé¢æ“ä½œ å¦‚æ­¤é‡å¤</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">// getStateFromUpdateè¿˜æ˜¯å€¼å¾—çœ‹çœ‹. update.tagæœ‰4ä¸ªEnumå€¼ï¼š</span></span><br><span class="line">      <span class="comment">// ReplaceState|CaptureUpdate|UpdateState|ForceUpdate</span></span><br><span class="line">      <span class="comment">// è¿™é‡Œåˆå§‹renderå¯¹åº”çš„æ˜¯UpdateState è¿™é‡Œé’ˆå¯¹Function Componentå’ŒpartialStateæœ‰ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">      <span class="comment">// å¥½å§ è¿™é‡Œä¸ç®¡é‚£ä¹ˆå¤šåˆ†æ”¯ å¸¸è§„çš„ClassComponentè¿”å›çš„å°±æ˜¯ä¸€ä¸ª:</span></span><br><span class="line">      <span class="comment">// update.payloadã€‚</span></span><br><span class="line">      <span class="comment">// ç®€å•ç‚¹ç†è§£: (queue.firstUpdate.tag) =&gt; &#123; ...queue.firstUpdate.payload &#125;</span></span><br><span class="line">      resultState = getStateFromUpdate(</span><br><span class="line">        workInProgress,</span><br><span class="line">        queue,</span><br><span class="line">        update,</span><br><span class="line">        resultState,</span><br><span class="line">        props,</span><br><span class="line">        instance,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> callback = update.callback;</span><br><span class="line">      <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">        workInProgress.effectTag |= Callback;</span><br><span class="line">        <span class="comment">// Set this to null, in case it was mutated during an aborted render.</span></span><br><span class="line">        update.nextEffect = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (queue.lastEffect === <span class="literal">null</span>) &#123; <span class="comment">// å¦‚æœè¿™ä¸ªå€¼ä¸ºnullè¿™queueé“¾è¡¨æ˜¯ç©º</span></span><br><span class="line">          queue.firstEffect = queue.lastEffect = update;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// å¦åˆ™å°†åŸæ¥çš„lastEffectçš„ä¸‹ä¸ªEffectè®¾ä¸ºupdate</span></span><br><span class="line">          <span class="comment">// ç„¶åå°†lastEffectæŒ‡å‘updateï¼›è¿™ä¸ªæ“ä½œå®è´¨ä¸Šç±»ä¼¼é“¾è¡¨ç‰ˆæœ¬çš„Array.push</span></span><br><span class="line">          <span class="comment">// æ˜¯å°†updateæ”¾åˆ°queueé“¾è¡¨æœ€åä¸€ä¸ªä½ç½®ä¸Š</span></span><br><span class="line">          queue.lastEffect.nextEffect = update;</span><br><span class="line">          queue.lastEffect = update;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Continue to the next update.</span></span><br><span class="line">    update = update.next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿­ä»£listæ¨¡æ‹Ÿäº‹ä»¶æ•è· è¿™é‡Œä¸ç®¡å®ƒåªçœ‹æ­£å¸¸å¼€å‘ç”¨åˆ°çš„å†’æ³¡</span></span><br><span class="line">  <span class="comment">// ä»£ç ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰è·³è¿‡çš„update è¿™é‡Œä¼šè¿›å…¥åˆ†æ”¯å¤„ç†queue.lastUpdateå€¼</span></span><br><span class="line">  <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span>) &#123; </span><br><span class="line">    queue.lastUpdate = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">    queue.lastCapturedUpdate = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress.effectTag |= Callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span> &amp;&amp; newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We processed every update, without skipping. That means the new base</span></span><br><span class="line">    <span class="comment">// state is the same as the result state.</span></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¤„ç†äº†æ¯æ¬¡æ›´æ–°ï¼Œæ²¡æœ‰è·³è¿‡ã€‚è¿™æ„å‘³ç€æ–°çš„åŸºæœ¬çŠ¶æ€ä¸ç»“æœçŠ¶æ€ç›¸åŒã€‚</span></span><br><span class="line">    newBaseState = resultState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  queue.baseState = newBaseState;</span><br><span class="line">  queue.firstUpdate = newFirstUpdate;</span><br><span class="line">  queue.firstCapturedUpdate = newFirstCapturedUpdate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span></span><br><span class="line">  <span class="comment">// This should be fine because the only two other things that contribute to</span></span><br><span class="line">  <span class="comment">// expiration time are props and context. We&#x27;re already in the middle of the</span></span><br><span class="line">  <span class="comment">// begin phase by the time we start processing the queue, so we&#x27;ve already</span></span><br><span class="line">  <span class="comment">// dealt with the props. Context in components that specify</span></span><br><span class="line">  <span class="comment">// shouldComponentUpdate is tricky; but we&#x27;ll have to account for</span></span><br><span class="line">  <span class="comment">// that regardless.</span></span><br><span class="line">  workInProgress.expirationTime = newExpirationTime;</span><br><span class="line">  workInProgress.memoizedState = resultState;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a>reconcileChildren</h4><p>å…³è”è°ƒç”¨(reconcileChildren)ï¼Œè¿™å‡½æ•°åè®©æˆ‘æƒ³èµ·äº†v15ç‰ˆæœ¬çš„æ ‘ç»“æ„çš„é€’å½’mount childrenèŠ‚ç‚¹ã€‚ç„¶è€Œè¿™é‡Œæˆ‘ä»¬ä¸æ˜¯ç”±å®ƒåšé€’å½’ï¼Œé€’å½’æ˜¯ç”±workLoopåšçš„ã€‚å®ƒçœŸçš„å°±æ˜¯åªå¤„ç†çˆ¶å­ä¸¤ä¸ªèŠ‚ç‚¹çš„äº‹æƒ…ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span><br><span class="line">    <span class="comment">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">    <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">    <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ä¸€ä¸ªæ–°é²œçš„æ²¡æœ‰æ¸²æŸ“è¿‡çš„ç»„ä»¶ æˆ‘ä»¬ä¸ä¼šé€šè¿‡æœ€å°side-effectsæ›´æ–°å®ƒçš„child</span></span><br><span class="line">    <span class="comment">// ç›¸å æˆ‘ä»¬ä¼šåœ¨æ¸²æŸ“ä¹‹å‰å°†å®ƒä»¬å…¨éƒ¨æ·»åŠ åˆ°å­èŠ‚ç‚¹ </span></span><br><span class="line">    <span class="comment">// è¿™æ„å‘³ç€ä¸éœ€è¦å¯¹side-effectsè¿›è¡Œè·Ÿè¸ª ä»¥ä¼˜åŒ–è¿™ä¸ªreconciliationè¿‡ç¨‹</span></span><br><span class="line">    workInProgress.child = mountChildFibers( <span class="comment">// -&gt; ChildReconciler(false)</span></span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress.child = reconcileChildFibers( <span class="comment">// -&gt; ChildReconciler(true)</span></span><br><span class="line">      workInProgress,</span><br><span class="line">      current.child, <span class="xml">&lt;-- æ›´æ–°å›ä¼ å…¥child ä»¥è·Ÿè¸ªside-effects</span></span><br><span class="line"><span class="xml">      nextChildren,</span></span><br><span class="line"><span class="xml">      renderExpirationTime,</span></span><br><span class="line"><span class="xml">    );</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ChildReconcileræ˜¯ä¸ªå·¨æŠ˜è…¾çš„å‡½æ•°ã€‚v16å¥½åƒå°±çªç„¶ä¸€ä¸‹ä»åŸºäºclassçš„ç¼–ç¨‹è½¬æ¢æˆäº†åŸºäºfunctionçš„ç¼–ç¨‹åå¥½ã€‚å¦‚æœè¯´beginWorkæ˜¯åœ¨rootå¤„å¤„ç†äº†Nç§ä¸åŒæ‰“FiberèŠ‚ç‚¹ï¼Œé‚£ä¹ˆChildReconcilerå°±æ˜¯åœ¨childå¤„å¤„ç†äº†è¿™äº›èŠ‚ç‚¹ã€‚å¥½åœ¨è¿™é‡Œéµå¾ªå¸¸è§„çº¿è·¯ï¼Œåˆå§‹renderä¹Ÿä¸éœ€è¦å¤ªè¿‡äºæ·±å…¥è¿™äº›ï¼Œå¸¸è§„çš„classComponentè¿™é‡Œå›ä¸€è·¯èµ°åˆ°(å»ºè®®è·Ÿç€æ–­ç‚¹è°ƒè¯•)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> placeSingleChild(reconcileSingleElement(returnFiber, currentFirstChild, newChild, expirationTime));</span><br></pre></td></tr></table></figure>

<p>placeSingleChildè¿™ä¸ªåœ¨åˆå§‹renderé‡Œé¢æ²¡å•¥ç”¨ï¼Œæ¥åˆ°ä»€ä¹ˆè¿”å›ä»€ä¹ˆä¸åšå¤„ç†ã€‚</p>
<p>reconcileSingleElementè¿™ä¸ªå‡½æ•°æ„Ÿè§‰ç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯å®ƒæ˜¯ç»™åˆæ¬¡æ²¡æ¸²æŸ“è¿‡å¾—Fiberé“¾è¡¨æ„å»ºä¸€ä¸ªå®Œæ•´é“¾è¡¨ã€æ ‘ã€åˆ°å…³é”®ã€‚ç®€å•æä¸€ä¸‹ å¿½ç•¥æ— å…³åˆ†æ”¯ã€‚ä½†æ˜¯å¯ä»¥æƒ³è§ï¼Œè¿™ä¸ªå‡½æ•°è‚¯å®šæ˜¯ä¸€ä¸ªé€’å½’çš„è°ƒç”¨ï¼Œæ¯•ç«Ÿä»–è¦æ„å»ºä¸€æ£µæ ‘ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123; <span class="comment">// æ­¤æ—¶child === null ä¸ä¼šè¿›æ¥</span></span><br><span class="line">	<span class="comment">// ç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123; <span class="comment">// æ­¤æ—¶å¸¸è§„æƒ…å†µä¸æ»¡è¶³åˆ†æ”¯è¿›å…¥æ¡ä»¶</span></span><br><span class="line">	<span class="comment">// ç•¥</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">      element,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    created.ref = coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºè¿™ä¸ªcreateFiberFormElementç¯èŠ‚çš„æ ¸å¿ƒæ˜¯:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fiber = createFiber(fiberTag, pendingProps, key, mode);</span><br><span class="line">fiber.elementType = type;</span><br><span class="line">fiber.type = resolvedType;</span><br><span class="line">fiber.expirationTime = expirationTime;</span><br></pre></td></tr></table></figure>

<p>å¤§è‡´ç»“æœå°±æ˜¯:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...DefaultFiberVals,</span><br><span class="line">    tag: fiberTag</span><br><span class="line">    elementType: ClassComponet(),</span><br><span class="line">    pendingProps,</span><br><span class="line">    key,</span><br><span class="line">    mode,</span><br><span class="line">    elementType, </span><br><span class="line">    type,</span><br><span class="line">    expirationTime</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶typeå’ŒElementTypeæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¸è¿‡åé¢ç‰¹æ®Šçš„functionComponentç­‰æƒ…å†µè‚¯å®šä¼šæœ‰å˜åŒ–ã€‚</p>
<h4 id="åˆå§‹renderé—­ç¯"><a href="#åˆå§‹renderé—­ç¯" class="headerlink" title="åˆå§‹renderé—­ç¯"></a>åˆå§‹renderé—­ç¯</h4><p>è¿™é‡Œéœ€è¦ä¸€ä¸ªé—­ç¯åˆ†æã€‚æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªæ¨¡æ‹Ÿæ ‘çš„fiberé“¾è¡¨ï¼Œä½†æ˜¯è¿™é‡Œè¿‡äºæ·±å…¥ç»†èŠ‚ï¼Œéœ€è¦è·³å‡ºæ¥ï¼Œå®Œæˆä¸€åœºå®è§‚å±‚é¢çš„è°ƒç”¨è§‚æ‘©ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªã€æ ‘ã€ç»“æ„æ˜¯å¦‚ä½•å®Œæˆé—­ç¯çš„â€”â€”è¿™ä¸ªé—­ç¯è¿™é‡Œæ˜¯æŒ‡fiberèŠ‚ç‚¹çš„é€’å½’ç”Ÿæˆå’Œé“¾æ¥ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œè¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªç¯èŠ‚æ²¡æœ‰è®²åˆ°ï¼Œæ‰€ä»¥é—­ç¯æš‚æ—¶æ— æ³•å®Œæˆï¼Œé‚£å°±æ˜¯completeUnitOfWorkå‡½æ•°è¿˜æ²¡æœ‰è¯´å®Œã€‚</p>
<p>æ‰€ä»¥ï¼Œç¨å€™ã€‚</p>
<h3 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a>completeUnitOfWork</h3><p>è¿™ä¸ªå‡½æ•°å› ä¸ºå¤ªè¿‡äºæ·±å…¥beginWorkæ‰€ä»¥å¯¼è‡´å°è±¡ç¼ºå¤±æœ‰äº›ï¼Œæˆ‘ä»¬å›å¤´çœ‹çœ‹beginWorkä¸Šé¢æåˆ°çš„workLoopç›¸å…³çš„ä»£ç ã€‚å½“å¯ä»¥æœ‰ä¸€äº›å°è±¡ä»¥ä¾¿ç»§ç»­åˆ†æé˜…è¯»ã€‚è¿™é‡Œå…³æ³¨ç‚¹ï¼Œæ”¾åˆ°performUnitOfWorkå‡½æ•°ã€‚æˆ‘ä»¬æŠŠç›¸å…³ä¸œè¥¿åˆå¹¶æ¥çœ‹çœ‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">workInProgress: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line"></span><br><span class="line">  startWorkTimer(workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">    </span><br><span class="line">  next = beginWork(current, workInProgress, nextRenderExpirationTime);</span><br><span class="line">  workInProgress.memoizedProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    next = completeUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡å¦‚è¯´ï¼ŒperformUnitOfWorkï¼ŒbeginWorkæ˜¯å¯¹firstChildçš„éå†ï¼Œé‚£ä¹ˆ<code>completeUnitOfWork</code>åˆ™æ˜¯å¯¹nextSiblingçš„éå†ã€‚åŸæœ¬æƒ³å°†è¿™ä¸ªå‡½æ•°ä»”ç»†å‰–æä¸€ä¸‹ï¼Œä¸è¿‡è¿™é‡Œç»ˆç©¶åŠŸåŠ›å°šä¸”ä¸å¤Ÿï¼Œæœ€ç»ˆç®€åŒ–å‡ºæ¥çš„å±…ç„¶å’Œç†è®ºé‚£å—å‡ ä¹ä¸€æ ·ã€‚æ‰€ä»¥å°±åªæ‰¯ä¸€æ‰¯ä¸»è¦è„‰ç»œã€‚</p>
<p>åˆ†æpreformUnitOfWorkè¿™å—çš„è®¾è®¡ç†å¿µã€‚</p>
<p>preformUnitOfWorkå‡½æ•°çš„è®¾è®¡æ€è·¯æ˜¯: é€šè¿‡beginWorkå¯¹æ¯ä¸ªç»™å®šçš„rootèŠ‚ç‚¹è¿›è¡ŒfirstChildæ·±æŒ–ï¼Œç„¶åå®Œæˆæ“ä½œè¿”å›å¯¹åº”çš„æœ€æ·±å±‚çº§çš„firstChildï¼Œæ¥ä¸‹æ¥ä½¿ç”¨<code>completeUnitOfWork</code>å¤„ç†è¿™ä¸€å±‚çš„nextSiblingèŠ‚ç‚¹ï¼Œå¦‚æœnextSiblingå­˜åœ¨ï¼Œé€’å½’è°ƒç”¨preformUnitOfWorkå¤„ç†child(ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæœ€å¥½å‡è®¾ä¸‹é¢æ²¡æœ‰childäº†)ï¼Œå¦åˆ™è¿™ä¸€å±‚çº§å·²ç»å¤„ç†å®Œæ¯•ï¼Œè¿”å›ä¸Šä¸€çº§èŠ‚ç‚¹ã€‚</p>
<p>è¿”å›ä¸Šä¸€çº§èŠ‚ç‚¹è¿™é‡Œè¿˜æœ‰ä¸€äº›é—¨é“ï¼Œå› ä¸ºè¿™ä¸ªè¿”å›èµ°çš„completeUnitOfWorké€»è¾‘ï¼Œå®ƒè¿™é‡Œæœ‰åˆ¤æ–­è¿”å›çš„ä¸Šä¸€çº§èŠ‚ç‚¹æ˜¯å¦æœ‰nextSiblingèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å°±è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å›ç›´æ¥ç»§ç»­å¾€ä¸Šå›æº¯ç›´åˆ°æ‰¾åˆ°æœ‰nextSiblingçš„æ›´ä¸Šå±‚çº§çš„èŠ‚ç‚¹ã€‚</p>
<p>ç„¶åç»§ç»­childå¤„ç†æµç¨‹ã€‚</p>
<p>æœ€åæ ¹æ®è¿™å¥—é€»è¾‘ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šè¢«éå†åˆ°ç›´åˆ°æœ€åè¿”å›<code>nextUnitOfWork === null</code>ã€‚</p>
<h2 id="æ¸²æŸ“é—­ç¯-commité˜¶æ®µ"><a href="#æ¸²æŸ“é—­ç¯-commité˜¶æ®µ" class="headerlink" title="æ¸²æŸ“é—­ç¯(commité˜¶æ®µ)"></a>æ¸²æŸ“é—­ç¯(commité˜¶æ®µ)</h2><p>ä¸å¦¨å›åˆ°å¼€å¤´å†çœ‹çœ‹ã€ŒRenderçº¿è·¯-åˆå§‹åŒ–ã€å°ç»“çš„è°ƒç”¨æ ˆã€‚æˆ‘ä»¬é¡ºç€ä¹‹å‰æ•´ç†çš„è°ƒç”¨æ ˆçš„æœ«èŠ‚ç‚¹ï¼ŒåŠ ä¸Šåæ¥çš„æºç åˆ†æï¼Œæ¥ç»§ç»­å±•å¼€:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">workLoop () &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    nextUnitOfWork = <span class="function"><span class="title">performUnitOfWork</span>(<span class="params">nextUnitOfWork</span>)</span> &#123;</span><br><span class="line">      next = beginWork()</span><br><span class="line">        -&gt;<span class="function"><span class="title">updateHostRoot</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">          <span class="keyword">const</span> prevState = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span>;</span><br><span class="line">          nextChildren = nextState.element;</span><br><span class="line">          -&gt;reconcileChildren()</span><br><span class="line">            =&gt;workInProgress.child = <span class="function"><span class="title">mountChildFibers</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">              -&gt;ChildReconciler.reconcileChildFibers() </span><br><span class="line">              =&gt;placeSingleChild(</span><br><span class="line">                reconcileSingleElement( returnFiber, currentFirstChild, newChild, expirationTime)</span><br><span class="line">              ) </span><br><span class="line">              =&gt;reconcileSingleElement( returnFiber, currentFirstChild, newChild, expirationTime)</span><br><span class="line">              =&gt;createFiberFromElement( element, returnFiber.mode, expirationTime)</span><br><span class="line">                -&gt;createFiber() -&gt; <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode)</span><br><span class="line">              =&gt;FiberNode</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">        next = completeUnitOfWork(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">onComplete(root, rootWorkInProgress, expirationTime)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…·ä½“äº†å¾ˆå¤šã€‚ä½†æ˜¯å®è´¨ä¸Šï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰é€ƒè„±æœ€å‰é¢æåˆ°çš„éå†ç†è®ºéƒ¨åˆ†çš„ä¼ªä»£ç ã€‚</p>
<p>ç»†èŠ‚è™½ç„¶æ·±å…¥äº†ä¸€äº›ã€‚ä½†æ˜¯åè€Œæ›´å¤šç»†èŠ‚æ²¡æœ‰æ²¡æœ‰æš´éœ²å‡ºæ¥ã€‚è¿™ä¸€ç¯‡çš„å‰ç½®çš„ç†è®ºæ˜¯å¿…é¡»ç†è§£é“¾è¡¨ï¼Œä»¥åŠåŸºäºé“¾è¡¨ç†è®ºæ„å»ºçš„FiberèŠ‚ç‚¹ã€‚</p>
<p>å¦‚æœè¯´v15åŸºç¡€èŠ‚ç‚¹æ˜¯ReactNodeï¼Œé‚£ä¹ˆv16çš„åŸºç¡€èŠ‚ç‚¹å°±æ˜¯Fiberã€‚ReactNodeæœ‰childrenï¼Œchildrenä¸æ–­ä¼¸å±•å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ‘ã€‚ä½†æ˜¯v16é‡Œé¢é‡‡ç”¨äº†FiberåšåŸºç¡€ï¼Œæœ‰siblingï¼Œchildï¼Œreturnå±æ€§ï¼ŒåŸºäºè¿™äº›å±æ€§ï¼Œå®ƒå¯ä»¥ä»¥é“¾è¡¨çš„å½¢å¼å®Œæˆéå†ã€‚</p>
<p>åœ¨v15é‡Œé¢ï¼Œå¦‚æœè¦å®Œæˆä¸€ä¸ªrootæŒ‚è½½ï¼Œåªéœ€è¦æœ€å¤–å±‚compositeComponentè¿›è¡Œäº†mountåé¢å°±ä¼šé€’å½’æ‰§è¡Œmountæ‰€æœ‰çš„childrenï¼Œæœ€åæ‰§è¡Œpatchå®Œæˆvdomåˆ°domè¿‡ç¨‹ã€‚</p>
<p>ä½†æ˜¯v16è¿™é‡Œï¼Œéœ€è¦èµ°ä¸€éé“¾è¡¨çš„éå†ç†è®ºæ‰èƒ½å®Œæˆæ•´ä½“æŒ‚è½½ï¼Œæœ€åæ‰§è¡Œç±»ä¼¼çš„patchå®ç°vdom-&gt;domã€‚</p>
<p>è¿™é‡Œcommité˜¶æ®µçš„è°ƒç”¨åœ¨<code>performWorkOnRoot</code>å‡½æ•°é‡Œé¢åé¢çš„<code>renderRoot</code>åé¢çš„<code>completeRoot</code>é‡Œé¢ã€‚</p>
<p>å½“æˆ‘ä»¬å°†FiberèŠ‚ç‚¹å¤„ç†å¥½ï¼Œå°±å¯ä»¥å¼€å§‹è¿›è¡Œcommitäº†ã€‚</p>
<h3 id="completeRoot"><a href="#completeRoot" class="headerlink" title="completeRoot"></a>completeRoot</h3><p>å…³äºè¿™å—çš„è°ƒç”¨æ ˆ:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">completeRoot</span><br><span class="line">-&gt; commitRoot () &#123;</span><br><span class="line">    commitBeforeMutationLifecycles()</span><br><span class="line">    commitAllHostEffects();</span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    commitAllLifeCycles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitBeforeMutationLifecycles"><a href="#commitBeforeMutationLifecycles" class="headerlink" title="commitBeforeMutationLifecycles"></a>commitBeforeMutationLifecycles</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationLifecycles</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Snapshot) &#123;</span><br><span class="line">      recordEffect();</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      commitBeforeMutationLifeCycles(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨éå†nextEffecté“¾è¡¨è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹æ¯ä¸ªSide-Effectæ‰§è¡Œ<code>commitBeforeMutationLifeCycles</code>ã€‚è¿™ä¸ªå‡½æ•°å°±å¸¸è§„çš„ClassComponentæ¥è¯´å°±æ˜¯è°ƒç”¨<code>getSnapshotBeforeUpdate</code>å‡½æ•°ã€‚</p>
<h4 id="commitAllHostEffects"><a href="#commitAllHostEffects" class="headerlink" title="commitAllHostEffects"></a>commitAllHostEffects</h4><p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨éå†nextEffecté“¾è¡¨è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹Side-Effectæ‰§è¡Œå®ƒã€‚å®ƒä¸»è¦æ˜¯å¯¹Reactæ‰§è¡ŒDOMæ›´æ–°ã€‚å°†æ¸²æŸ“å¥½çš„DOMæ”¾åˆ°æŒ‡å®šä½ç½®å»ã€‚<strong>è¿™é‡Œå¯èƒ½æ˜¯æ•´ä¸ªpatchæ ¸å¿ƒçš„åœ°æ–¹ã€‚</strong></p>
<h4 id="commitAllLifecycles"><a href="#commitAllLifecycles" class="headerlink" title="commitAllLifecycles"></a>commitAllLifecycles</h4><p>ç”Ÿå‘½å‘¨æœŸå¤„ç†ã€‚å…³äºç”Ÿå‘½å‘¨æœŸå¤„ç†å…¶å®æŒºæ— è¶£çš„ï¼Œå‚è€ƒä¹‹å‰çš„æ–‡ç« ä¹Ÿå¯ä»¥æ˜ç™½ã€‚</p>
<p>å®ƒç¡®å®è®©APIå˜å¾—å¥½ç”¨ï¼Œä½†æ˜¯å®è´¨ä¸Šä¹Ÿç¡®å®å°±æ˜¯åœ¨ä¸åŒæ—¶æœºè¿›è¡Œäº†ä¸åŒè°ƒç”¨ã€‚ä»…æ­¤è€Œå·²ã€‚</p>
<h1 id="å…¶ä»–è¡¥å……"><a href="#å…¶ä»–è¡¥å……" class="headerlink" title="å…¶ä»–è¡¥å……"></a>å…¶ä»–è¡¥å……</h1><p>è¿™é‡Œç€é‡è¡¥å……ä¸€ä¸‹å¯èƒ½è¢«å¿½ç•¥æ‰åŸºç¡€æ€§ç»†èŠ‚ã€‚ä¸»è¦æ˜¯FiberNodeèŠ‚ç‚¹åŠå…¶ç›¸å…³ã€‚</p>
<p>FiberNode.updateQueue: æ›´æ–°é˜Ÿåˆ—é“¾è¡¨</p>
<p>FiberNode.alternate: èŠ‚ç‚¹å‰¯æœ¬ï¼Œ<strong>nextUnitOfWork</strong>ç»å¸¸ä¼šæŒ‡å‘å®ƒï¼Œä»–ä¹Ÿæ˜¯FiberNodeã€‚</p>
<p>FiberNode.memoizedState: å½“å‰èŠ‚ç‚¹å·²ç»ç”Ÿæ•ˆæ˜¾ç¤ºåˆ°UIä¸Šçš„state</p>
<p>FiberRoot.finishedWorkæ˜¯å˜åŒ–èŠ‚ç‚¹æ ‘ã€‚å¦‚æœroot.finishedWorkä¸ç­‰äºnullï¼Œé‚£ä¹ˆè¯´æ˜renderé˜¶æ®µå®Œæˆï¼Œå¯ä»¥è¿›å…¥commité˜¶æ®µã€‚</p>
<p>â˜…workInProgressä¼šç»„æˆç”±é“¾è¡¨ç»„æˆçš„ä¸€æ£µæ ‘ã€‚å¦‚æœå¯¹è¿™ä¸ªæ ‘å¦‚ä½•æ„å»ºï¼Œå¯ä»¥å¤šä»”ç»†æ£æ‘©reconcileChildren&amp;ChildReconcilerï¼Œå®ƒä¸»è¦æ˜¯é€šè¿‡<code>workInProgress.child = createFibler(args)</code>ï¼ŒcreateFiblerå¯¹åº”çš„å‰ç½®è°ƒç”¨reconcileSingleElementå‡½æ•°é‡Œé¢åšäº†returné…å¯¹ï¼Œæ¥å®ç°çˆ¶å­é“¾æ¥ã€‚è‡³äºsiblingä¹Ÿåœ¨ChildReconcileræœ‰å¤„ç†ã€‚(å½“ç„¶è¿™ä¹Ÿåªæ˜¯å…¶ä¸­ä¸€éƒ¨åˆ†é€»è¾‘åˆ†æ”¯ï¼Œæ„Ÿè§‰è¿™ä¸ªæ ‘çš„æ„å»ºå€¼å¾—å†å†™ä¸€ç¯‡ï¼Œåé¢å†çœ‹çœ‹å§)ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>è¿™ç¯‡å‚è€ƒæ–‡ç« ä¸ºä¸ªäººæä¾›äº†å¾ˆé‡è¦çš„å‚è€ƒã€‚å¦‚æœä¸ªäººè¿™ç¯‡æ–‡ç« çœ‹ä¸å¤ªæ‡‚å»ºè®®çœ‹çœ‹å¤§ä½¬çš„ã€‚å°†æˆ‘è¿™ç¯‡ä½œä¸ºè¡¥å……ä¹Ÿæœªå°ä¸å¯ã€‚</p>
<p>[<a href="https://link.zhihu.com/?target=https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react/" rel="tag"># react</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/07/15/react-Fiber/" rel="prev" title="v16çš„å¼€å§‹ || react-Fiber">
      <i class="fa fa-chevron-left"></i> v16çš„å¼€å§‹ || react-Fiber
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/08/07/react-v16-Update-commitPhase/" rel="next" title="react-v16-Update-commitPhase">
      react-v16-Update-commitPhase <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%A4%B4"><span class="nav-number">1.</span> <span class="nav-text">å¼€å¤´</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Render%E7%BA%BF%E8%B7%AF-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">Renderçº¿è·¯-åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E7%90%86%E8%AE%BA"><span class="nav-number">2.1.</span> <span class="nav-text">éå†ç†è®º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E7%BB%86%E8%8A%82-render%E9%98%B6%E6%AE%B5"><span class="nav-number">2.2.</span> <span class="nav-text">æºç ç»†èŠ‚(renderé˜¶æ®µ)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#workLoop%E5%8F%8A%E5%89%8D%E7%BD%AE%E8%B0%83%E7%94%A8"><span class="nav-number">2.2.1.</span> <span class="nav-text">workLoopåŠå‰ç½®è°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performUnitOfWork"><span class="nav-number">2.2.2.</span> <span class="nav-text">performUnitOfWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beginWork"><span class="nav-number">2.2.3.</span> <span class="nav-text">beginWork</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#reconcileChildren"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">reconcileChildren</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8Brender%E9%97%AD%E7%8E%AF"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">åˆå§‹renderé—­ç¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#completeUnitOfWork"><span class="nav-number">2.2.4.</span> <span class="nav-text">completeUnitOfWork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E9%97%AD%E7%8E%AF-commit%E9%98%B6%E6%AE%B5"><span class="nav-number">2.3.</span> <span class="nav-text">æ¸²æŸ“é—­ç¯(commité˜¶æ®µ)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#completeRoot"><span class="nav-number">2.3.1.</span> <span class="nav-text">completeRoot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#commitBeforeMutationLifecycles"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">commitBeforeMutationLifecycles</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commitAllHostEffects"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">commitAllHostEffects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commitAllLifecycles"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">commitAllLifecycles</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%A1%A5%E5%85%85"><span class="nav-number">3.</span> <span class="nav-text">å…¶ä»–è¡¥å……</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">que01</p>
  <div class="site-description" itemprop="description">è‡ªå·±çš„å­¦ä¹ è®°å½•</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">que01</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"TXWIywcTsrMfVKtclog3CxDl-gzGzoHsz","app_key":"987dqIR4vvX2mQJjmAV86Qp0","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
