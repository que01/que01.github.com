<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Microsoft YaHei, Verdana, sans-serif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.que01.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"AL4M83H31B","apiKey":"d30226bc78f2b15b834d9fc9993e3c42","indexName":"hexo","hits":{"per_page":10}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"bounceDownIn","post_body":"bounceDownIn","coll_header":"slideLeftIn","sidebar":"fadeInUp"}},"path":"search.xml"};
  </script>

  <meta name="description" content="å‰é¢å‡ ç¯‡é‡ç‚¹åˆ†æäº†Render &amp; Update, ä¹ƒè‡³Fiberé“¾çš„æ„å»ºç»†èŠ‚ã€‚è¿™é‡Œå°±æœ‰ä½™åœ°å»åˆ†æV16çš„Diffç®—æ³•æ˜¯å¦‚ä½•å®ç°äº†ã€‚æ ¹æ®ä¹‹å‰çš„Updateä¸¤ç¯‡åˆ†æï¼Œå¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“è¿™ä¸ªDiffé›†ä¸­åœ¨äº†render phase, è€Œéšåçš„commit phaseå®é™…ä¸Šå°±æ˜¯patchè¿™ä¸ªdiffçš„è¿‡ç¨‹ã€‚å› ä¸ºDiffå®é™…ä¸Šæ˜¯ç”±Reconcileræ¥å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸæŠŠå®ƒæ•´ç†ä¸€ä¸‹ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="react-v16-Reconcilerå’ŒDiffç®—æ³•">
<meta property="og:url" content="http://www.que01.top/2019/08/14/react-v16-Reconciler-Diff/index.html">
<meta property="og:site_name" content="Que&#39;s Blog">
<meta property="og:description" content="å‰é¢å‡ ç¯‡é‡ç‚¹åˆ†æäº†Render &amp; Update, ä¹ƒè‡³Fiberé“¾çš„æ„å»ºç»†èŠ‚ã€‚è¿™é‡Œå°±æœ‰ä½™åœ°å»åˆ†æV16çš„Diffç®—æ³•æ˜¯å¦‚ä½•å®ç°äº†ã€‚æ ¹æ®ä¹‹å‰çš„Updateä¸¤ç¯‡åˆ†æï¼Œå¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“è¿™ä¸ªDiffé›†ä¸­åœ¨äº†render phase, è€Œéšåçš„commit phaseå®é™…ä¸Šå°±æ˜¯patchè¿™ä¸ªdiffçš„è¿‡ç¨‹ã€‚å› ä¸ºDiffå®é™…ä¸Šæ˜¯ç”±Reconcileræ¥å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸæŠŠå®ƒæ•´ç†ä¸€ä¸‹ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-08-14T03:05:28.000Z">
<meta property="article:modified_time" content="2020-12-17T13:21:55.685Z">
<meta property="article:author" content="que01">
<meta property="article:tag" content="React v16">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.que01.top/2019/08/14/react-v16-Reconciler-Diff/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react-v16-Reconcilerå’ŒDiffç®—æ³• | Que's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Que's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WebFrontEnd Development</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.que01.top/2019/08/14/react-v16-Reconciler-Diff/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="que01">
      <meta itemprop="description" content="è‡ªå·±çš„å­¦ä¹ è®°å½•">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Que's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react-v16-Reconcilerå’ŒDiffç®—æ³•
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-08-14 11:05:28" itemprop="dateCreated datePublished" datetime="2019-08-14T11:05:28+08:00">2019-08-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-17 21:21:55" itemprop="dateModified" datetime="2020-12-17T21:21:55+08:00">2020-12-17</time>
              </span>

          
            <span id="/2019/08/14/react-v16-Reconciler-Diff/" class="post-meta-item leancloud_visitors" data-flag-title="react-v16-Reconcilerå’ŒDiffç®—æ³•" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <div class="post-description">å‰é¢å‡ ç¯‡é‡ç‚¹åˆ†æäº†Render & Update, ä¹ƒè‡³Fiberé“¾çš„æ„å»ºç»†èŠ‚ã€‚è¿™é‡Œå°±æœ‰ä½™åœ°å»åˆ†æV16çš„Diffç®—æ³•æ˜¯å¦‚ä½•å®ç°äº†ã€‚æ ¹æ®ä¹‹å‰çš„Updateä¸¤ç¯‡åˆ†æï¼Œå¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“è¿™ä¸ªDiffé›†ä¸­åœ¨äº†render phase, è€Œéšåçš„commit phaseå®é™…ä¸Šå°±æ˜¯patchè¿™ä¸ªdiffçš„è¿‡ç¨‹ã€‚å› ä¸ºDiffå®é™…ä¸Šæ˜¯ç”±Reconcileræ¥å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸæŠŠå®ƒæ•´ç†ä¸€ä¸‹ã€‚</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰é¢å‡ ç¯‡é‡ç‚¹åˆ†æäº†Render &amp; Update, ä¹ƒè‡³Fiberé“¾çš„æ„å»ºç»†èŠ‚ã€‚è¿™é‡Œå°±æœ‰ä½™åœ°å»åˆ†æV16çš„Diffç®—æ³•æ˜¯å¦‚ä½•å®ç°äº†ã€‚æ ¹æ®ä¹‹å‰çš„Updateä¸¤ç¯‡åˆ†æï¼Œå¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“è¿™ä¸ªDiffé›†ä¸­åœ¨äº†render phase, è€Œéšåçš„commit phaseå®é™…ä¸Šå°±æ˜¯patchè¿™ä¸ªDiffçš„è¿‡ç¨‹ã€‚</p>
<p>å›é¡¾ä¹‹å‰v15çš„diffç®—æ³•ï¼Œå› ä¸ºå…¶Treeç»“æ„çš„ç¼˜æ•…ï¼Œä¸€æ—¦ç†è§£äº†ä¹‹åï¼Œå¯¹å…¶Component Diffã€Tree Diffã€Element Diffç®—æ˜¯å°è±¡æ·±åˆ»ã€‚è¿™é‡Œéœ€è¦å¾ªç€å®ƒçš„æ€è·¯ï¼Œå‚è€ƒæ›´æ–°çš„render phaseæ¥æ·±å…¥ç†è§£è¿™ä¸ªDiffæœ‰ä»€ä¹ˆå˜åŒ–ã€‚</p>
<p>ä½†æ˜¯ä¹‹å‰çš„ä¾‹å­ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä¸ºäº†Diffåˆ†æçš„å…¨é¢ï¼Œä¹Ÿä¸èƒ½ç®€å•ç›´æ¥å¾ªç€å®ƒçš„æ€è·¯ï¼Œæ€»ä¹‹è¿™æ˜¯ä¸€ä¸ªå…¥ä¹å…¶å†…ï¼Œåˆå‡ºå…¶å¤–çš„è¿‡ç¨‹ã€‚ç›¸åº”çš„ï¼Œ<strong>è¿™ç¯‡ä¸»è¦æ˜¯å…³æ³¨Diffæµç¨‹</strong>ï¼Œå¯¹Updateçš„åˆ†æï¼Œä¸€åˆ‡ä»¥å®ƒä¸ºç›®æ ‡ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œæ¯ä¸ªå‡½æ•°çš„åˆ†æï¼Œéƒ½è¦å’ŒDiffæœ‰è”ç³»ï¼Œä½†æ˜¯åˆè¦åœ¨ä¹‹å‰Updateç¯‡ä¸Šæœ‰è¿›ä¸€æ­¥çš„æ·±åº¦ã€‚</p>
<h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>è¿™é‡Œè¿˜æ˜¯é¡ºç€å‰æ–‡çš„Eventè°ƒç”¨æ ˆæ¥è¯´ã€‚ä»¥ä¸‹æ˜¯è§¦å‘äº‹ä»¶è¿‡ç¨‹ä¸­çš„è°ƒç”¨æ ˆ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dispatchInteractiveEvent</span><br><span class="line">-&gt;interactiveUpdates</span><br><span class="line">--&gt;dispatchEvent</span><br><span class="line">---&gt;performSyncWork</span><br><span class="line">----&gt;performWork</span><br><span class="line">-----&gt;performWorkOnRoot -&gt; renderRoot &amp; completeRoot</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹performWorkåšç‚¹æ‰©å±•</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">performWork () &#123;</span><br><span class="line">    findHighestPriorityRoot()</span><br><span class="line">    performWorkOnRoot -&gt; renderRoot &amp; completeRoot</span><br><span class="line">    findHighestPriorityRoot()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="findHighestPriorityRoot"><a href="#findHighestPriorityRoot" class="headerlink" title="findHighestPriorityRoot"></a>findHighestPriorityRoot</h2><p>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¸€ä¸ªæ˜¯æ— æ•ˆèŠ‚ç‚¹ä»é“¾è¡¨ç§»é™¤ï¼Œå†ä¸€ä¸ªæ˜¯è¿”å›æœ€ç»ˆä¼˜å…ˆèŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>Tips: è¿™ä¸€å°èŠ‚åœ¨ReactDomç¯å¢ƒä¸‹ï¼Œå…¶å®ååºŸè¯ï¼Œä¸æ„¿æ„çœ‹å¯ä»¥ç›´æ¥æ‹‰åˆ°å°ç»“ã€‚</p>
</blockquote>
<h3 id="æ— æ•ˆèŠ‚ç‚¹æ¸…é™¤"><a href="#æ— æ•ˆèŠ‚ç‚¹æ¸…é™¤" class="headerlink" title="æ— æ•ˆèŠ‚ç‚¹æ¸…é™¤"></a>æ— æ•ˆèŠ‚ç‚¹æ¸…é™¤</h3><p>è¿™ä¸ªfindHighestPriorityRootå‡½æ•°éœ€è¦æ¯”ç…§ä¹‹å‰çš„Update-RenderPhaseæ¥çœ‹ã€‚å› ä¸ºå®ƒè¿™é‡Œæ¶‰åŠäº†firstScheduledRootã€lastScheduledRootã€root.nextScheduledRootçš„èµ‹å€¼ã€‚æ‰€ä»¥ç®€è¿°ä¸€ä¸‹å®ƒå†…éƒ¨é€»è¾‘ã€‚ä½†æ˜¯è¿™ä¹‹å‰å¿…é¡»å…ˆçœ‹çœ‹å¦å¤–ä¸€ä¸ªå‡½æ•°addRootToSchedule:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRootToSchedule</span>(<span class="params">root: FiberRoot, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ£€æŸ¥è¿™ä¸ªfiberèŠ‚ç‚¹æ˜¯å¦å·²ç»æ˜¯scheduleçš„ä¸€éƒ¨åˆ†: </span></span><br><span class="line">  <span class="keyword">if</span> (root.nextScheduledRoot === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// root.nextScheduledRoot === null è¯´æ˜è¿˜æ²¡æœ‰åŠ å…¥ è¿™é‡ŒåŠ å…¥å®ƒ</span></span><br><span class="line">    root.expirationTime = expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (lastScheduledRoot === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// lastScheduledRootä¸ºç©º å°†è¿™ä¸ªfiberè®¾ä¸º[first|last]ScheduledRoot</span></span><br><span class="line">      <span class="comment">// root.nextScheduledRootä¹Ÿè®¾ä¸ºè‡ªèº« è¿™åªåœ¨ä»…æœ‰ä¸€ä¸ªæ›´æ–°fiberå‘ç”Ÿ</span></span><br><span class="line">      firstScheduledRoot = lastScheduledRoot = root;</span><br><span class="line">      root.nextScheduledRoot = root;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦åˆ™ å°†lastScheduledRootä¸‹ä¸€ä¸ªé“¾è¡¨è®¾ä¸ºè¿™ä¸ªroot ç„¶åå°†rootè®¾ä¸ºæœ€åä¸€ä¸ª(å®è´¨æ˜¯æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°é“¾è¡¨å°¾éƒ¨)</span></span><br><span class="line">      <span class="comment">// å¹¶å°†è¿™ä¸ªrootçš„nextScheduledRootè®¾ç½®åˆ°firstScheduledRoot</span></span><br><span class="line">      lastScheduledRoot.nextScheduledRoot = root;</span><br><span class="line">      lastScheduledRoot = root;</span><br><span class="line">      lastScheduledRoot.nextScheduledRoot = firstScheduledRoot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªrootå·²ç»åœ¨scheduleé‡Œé¢ ä½†æ˜¯å¯èƒ½æœ‰å±æ€§å˜åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> remainingExpirationTime = root.expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (expirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">      <span class="comment">// æ›´æ–°æ—¶é—´ ä»¥ä¾¿åé¢å®ƒèƒ½è¢«æ›´æ–°</span></span><br><span class="line">      root.expirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ä¸‹é¢çš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findHighestPriorityRoot</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> highestPriorityWork = NoWork;</span><br><span class="line">  <span class="keyword">let</span> highestPriorityRoot = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// è¿™è¯´æ˜ä¹‹å‰è‡³å°‘å·²ç»æœ‰ä¸ªæ›´æ–°äº† æ‰€ä»¥è‡³å°‘æœ‰ä¸€ä¸ªéœ€è¦æ“ä½œçš„fiberèŠ‚ç‚¹</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œé…åˆaddRootToScheduleå‡½æ•°è¦å»ç†è§£</span></span><br><span class="line">  <span class="keyword">if</span> (lastScheduledRoot !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> previousScheduledRoot = lastScheduledRoot;</span><br><span class="line">    <span class="keyword">let</span> root = firstScheduledRoot;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ å®ƒä¼šéå†æ‰€æœ‰root.nextScheduledRoot</span></span><br><span class="line">    <span class="comment">// ç›´åˆ°nextFlushedRoot &amp; nextFlushedExpirationTimeå¾—åˆ°åˆç†èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">while</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> remainingExpirationTime = root.expirationTime;</span><br><span class="line">      <span class="keyword">if</span> (remainingExpirationTime === NoWork) &#123;</span><br><span class="line">        <span class="comment">// è¿›å…¥è¿™ä¸ªåˆ†æ”¯ è¯´æ˜è¿™ä¸ªfiberèŠ‚ç‚¹æ²¡æœ‰äº‹æƒ…è¦åšäº† å°†å…¶ä»scheduleré‡Œé¢ç§»é™¤</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œé…åˆaddRootToScheduleå‡½æ•°è¦å»ç†è§£</span></span><br><span class="line">        <span class="keyword">if</span> (root === root.nextScheduledRoot) &#123;</span><br><span class="line">          <span class="comment">// åˆ¤æ–­æ˜¯å¦ä»…æœ‰çš„ ç¬¬ä¸€ä¸ª åˆå§‹ æ›´æ–° ç„¶åè·³å‡ºwhile</span></span><br><span class="line">          <span class="comment">// å› ä¸ºåªæœ‰ä¸€ä¸ªæ›´æ–°å°±ä¸éœ€è¦è€ƒè™‘åé¢è¿˜æœ‰æ›´é«˜ä¼˜å…ˆçº§ è¿™ä¸ªfiberNodeæœ¬èº«å°±æ˜¯</span></span><br><span class="line">          <span class="comment">// å› ä¸ºæ­¤æ—¶æ˜¯è¦ç§»é™¤ æ‰€ä»¥ä»…ä»…å°†å…¶èµ‹å€¼nullå°±å®Œäº‹äº† å¯ä»¥breakäº†</span></span><br><span class="line">          root.nextScheduledRoot = <span class="literal">null</span>;</span><br><span class="line">          firstScheduledRoot = lastScheduledRoot = <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root === firstScheduledRoot) &#123;</span><br><span class="line">          <span class="comment">// å°†ç¬¬ä¸€ä¸ªå…ƒç´ ä»é“¾è¡¨é¡¶éƒ¨ç§»é™¤ å¹¶è®¾å®šroot.nextScheduledRoot = null</span></span><br><span class="line">          <span class="comment">// è¿™ä¸ªæ“ä½œä¼šå› ä¸ºwhileç»§ç»­å¾ªç¯ ç›´åˆ° lastScheduledRoot.nextScheduledRoot!== null</span></span><br><span class="line">          <span class="keyword">const</span> next = root.nextScheduledRoot;</span><br><span class="line">          firstScheduledRoot = next;</span><br><span class="line">          lastScheduledRoot.nextScheduledRoot = next;</span><br><span class="line">          root.nextScheduledRoot = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root === lastScheduledRoot) &#123;</span><br><span class="line">          <span class="comment">// æ­¤æ—¶éå†åˆ°å°¾éƒ¨äº† è€Œä¸”å¹¶éå”¯ä¸€èŠ‚ç‚¹(å› ä¸ºæ²¡æœ‰è¿›å…¥ç¬¬ä¸€ä¸ªåˆ†æ”¯) æ­¤æ—¶æ˜¯è¿™é‡Œæœ€åä¸€æ¬¡è¿›while</span></span><br><span class="line">          <span class="comment">// å°†lastScheduledRoot.nextScheduledRooté‡ç½®ä¸ºfirstScheduledRootå®Œæˆåœ†å½¢é—­ç¯</span></span><br><span class="line">          lastScheduledRoot = previousScheduledRoot;</span><br><span class="line">          lastScheduledRoot.nextScheduledRoot = firstScheduledRoot;</span><br><span class="line">          root.nextScheduledRoot = <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// è¿™æ˜¯é“¾è¡¨ä¸­é—´èŠ‚ç‚¹çš„æ“ä½œ ä»é“¾è¡¨ä¸­ç§»é™¤ä¸€ä¸ªä¸­é—´èŠ‚ç‚¹ </span></span><br><span class="line">          <span class="comment">// æ­¤æ—¶ç»™previousScheduledRoot.nextèµ‹å€¼root.next,å®è´¨ä¸Šæ˜¯åœ¨ä¸ºwhileé‡Œé¢</span></span><br><span class="line">          <span class="comment">// çš„rootèµ‹å€¼(root = previousScheduledRoot.nextScheduledRoot)</span></span><br><span class="line">          previousScheduledRoot.nextScheduledRoot = root.nextScheduledRoot;</span><br><span class="line">          root.nextScheduledRoot = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        root = previousScheduledRoot.nextScheduledRoot;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (remainingExpirationTime &gt; highestPriorityWork) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœexpirationTimeå¤§äºä¹‹å‰ç¼“å­˜çš„æœ€å¤§å€¼ æŠŠè¿™ä¸ªrootç›¸å…³æ•°æ®è®¾ä¸ºæœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">          highestPriorityWork = remainingExpirationTime;</span><br><span class="line">          highestPriorityRoot = root;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root === lastScheduledRoot) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (highestPriorityWork === Sync) &#123;</span><br><span class="line">          <span class="comment">// Sync is highest priority by definition so</span></span><br><span class="line">          <span class="comment">// we can stop searching.</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        previousScheduledRoot = root;</span><br><span class="line">        root = root.nextScheduledRoot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  nextFlushedRoot = highestPriorityRoot;</span><br><span class="line">  nextFlushedExpirationTime = highestPriorityWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>findHighestPriorityRootå…¶ä¸­ä¸€ä¸ªä½œç”¨å°±æ˜¯æ¸…é™¤æ‰€æœ‰<code>fibler.expirationTime === NoWork</code>çš„èŠ‚ç‚¹ã€‚æ ¹æ®addRootToScheduleå®šä¹‰ ä»”ç»†ä½“å‘³ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªé“¾è¡¨æ˜¯åœ†ç¯ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ç›¸å¯¹ç²¾å½©çš„é“¾è¡¨æ¸…ç©ºç¯èŠ‚ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯æ¥ä¸¾ä¾‹é…åˆä»£ç æ³¨é‡Šæ¥ç†è§£ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---+      +---+      +---+</span><br><span class="line">| A +-----&gt;+ B +-----&gt;+ C |</span><br><span class="line">+-+-+      +---+      +-+-+</span><br><span class="line">  ^                     |</span><br><span class="line">  |                     v</span><br><span class="line">+-+-+      +---+      +-+-+</span><br><span class="line">| F +&lt;-----+ E +&lt;---+ | D |</span><br><span class="line">+---+      +---+      +---+</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒAä¸ºfirstï¼ŒFä¸ºlastã€‚ç„¶åçœ‹çœ‹<code>remainingExpirationTime === NoWork</code>é‡Œé¢çš„åˆ†æ”¯ã€‚</p>
<ul>
<li><p>åªæœ‰rootä¸ºlastæ‰ä¼šbreakè·³å‡ºï¼Œå…¶ä»–çš„ä¸ä¼š</p>
</li>
<li><p>å½“rootä¸ºA(æ­¤æ—¶Aä¸ºfirst)ï¼Œä¸”<code>A.expirationTime === NoWork</code>ã€‚æ­¤æ—¶ï¼š</p>
<ul>
<li><code>first = A.next = B</code></li>
<li><code>last.next = B</code></li>
<li><code>A.next = null</code></li>
</ul>
</li>
<li><p>å½“rootä¸ºä¸­é—´èŠ‚ç‚¹æ—¶å€™ï¼Œ æ¯”å¦‚ä¸º<code>B.expirationTime === NoWork</code>ã€‚æ­¤æ—¶:</p>
<ul>
<li><code>previousScheduledRoot = F.next === A</code> ä½†æ˜¯FèŠ‚ç‚¹è¿˜æ˜¯FèŠ‚ç‚¹(<strong>è¿™ä¸ªéœ€è¦é‡ç‚¹ç†è§£</strong>)</li>
<li>previousScheduledRoot(A.next) = B.next = C</li>
<li>ä¸Šé¢ä¸¤æ­¥å®è´¨ä¸Šå°±æ˜¯å°†Bä»é“¾è¡¨ä¸Šä¸¢æ‰äº†ï¼Œé“¾æ¥äº†ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé“¾è¡¨å…ƒç´ </li>
<li>B.next èµ‹å€¼ä¸ºnull</li>
</ul>
</li>
<li><p>å½“éå†åˆ°æœ€ç»ˆçš„lastä¹Ÿå°±æ˜¯FèŠ‚ç‚¹ï¼Œä¸”ä¸ºæ— æ•ˆèŠ‚ç‚¹æ—¶å€™ã€‚æ­¤æ—¶:</p>
<ul>
<li>å°†lastèµ‹å€¼ä¸ºE(previousScheduledRoot)</li>
<li>å°†E.nexté‡æ–°èµ‹å€¼first å®Œæˆåœ†å½¢é—­ç¯ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>è¿™ä¸€æ­¥å…¶å®å…¶å®å°±æ˜¯é“¾è¡¨å…ƒç´ çš„çš„ç§»é™¤æ“ä½œã€‚æŒæ¡è¿™ä¸ªæ•°æ®ç»“æ„è¿˜æ˜¯å¾ˆé‡è¦ã€‚ä½†æ˜¯å…¶å®å½’æ ¹ç»“åº•è¿˜æ˜¯é€†å‘è§£è¯»ç›¸å¯¹æŠ˜è…¾ï¼Œè‡ªå·±å†™å¤§å®¶åº”è¯¥éƒ½èƒ½å†™å‡ºæ¥ï¼Œç„¶è€Œä¸€æ—¦å¤æ‚èµ·æ¥ï¼Œè¿‡å‡ ä¸ªæœˆä¼°è®¡å°±åªæœ‰ä¸Šå¸ç›´åˆ°å†™çš„ä»€ä¹ˆäº†ğŸ˜‚</p>
</blockquote>
<blockquote>
<p>è¿™é‡Œè¦æ³¨æ„addRootToScheduleä¸Šæ¸¸è°ƒç”¨å‡½æ•°scheduleWorkä¼šç»™ä»–ä¼ å…¥fiberRootå‚æ•°ã€‚æ‰€ä»¥nextFlushedRootå…¶å®ä¸€èˆ¬å°±æ˜¯fiberRoot(ä¸€äº›æƒ…å†µä¸‹æ˜¯null)ã€‚</p>
</blockquote>
<h3 id="è¿”å›ä¼˜å…ˆèŠ‚ç‚¹"><a href="#è¿”å›ä¼˜å…ˆèŠ‚ç‚¹" class="headerlink" title="è¿”å›ä¼˜å…ˆèŠ‚ç‚¹"></a>è¿”å›ä¼˜å…ˆèŠ‚ç‚¹</h3><p>ç›¸æ¯”ä¸Šé¢å¤æ‚åº¦é“¾è¡¨ç§»é™¤æ“ä½œã€‚è¿™ä¸ªè¿”å›æ“ä½œå°±æ ¼å¤–ç®€å•ã€‚å°±æ˜¯æ‰¾å‡ºexpirationTimeæœ€å¤§çš„fiberèŠ‚ç‚¹ã€‚ç„¶åè¿”å›ï¼Œå¦‚æœé‡åˆ°expirationTime === Syncçš„åœæ­¢ç»§ç»­æ¯”è¾ƒç›´æ¥è¿”å›ä¹‹å‰è®¡ç®—ç»“æœã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>è¿™ä¸ªå‡½æ•°åœ¨Scheduledåˆ—è¡¨ä¸Šæ¸…æ‰äº†æ— æ•ˆèŠ‚ç‚¹ï¼Œå…³è”çš„æ ¸å¿ƒæ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„nextScheduledRootå±æ€§ã€‚é€šè¿‡å®ƒå¯ä»¥å¿«é€Ÿå¯¹å¤šä¸ªFiberRootè¿›è¡Œè°ƒåº¦ï¼Œå®ƒå°†ä¼˜å…ˆçº§æœ€é«˜çš„FiberRootè®¾ä¸ºnextFlushedRootã€‚</p>
<p>è¿™ä¸ªnextFlushedRootï¼Œå°†ä¼šåœ¨ä¸‹ä¸€æ­¥ä¸­è¢«ä½¿ç”¨ã€‚</p>
<p>å…³äºFiberRootè¿™ç‚¹ï¼Œä»£ç é‡Œé¢å¯¹ç±»å‹æœ‰å¾ˆæ˜æ˜¾çš„ç±»å‹é™å®šã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Linked-list of roots</span></span><br><span class="line"><span class="keyword">let</span> firstScheduledRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> lastScheduledRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> nextFlushedRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¾ˆå®¹æ˜“æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœéƒ½æ˜¯FiberRootä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªé“¾è¡¨(ReactDOMä»…æœ‰å”¯ä¸€ä¸€ä¸ªFiberRoot)ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºReactä¸ä»…ä»…æœåŠ¡äºReactDOMï¼Œå®ƒè¿˜ä¼šæœåŠ¡äºReactNativeã€‚åœ¨ReactNativeä¸­å®ƒå¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„root scheduler, è¿™å’ŒReactDomä»…ä»…ä½¿ç”¨ä¸€ä¸ªroot scheduleræœ‰æ‰€ä¸åŒã€‚</p>
<p>è¿™å®è´¨ä¸Šæ˜¯renderer(æ¸²æŸ“å™¨)å’Œ scheduler(è°ƒåº¦å™¨)çš„åˆ†ç¦»ã€‚ä¸è¿‡è¿™ä¸ªæ˜¾ç„¶è¶…å‡ºæœ¬ç¯‡çš„èŒƒå›´äº†ï¼Œè¿™é‡Œä¸åšæ·±å…¥äº†ã€‚</p>
<p>å”¯ä¸€å¯ä»¥è¯´çš„ï¼Œæ˜¯è¿™ä¸€å°èŠ‚åœ¨ReactDomé‡Œé¢å¯èƒ½å…¶å®éƒ½æ˜¯åºŸè¯ï¼Œå®ƒè¿™é‡Œåšçš„å°±æ˜¯è®¾nextFlushedRootä¸ºFiberRootè€Œå·²ã€‚</p>
<h2 id="performWork"><a href="#performWork" class="headerlink" title="performWork"></a>performWork</h2><p>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬æš‚æ—¶å…³æ³¨åœ¨å®ƒåŒæ­¥çš„é€»è¾‘åˆ†æ”¯é‡Œé¢ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">minExpirationTime: ExpirationTime, isYieldy: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç¡®ä¿nextFlushedRootæ˜¯scheduledé“¾è¡¨ä¸­çš„æœ€é«˜ä¼˜å…ˆçº§fiberNode</span></span><br><span class="line">  findHighestPriorityRoot();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isYieldy) &#123;</span><br><span class="line">	<span class="comment">// å¼‚æ­¥é€»è¾‘æš‚æ—¶ä¸ç®¡</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      nextFlushedRoot !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      nextFlushedExpirationTime !== NoWork &amp;&amp;</span><br><span class="line">      minExpirationTime &lt;= nextFlushedExpirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      performWorkOnRoot(nextFlushedRoot, nextFlushedExpirationTime, <span class="literal">false</span>);</span><br><span class="line">      findHighestPriorityRoot();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>é…åˆä¸Šæ–‡å¯¹findHighestPriorityRootçš„ç†è§£åŠ ä¸Šä¹‹å‰æ–‡ç« å¯¹performWorkOnRootçš„åˆ†æã€‚ç«‹åˆ»å°±å¯ä»¥å‘ç°å¾ˆå¤šæœ‰æ„æ€çš„åœ°æ–¹äº†ã€‚</p>
<ul>
<li>performWorkOnRootä¼šè°ƒç”¨workLoopå¯¹nextFlushedRootèŠ‚ç‚¹è¿›è¡Œéå†</li>
<li>findHighestPriorityRootç§»é™¤å®Œæˆçš„fiberNodeï¼Œç„¶åå¦‚æœè¿˜æœ‰æœ‰æ•ˆå€¼ ç»§ç»­performWorkOnRoot</li>
<li>ç›´åˆ°nextFlushedRootå†æ— æœ‰æ•ˆå€¼</li>
</ul>
<p><strong>æ‰€ä»¥è¯´ è¿™é‡Œå¯¹äºperformWorkå‡½æ•°è¿™é‡Œæœ‰è¿›ä¸€æ­¥çš„è®¤çŸ¥ã€‚å®ƒæ˜¯å¯¹scheduledé“¾è¡¨å®Œæ•´çš„éå†ã€‚è€ŒperformWorkOnRootåªæ˜¯é’ˆå¯¹æŒ‡å®šçš„rootèŠ‚ç‚¹æ¥è¿›è¡Œéå†ã€‚</strong></p>
<h2 id="performWorkOnRoot"><a href="#performWorkOnRoot" class="headerlink" title="performWorkOnRoot"></a>performWorkOnRoot</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWorkOnRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  isYieldy: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  isRendering = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isYieldy) &#123;</span><br><span class="line">    <span class="keyword">let</span> finishedWork = root.finishedWork;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// finishedWorkæœ‰énullå€¼è¯´æ˜ä¸€åˆ‡å°±ç»ªå¯ä»¥è¿›å…¥commit phase</span></span><br><span class="line">      completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">	  <span class="comment">// å¦‚æœä¹‹å‰æš‚åœäº†ä»»åŠ¡ éœ€è¦æ¸…é™¤root.timeoutHandleã€‚cancelTimeoutå®è´¨ä¸Šæ˜¯clearTimeout</span></span><br><span class="line">      <span class="comment">// è¿™é‡Œå•ç‹¬åŒ…è£…ä¸€ä¸ªæ˜¯å› ä¸ºä¸€äº›ç¯å¢ƒ æ¯”å¦‚ssrä¸‹æ²¡æœ‰clearTimeout</span></span><br><span class="line">      <span class="comment">// è¿™é‡Œæš‚æ—¶æ²¡çœ‹åˆ°å¼‚æ­¥æš‚åœè¿™å— å¯ä»¥å¿½ç•¥ ä¸æ˜¯å¿…ç»è·¯å¾„</span></span><br><span class="line">      <span class="keyword">const</span> timeoutHandle = root.timeoutHandle;</span><br><span class="line">      <span class="keyword">if</span> (timeoutHandle !== noTimeout) &#123;</span><br><span class="line">        root.timeoutHandle = noTimeout;</span><br><span class="line">        cancelTimeout(timeoutHandle);</span><br><span class="line">      &#125;</span><br><span class="line">      renderRoot(root, isYieldy);</span><br><span class="line">      finishedWork = root.finishedWork;</span><br><span class="line">      <span class="keyword">if</span> (finishedWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;ve completed the root. Commit it.</span></span><br><span class="line">        completeRoot(root, finishedWork, expirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Flush async work. å¼‚æ­¥ä»»åŠ¡ æš‚æ—¶ç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isRendering = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ ¸å¿ƒè·¯å¾„æ˜¯:</p>
<ul>
<li>å¦‚æœroot.finishedWorkæœ‰éç©ºå€¼ è¿›å…¥commit phase</li>
<li>å¦åˆ™æ‰§è¡ŒrenderRoot</li>
<li>renderRootä¼šæ›´æ–°root.finishedWorkå€¼ï¼Œæ¥ä¸‹æ¥è¿›å…¥commit phase(completeRoot)</li>
</ul>
<h2 id="renderRoot"><a href="#renderRoot" class="headerlink" title="renderRoot"></a>renderRoot</h2><p>renderRootæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„å‡½æ•°ã€‚ä½†æ˜¯éšç€ç›¸å…³ç»†èŠ‚ç†è§£æ·±å…¥ã€‚å¯ä»¥åšå¾ˆå¤šç²¾ç®€äº†ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params">root: FiberRoot, isYieldy: boolean</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  flushPassiveEffects(); <span class="comment">// è¿™ä¸ªå‡½æ•°æš‚æ—¶æ²¡ææ‡‚ å’Œeffectæœ‰å…³ ä½†æ˜¯ä¸ä¸€å®šä¼šè¿›å» æ•…å¯ç•¥è¿‡</span></span><br><span class="line"></span><br><span class="line">  isWorking = <span class="literal">true</span>; <span class="comment">// ä½œä¸ºç¦æ­¢è¢«é€’å½’è°ƒç”¨çš„Flag</span></span><br><span class="line">  <span class="keyword">const</span> previousDispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">  ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> expirationTime = root.nextExpirationTimeToWorkOn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯ä¸€ä¸ªæ–°çš„stackå¼€å§‹ï¼Œè¿˜æ˜¯ä»ä¹‹å‰è¢«ä¸­æ–­çš„åœ°æ–¹å¼€å§‹ è¿™é‡Œä¸ç†ä¼š</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    expirationTime !== nextRenderExpirationTime ||</span><br><span class="line">    root !== nextRoot ||</span><br><span class="line">    nextUnitOfWork === <span class="literal">null</span></span><br><span class="line">  ) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123; &#125; <span class="comment">// ç»™å¼€å‘å·¥å…·ç”¨çš„ ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> didFatal = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  startWorkLoopTimer(nextUnitOfWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoop(isYieldy);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;&#125; <span class="comment">// é”™è¯¯æ•è·ç”¨çš„ è¿™é‡Œä¹Ÿä¸ç®¡</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123; &#125; <span class="comment">// ç»™å¼€å‘å·¥å…·ç”¨çš„ ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We&#x27;re done performing work. Time to clean up.</span></span><br><span class="line">  isWorking = <span class="literal">false</span>;</span><br><span class="line">  ReactCurrentDispatcher.current = previousDispatcher;</span><br><span class="line">  resetContextDependences();</span><br><span class="line">  resetHooks();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Yield back to main thread.</span></span><br><span class="line">  <span class="keyword">if</span> (didFatal) &#123;&#125; <span class="comment">// workLoopçš„catché‡Œé¢ä¼šå®šä¹‰ä¸ºtrue è¿™é‡Œå¿½ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// treeé‡Œé¢ä»æœ‰å¼‚æ­¥ä»»åŠ¡ ä½†æ˜¯æ²¡æ—¶é—´ç»§ç»­å®Œæˆä»»åŠ¡äº† å…ˆè¿”å›æ¸²æŸ“ä¸»çº¿ç¨‹ ä»£ç ç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We completed the whole tree.</span></span><br><span class="line">  <span class="keyword">const</span> didCompleteRoot = <span class="literal">true</span>;</span><br><span class="line">  stopWorkLoopTimer(interruptedBy, didCompleteRoot);</span><br><span class="line">  <span class="keyword">const</span> rootWorkInProgress = root.current.alternate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `nextRoot`æŒ‡å‘æ­£åœ¨è¿›è¡Œçš„æ ¹ã€‚éç©ºå€¼æ„å‘³ç€æˆ‘ä»¬æ­£å¤„äºå¼‚æ­¥æ¸²æŸ“çš„è¿‡ç¨‹ä¸­</span></span><br><span class="line">  <span class="comment">// å°†å…¶è®¾ç½®ä¸ºnullåˆ™è¡¨ç¤º åœ¨å½“å‰æ‰¹æ¬¡ä¸­æ²¡æœ‰æ›´å¤šçš„å·¥ä½œè¦åšã€‚</span></span><br><span class="line">  nextRoot = <span class="literal">null</span>;</span><br><span class="line">  interruptedBy = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextRenderDidError) &#123;&#125; <span class="comment">// workLoopçš„catché‡Œé¢ä¼šè°ƒç”¨throwException()</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isYieldy &amp;&amp; nextLatestAbsoluteTimeoutMs !== -<span class="number">1</span>) &#123;&#125; <span class="comment">// å¼‚æ­¥ç›¸å…³ ä¸ç®¡</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ready to commit.</span></span><br><span class="line">  onComplete(root, rootWorkInProgress, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè®¤çœŸåˆ†æäº†ä¸€ä¸‹ï¼Œæ¸…é™¤äº†å¤§éƒ¨åˆ†å¹²æ‰°ä»£ç ï¼Œæœ€ç»ˆè¿˜æ˜¯ç¡®è®¤ç§»é™¤äº†å¼‚æ­¥å¤„ç†ã€é”™è¯¯å¤„ç†ã€è¿½è¸ª(å¼€å‘å·¥å…·)å¤„ç†ä¹‹åã€‚å®ƒæ ¸å¿ƒåœ°æ–¹æ˜¯workLoop &amp; onCompleteã€‚onCompleteç›¸å…³åˆ°commit Phase,æˆ‘ä»¬å†updateçš„commit phaseé‡Œé¢ç¡®è®¤äº†Diffå’Œå®ƒæ— å…³ã€‚æ‰€ä»¥æ ¸å¿ƒå°±æ˜¯workLoopäº†ã€‚</p>
<h2 id="workLoop"><a href="#workLoop" class="headerlink" title="workLoop"></a>workLoop</h2><p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒæ˜¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (nextUnitOfWork !== <span class="literal">null</span>) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">workInProgress: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// See if beginning this work spawns more work.</span></span><br><span class="line">  startWorkTimer(workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer) &#123;&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next = beginWork(current, workInProgress, nextRenderExpirationTime);</span><br><span class="line">    workInProgress.memoizedProps = workInProgress.pendingProps;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn&#x27;t spawn new work, complete the current work.</span></span><br><span class="line">    next = completeUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯Diffç®—æ³•æ ¸å¿ƒå…¥å£äº†ï¼Œå› ä¸ºfiberNodeéå†åœ¨è¿™é‡Œå¾—åˆ°æç°ã€‚</p>
<p>beginWorkè¿”å›fiberçš„childï¼ŒperformUnitOfWorkè¿”å›fiberçš„nextï¼Œè€ŒcompleteUnitOfWorkè¿”å›fiberçš„returnã€‚</p>
<p>æ‰€è°“å¤§èƒ†æ¨æµ‹ï¼Œå°å¿ƒæ±‚è¯ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›æ¨æµ‹ï¼Œç„¶åå°å¿ƒéªŒè¯å®ƒã€‚</p>
<p>è¿™é‡Œå¤§èƒ†åˆä¿å®ˆçš„æ¨æµ‹ï¼Œæˆ‘ä»¬åœ¨v15é‡Œé¢çš„ç”¨åˆ°çš„CompoentDiffã€Tree Diffã€Element Diffä¾ç„¶å­˜åœ¨ã€‚å› ä¸ºæ‰€æœ‰çš„Diffå®è´¨ä¸Šéƒ½æ˜¯å’Œchildç›¸å…³ï¼Œæ‰€ä»¥å¯ä»¥å¤§èƒ†çŒœæµ‹ï¼ŒDiffç›¸å…³é€»è¾‘ï¼Œå®è´¨ä¸Šéƒ½å­˜åœ¨äºbeginWorkâ€”â€”è¿™ä¹Ÿæ¯”è¾ƒç¬¦åˆbeginWorkçš„å‘½åã€‚</p>
<h2 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h2><p>è¿™é‡Œç•¥å»å¤§å¤šæ•°å¹²æ‰°ä»£ç ï¼Œä»…ä»…ä¿ç•™å¸¸è§çš„IndeterminateComponentã€FunctionComponentã€ClassComponentä¹‹ç±»ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || hasLegacyContextChanged()) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">// è¿™é‡Œå’Œdiffæ— å…³ å…ˆä¸ç®¡äº†</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before entering the begin phase, clear the expiration time.</span></span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> elementType = workInProgress.elementType;</span><br><span class="line">      <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        elementType,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> LazyComponent: : &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123; </span><br><span class="line">      <span class="keyword">return</span> updateHostComponent(current$$1, workInProgress, renderExpirationTime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> HostPortal: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> ForwardRef: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> Fragment: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> Mode: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> ContextProvider: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> MemoComponent: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123; &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> DehydratedSuspenseComponent: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClassComponent"><a href="#ClassComponent" class="headerlink" title="ClassComponent"></a>ClassComponent</h3><p>è¿™é‡Œé‡ç‚¹å…³æ³¨ClassComponentï¼Œæ¯•ç«Ÿv15è¿˜æ˜¯ä»¥å®ƒä¸ºä¸»çš„åˆ†æï¼Œæ–¹ä¾¿å‚ç…§ã€‚</p>
<p>è¿™é‡ŒupdateClassComponentå‡½æ•°æ­£å¸¸æ›´æ–°çš„è¯ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªè°ƒç”¨ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°æ ¹æ®workInProgressä¸Šçš„updateQueueã€propsã€lifecyclesHooksæ›´æ–°äº†stateNodeå±æ€§</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯ç»„ä»¶å®ä¾‹ æ–°çš„propsä¹‹ç±»éƒ½åœ¨è¿™ä¸ªstateNodeä¸Šä¿å­˜èµ·æ¥äº†</span></span><br><span class="line">shouldUpdate = updateClassInstance(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    nextProps,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> nextUnitOfWork = finishClassComponent( <span class="comment">// çœ‹ä¸‹é¢ å•ç‹¬åˆ†æ</span></span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> nextUnitOfWork;</span><br></pre></td></tr></table></figure>

<p>finishClassComponentæ£€æµ‹åˆ°å˜åŒ–åï¼Œä¸»è¦è°ƒç”¨åˆ™å¦‚ä¸‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">nextChildren = instance.render(); <span class="comment">// æ›´æ–°åçš„å®ä¾‹ï¼Œrenderæ‰§è¡Œä¼šè¿”å›ä¸€ä¸ªVDOMæ ‘</span></span><br><span class="line">reconcileChildren( <span class="comment">// reconcileChildrenç­‰ä»·äºChildReconciler(true)</span></span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ChildReconcileråœ¨Reactä¸­çš„æ³¨é‡Šè¯´åˆ°è¿™ä¸ªå‡½æ•°ä»¥åå¯èƒ½å•ç‹¬æŠ½å‡ºè¿›è¡Œæ‰‹åŠ¨æˆ–è€…ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–ã€‚è¿™ä¸ªå‡½æ•°é‡Œé¢helpersè¾…åŠ©å‡½æ•°å¤ªå¤šã€‚æ€»ä¹‹å®ƒæ‰§è¡Œåè¿”å›çš„æ˜¯å†…éƒ¨å‡½æ•°reconcileChildFibersã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†&lt;React.Fragment&gt;&lt;/React.Fragment&gt;è¯­æ³• å¯¹å…¶é‡‡ç”¨æ•°ç»„ä¸€æ ·çš„å¤„ç†é€»è¾‘</span></span><br><span class="line">  <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">    <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">    newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">    newChild.key === <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">    newChild = newChild.props.children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Handle object types</span></span><br><span class="line">  <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123; <span class="comment">// æ­£å¸¸çš„VDOMå¤„ç†æµç¨‹</span></span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$typeof) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">        <span class="keyword">return</span> placeSingleChild( <span class="comment">// â˜… è¿™é‡Œæ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒå…³æ³¨ç‚¹</span></span><br><span class="line">          reconcileSingleElement(</span><br><span class="line">            returnFiber,</span><br><span class="line">            currentFirstChild,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> REACT_PORTAL_TYPE: &#123;&#125; <span class="comment">// ç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&#x27;number&#x27;</span>) &#123; <span class="comment">// å¤„ç†æ–‡æœ¬ &amp; æ•°å­—</span></span><br><span class="line">    <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">      reconcileSingleTextNode(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span> + newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">    <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">      returnFiber,</span><br><span class="line">      currentFirstChild,</span><br><span class="line">      newChild,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿­ä»£å™¨å¤„ç† æš‚æ—¶è¿˜æ²¡å¬è¿‡renderé‡Œé¢å¯ä»¥è¿”å›ä¸€ä¸ªgeneratorå‡½æ•°å¾—ã€‚æ˜¯å¦æœ‰ä¸€å¤©æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼Ÿ</span></span><br><span class="line">  <span class="comment">// è¿˜æ˜¯æœ‰å…¶ä»–è€ƒè™‘ï¼Ÿ</span></span><br><span class="line">  <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123; &#125; <span class="comment">// é’ˆå¯¹ä¸Šçº§èŠ‚ç‚¹æ˜¯textareaçš„æŠ›é”™</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; !isUnkeyedTopLevelFragment) &#123; &#125; <span class="comment">// æŠ›å‡ºé”™è¯¯</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">  <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å•èŠ‚ç‚¹Children"><a href="#å•èŠ‚ç‚¹Children" class="headerlink" title="å•èŠ‚ç‚¹Children"></a>å•èŠ‚ç‚¹Children</h4><p>å•èŠ‚ç‚¹çš„childrenä¸ªäººå®è´¨ä¸Šå°±æ˜¯ComponentDiffçš„è·µè¡Œã€‚ä½†æ˜¯è¿™é‡Œä¹Ÿå¯¹Tree Diffæœ‰äº†éƒ¨åˆ†å®è·µï¼Œå› ä¸ºå®ƒåŒæ—¶æ‰¿æ‹…äº†ä¸€éƒ¨åˆ†çš„åˆ é™¤æ“ä½œï¼Œç»´æŠ¤äº†FiberNodeçš„siblingsã€‚</p>
<p>è¿™é‡Œçœ‹çœ‹placeSingleChildå‡½æ•°ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">    <span class="comment">// placement for inserting new children.</span></span><br><span class="line">    <span class="comment">// å¯¹äºå•rootèŠ‚ç‚¹çš„VDOMæ ‘ã€‚æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æ–°çš„childrenæ›¿æ¢å³å¯</span></span><br><span class="line">    <span class="comment">// shouldTrackSideEffects = true -&gt; reconcileChildrenç­‰ä»·äºChildReconciler(true)</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªshouldTrackSideEffectså°±æ˜¯ä¼ å…¥çš„å†™æ­»çš„trueå‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">        newFiber.effectTag = Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFiber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢æ³¨é‡Šå¾ˆæ˜äº†ï¼Œæˆ‘ä»¬çš„Component Diffå°±è¿™æ ·è½»ææ·¡å†™çš„åšå¥½äº†æ ‡è®°ï¼Œæœ‰äº›æªä¸åŠé˜²ã€‚ã€‚ã€‚</p>
<p>å¦å¤–å°±æ˜¯ï¼Œæ—¢ç„¶è¿™é‡Œè¯´äº†: å¦‚æœæ˜¯single child caseï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¼šæœ‰multiple child caseã€‚é‚£ä¹ˆï¼Œå¯ä»¥å¾ˆè‡ªç„¶çš„åšå‡ºæ¨æµ‹ï¼Œè¿™é‡Œçš„multiple child caseï¼Œå…¶å®è´¨å°±æ˜¯ElementDiffæˆ–è€…TreeDiffâ€”â€”æˆ‘ä»¬ç»§ç»­åˆ†æéªŒè¯reconcileSingleElementå‡½æ•°ã€‚</p>
<p>ä½†æ˜¯è¿™ä¹‹å‰ï¼Œæ ¹æ®placeSingleChildä¼ å‚ç±»å‹å’Œè¿”å›ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤reconcileSingleElementè¿”å›çš„æ˜¯ä¸€ä¸ªFiberNodeã€‚å¦å¤–è¦é¢å¤–å¯¹å®ƒçš„alternateå±æ€§è¿½è¸ªå’Œå…³æ³¨ï¼Œä»¥å®ŒæˆComponent Diffåˆ†æé—­ç¯ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.key === key) &#123; <span class="comment">// å¦‚æœæ˜¯å•èŠ‚ç‚¹ è¿™é‡Œç›¸ç­‰ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œåç»­å¯¹æ¯”</span></span><br><span class="line">      <span class="comment">// åˆ¤æ–­Fragmentè¿˜æ˜¯å¸¸è§„HostComponentã€ClassComponentçš„åˆæ³•æ€§</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        child.tag === Fragment</span><br><span class="line">          ? element.type === REACT_FRAGMENT_TYPE</span><br><span class="line">          : child.elementType === element.type</span><br><span class="line">      ) &#123;</span><br><span class="line">        deleteRemainingChildren(returnFiber, child.sibling);</span><br><span class="line">        <span class="keyword">const</span> existing = useFiber(</span><br><span class="line">          child,</span><br><span class="line">          element.type === REACT_FRAGMENT_TYPE</span><br><span class="line">            ? element.props.children</span><br><span class="line">            : element.props,</span><br><span class="line">          expirationTime,</span><br><span class="line">        );</span><br><span class="line">        existing.ref = coerceRef(returnFiber, child, element);</span><br><span class="line">        existing.return = returnFiber;</span><br><span class="line">        <span class="keyword">return</span> existing;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteRemainingChildren(returnFiber, child);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦åˆ™ç›´æ¥æ ‡è®°åˆ é™¤ å¹¶å°†childæ”¾åˆ°nextEffectä¸Šä»¥å¤‡é€’å½’åˆ é™¤ä¸‹çº§èŠ‚ç‚¹</span></span><br><span class="line">      deleteChild(returnFiber, child); </span><br><span class="line">    &#125;</span><br><span class="line">    child = child.sibling;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123; <span class="comment">// ä¿æŒç®€æ´å’Œå…³æ³¨ è¿™é‡Œåˆ†æ”¯ä¸ç†ä¼šäº†</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ­£å¸¸VDOMé€»è¾‘</span></span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromElement(</span><br><span class="line">      element,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    created.ref = coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”±ä¸€ä¸ªwhileå¾ªç¯ã€‚ä½†æ˜¯åˆ†æè¿™ä¸ªå¾ªç¯ä¹‹å‰ï¼Œè‰è‰æ‰«è¿‡è¿™ä¸ªä»£ç ï¼ŒåŸºæœ¬å·²ç»å¯ä»¥ç¡®è®¤å®ƒæ˜¯Tree Diffçš„æ ¸å¿ƒäº†ã€‚è¨€å½’æ­£ä¼ ï¼Œè¿”å›è¿™ä¸ªwhileçš„åˆ†æã€‚</p>
<p>è¿™ä¸ªwhileå®è´¨ä¸Šæ˜¯åšçš„fiberNodeé“¾è¡¨å’ŒVDOMæ ‘çš„å¯¹æ¯”ã€‚å®ƒä»ç»™å®šçš„ä¸€ä¸ªFiberNodeéå†åˆ°å®ƒåé¢æ‰€æœ‰çš„FiberNodeèŠ‚ç‚¹ã€‚</p>
<p>è¿™ä¸ªå¾ªç¯ï¼Œå®è´¨æ˜¯ä¸Šå•å±‚çš„å¾ªç¯ï¼Œå®ƒåªæ˜¯é’ˆå¯¹åŒä¸€å±‚çº§çš„VDOMå¯¹åº”çš„FiberNodeè¿›è¡Œäº†æ ‡è®°ã€‚<code>child = child.sibling</code>è¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚</p>
<p>è¿™é‡Œä¸»è¦æ˜¯åˆ é™¤çš„é€»è¾‘ã€‚åˆ†æä¸€ä¸‹ç›¸å…³å‡½æ•°:</p>
<p>deleteChildå‡½æ•°ç›´æ¥æ ‡è®°åˆ é™¤(effectTag = Deletion) å¹¶å°†childæ”¾åˆ°nextEffectä¸Šä»¥å¤‡é€’å½’åˆ é™¤ä¸‹çº§èŠ‚ç‚¹ã€‚</p>
<p>è€ŒdeleteRemainingChildrenåˆ™æ˜¯åšä¸€äº›éå†ç„¶åè°ƒç”¨deleteChildæ ‡è®°åˆ é™¤ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Noop.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> For the shouldClone case, this could be micro-optimized a bit by</span></span><br><span class="line">  <span class="comment">// assuming that after the first child we&#x27;ve already added everything.</span></span><br><span class="line">  <span class="keyword">let</span> childToDelete = currentFirstChild;</span><br><span class="line">  <span class="keyword">while</span> (childToDelete !== <span class="literal">null</span>) &#123;</span><br><span class="line">    deleteChild(returnFiber, childToDelete);</span><br><span class="line">    childToDelete = childToDelete.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»¼åˆdeleteChildã€deleteRemainingChildrenã€reconcileSingleElementæˆä¸€ä¸ªæ•´ä½“æ¥çœ‹ã€‚</p>
<ul>
<li>å½“childrenä¸ºä¸€ä¸ªå•ç‹¬çš„VDOMï¼Œæ­¤æ—¶FiberNodeæ­¤æ—¶å¯èƒ½å­˜åœ¨å¤šä¸ªåŒçº§çš„FiberNode(é€šè¿‡siblingè¿›è¡Œé“¾æ¥)ï¼Œæ‰€ä»¥è¦å¯¹è¿™äº›å¤šå‡ºæ¥çš„FiberNodeè¿›è¡Œåˆ é™¤</li>
<li>å½“keyå¯¹åº”å®Œæ¯•ã€‚ç›´æ¥ä½¿ç”¨deleteRemainingChildrenæ ‡è®°åˆ é™¤å‰©ä½™åé¢æ‰€æœ‰fiber.siblingåŠå…¶å­èŠ‚ç‚¹</li>
<li>å…³äºç¬¬äºŒæ¡çš„keyå¯¹åº”ã€‚å½“keyåœ¨ä¸­é—´æ—¶å€™ï¼Œkeyå‰é¢çš„ä½¿ç”¨deleteChildå½“ä¸ªåˆ é™¤ã€‚æ‰¾åˆ°keyä¹‹åï¼Œæ‰¹é‡deleteChildåˆ é™¤ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œæ€»çš„æ¥è®²ï¼Œè¿™é‡Œæ˜¯Tree Diffæ²¡é”™ï¼Œä½†æ˜¯æ›´å¤šçš„åŒæ—¶ComponentDiffçš„æ›¿æ¢è¡Œä¸ºï¼Œä¸€æ—¦ClassComponent&amp;HostComponentè¿™äº›åšäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆç›´æ¥ç”¨æ–°çš„æ›¿æ¢å®ƒ(è¿™é‡Œå®ƒæ˜¯FiberNode)ã€‚</p>
<p>è¿™é‡Œå†çœ‹çœ‹keyå¯¹åº”å®Œæ¯•ååˆ›å»ºæ–°çš„fiberçš„å‡½æ•°useFiberã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ªworkInProgressèŠ‚ç‚¹ã€‚å½“current.alternateæœ‰å€¼ï¼Œç›´æ¥ä¿®æ”¹æ›´æ–°å®ƒï¼Œå¦‚æœæ²¡å€¼çš„è¯åˆ™åˆ›å»ºä¸€ä¸ªï¼Œå¹¶å°†åˆ›å»ºçš„fiberçš„alternateè®¾ä¸ºcurrentã€‚</p>
<h4 id="å¤šèŠ‚ç‚¹children"><a href="#å¤šèŠ‚ç‚¹children" class="headerlink" title="å¤šèŠ‚ç‚¹children"></a>å¤šèŠ‚ç‚¹children</h4><p>å¦‚æœè¯´å•èŠ‚ç‚¹æ˜¯å…¶ä»–ä¸¤ç§Diffç®—æ³•å¤šä¸€äº›ã€‚é‚£ä¹ˆå¤šèŠ‚ç‚¹childrenåˆ™æ˜¯ä¾§é‡äº†ElementDiffã€‚åŒçº§å¤šèŠ‚ç‚¹çš„æ›´æ–°ï¼Œå¿…ç„¶ä¼šä¼´éšç€èŠ‚ç‚¹çš„åˆ é™¤ã€ç§»åŠ¨ã€æ’å…¥ï¼ŒElementDiffç®—æ³•åœ¨è¿™é‡Œå°†ä¼šæ˜¯ä¸»è§’ã€‚</p>
<p>å®ƒå¯¹åº”çš„<code>reconcileChildrenArray</code>å‡½æ•°ã€‚å¦‚æœå¯¹ElementDiffå®ç°æ²¡æœ‰äº†è§£çš„ã€‚å¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="/2019/06/25/react-diff/#Element-Diff">&lt;<React Diff>&gt;</a>ç¯‡ã€‚å½“ç„¶ï¼Œè¿™æ˜¯v15ç‰ˆæœ¬çš„åˆ†æã€‚</p>
<p>å¯¹è¿™ä¸ªåˆ†æé‡Œé¢çš„ElementDiffåˆ†æåšç®€è¿°ï¼Œå°±æ˜¯<strong>æ–°Index&gt;æ—§Indexï¼Œé‚£ä¹ˆéœ€è¦å°†æ—§çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°æ–°çš„Index</strong>ã€‚ç†è§£è¿™ä¸ªéå¸¸é‡è¦ï¼Œå› ä¸ºæ€è·¯å’Œv15ç‰ˆæœ¬ä¸€è‡´ï¼Œè¿™é‡Œä¸å†æè¿°è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>åè¿‡æ¥è®²,<strong>å¦‚æœæ—§Index&gt;æ–°Indexï¼Œé‚£ä¹ˆåŸèŠ‚ç‚¹å¯ä»¥è€ƒè™‘åŸåœ°ä¸åŠ¨</strong>ã€‚</p>
<blockquote>
<p>Tips: å…³äºè¿™ä¸ªå¤§äºå°äºï¼Œå½“ABCDè½¬æ¢æˆBACDä¹Ÿå°±æ˜¯0123å˜æˆ1023æ—¶å€™ï¼Œåªéœ€è¦å¯¹Aè¿›è¡Œåˆ é™¤+åˆ›å»º+æ’å…¥ã€‚ABCDå¯¹åº”çš„æ˜¯æ—§indexï¼Œè€ŒBACDåˆ™æ˜¯æ–°indexã€‚æ‰€ä»¥è€ƒè™‘åˆ°å¤§äºç­‰äºå’Œå°äºç­‰äºè¿™ç§ç¬¦å·çš„ä¸¥è°¨æ€§ã€‚è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå®ƒçš„ä¸¥è°¨è¯´æ³•æ˜¯: <strong>å¦‚æœæ—§Index&gt;æ–°Indexï¼Œé‚£ä¹ˆåŸèŠ‚ç‚¹å¯ä»¥è€ƒè™‘åŸåœ°ä¸åŠ¨,å¦åˆ™æ—§index â‰¤ æ–° index, åˆ™éœ€è¦è¿›è¡Œæ ‡è®°ç§»åŠ¨</strong>ã€‚</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯æºç :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChildren: <span class="built_in">Array</span>&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> resultingFirstChild: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> previousNewFiber: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">  <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// ç¬¬ä¸€é“å¾ªç¯</span></span><br><span class="line">  <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">      <span class="comment">// æ—§index &gt; æ–°index nextOldFiberä¸ä¼šå˜åŒ– å¾ªç¯å°¾éƒ¨æœ‰:oldFiber = nextOldFiber;</span></span><br><span class="line">      <span class="comment">// è®¾ä¸ºnullï¼ŒfiberNodeä¼šèµ°createFiberFromElement</span></span><br><span class="line">      nextOldFiber = oldFiber;</span><br><span class="line">      oldFiber = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦åˆ™æŒ‡å‘oldFiber.sibling</span></span><br><span class="line">      nextOldFiber = oldFiber.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">      returnFiber,</span><br><span class="line">      oldFiber,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">            oldFiber = nextOldFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">    <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      resultingFirstChild = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      previousNewFiber.sibling = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    previousNewFiber = newFiber;</span><br><span class="line">    oldFiber = nextOldFiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">    deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ç¬¬äºŒé“å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">const</span> newFiber = createChild(</span><br><span class="line">        returnFiber,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (!newFiber) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸‰é“å¾ªç¯</span></span><br><span class="line">  <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">      existingChildren,</span><br><span class="line">      returnFiber,</span><br><span class="line">      newIdx,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (newFiber) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newFiber.alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">          existingChildren.delete(</span><br><span class="line">            newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">    existingChildren.forEach(<span class="function"><span class="params">child</span> =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œé¦–å…ˆè¦ç†è§£çš„æ˜¯nextOldFiberã€‚</p>
<p>è¿™é‡ŒnextOldFiberå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç¼“å­˜ä½œç”¨ï¼Œå®ƒçš„æ„ä¹‰æ˜¯å°†oldFiberæœ€åèµ‹å€¼ä¸º<code>oldFiber || oldFiber.sibling</code>ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬å˜æ›´å‰å…ƒç´ æ˜¯ABCDï¼Œå˜æ›´åæ˜¯BADCã€‚</p>
<p>å¦‚æœä½ è®¤ä¸ºè¿™ä¸ªå¾ªç¯æ˜¯æŒ‰BADCé¡ºåºï¼Œå°±å®¹æ˜“èµ°å…¥è¯¯åŒºã€‚</p>
<p>è¿™æ˜¯å› ä¸ºè¿™ä¸ªå¾ªç¯å®è´¨ä¸Šæ˜¯ä»¥newChildren(VDOM)ä¸ºé•¿åº¦è¿›è¡Œè‡ªå¢éå†(4)ï¼ŒoldFiberå®è´¨ä¸Šç¡®æ˜¯ä»ABCDçš„é¡ºåºéå†ï¼Œå¦‚æœä½ ç†è§£æ˜¯ä»¥newChildren(BADC)æ¥å¼€å¤´(ä¸ç®¡ä½ è®¤ä¸ºç›¸å…³å€¼ä¹Ÿå¥½ç´¢å¼•ä¹Ÿå¥½)ï¼Œé‚£ä¹ˆå°±å®¹æ˜“é™·å…¥é€»è¾‘é™·é˜±â€”â€”**ä½†å®è´¨ä¸Šï¼Œè¦ç†è§£è¿™ä¸€æ®µï¼Œå¿…é¡»ä»¥ABCDçš„é¡ºåºæ¥(nextOldFiber)**ï¼Œå¦‚æœä½ èƒ½ç†è§£è¿™ä¸€å—ï¼Œå°±èƒ½ç†è§£å®ƒçš„ç›®çš„äº†ã€‚</p>
<p>è€ŒnewIdxé™¤äº†ä¸å¾—å¤§äºnewChildren.length, å®è´¨ä¸Šå’ŒnewChildrenå’Œä¸€æ¯›é’±å…³ç³»æ²¡æœ‰ã€‚ä»–å°±æ˜¯ä¸€ä¸ªè‡ªå¢å˜é‡è€Œå·²ã€‚</p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿™é‡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">    nextOldFiber = oldFiber;</span><br><span class="line">    oldFiber = <span class="literal">null</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextOldFiber = oldFiber.sibling;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éƒ½ä¸ä¼šèµ°åˆ°ç¬¬ä¸€ä¸ªåˆ†æ”¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨æ¡ˆä¾‹ä½è¯ç®—æ³•ã€‚</p>
<h5 id="ä¾‹å­ä¸€"><a href="#ä¾‹å­ä¸€" class="headerlink" title="ä¾‹å­ä¸€"></a>ä¾‹å­ä¸€</h5><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç»„ä»¶Test</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">const</span> text = <span class="built_in">this</span>.props.children;</span><br><span class="line">    <span class="keyword">return</span> text === <span class="string">&#x27;Text&#x27;</span> ? </span><br><span class="line">        [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>].map(<span class="function"><span class="params">v</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;v&#125;</span>&gt;</span>&#123;v&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>) </span><br><span class="line">    	: [<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;C&#x27;</span>].map(<span class="function"><span class="params">v</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;v&#125;</span>&gt;</span>&#123;v&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”this.props.childrenä»â€™Textâ€™å˜æˆâ€™Numberâ€™ã€‚æ­¤æ—¶å®ƒåœ¨ç¬¬ä¸€ä¸ªå¾ªç¯é‡Œé¢é‡åˆ°updateSlotä¼šç›´æ¥è¿”å›nullï¼Œç„¶åå¾ªç¯è¢«è·³å‡ºã€‚</p>
<p>æ¥ä¸‹æ¥è·¯å¾„æ˜¯ä½¿ç”¨mapRemainingChildrenç”ŸæˆMapç»“æ„, è¿™é‡Œkeyä¸ºkeyï¼Œè€Œvalueä¸ºå¯¹åº”fiberNodeã€‚è¿™ä¸ªMapæ•°æ®ï¼Œå…¶å®å’ŒnewChildrenæ•°ç»„ç±»ä¼¼ã€‚</p>
<p><strong>ç„¶åè¿›å…¥ç¬¬ä¸‰é“å¾ªç¯</strong>ï¼Œè¿™ä¸ªå¾ªç¯é‡Œé¢ï¼Œä¼šéå†newChildren,ç„¶åæŒ¨ä¸ªè·å–newChildrenItem,è·å–keyç„¶åä»mapRemainingChildrenæ‰¾åˆ°å¯¹åº”çš„æ—§fiberNodeã€‚</p>
<ul>
<li>å¦‚æœèƒ½æ‰¾åˆ°å¯¹åº”keyç›¸åŒçš„ã€‚updateElementä¼šèµ°moveé€»è¾‘ï¼Œå¤ç”¨fiberNode</li>
<li>å¦‚æœæ‰¾ä¸åˆ°ã€‚updateElementèµ°inserté€»è¾‘ï¼Œä½¿ç”¨newChildrenItemåˆ›å»ºæ–°çš„fiberNode</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæ ¹æ®è¿™ä¸ªupdateElementç”Ÿæˆçš„fiberNodeï¼ŒæŸ¥çœ‹å…¶æ˜¯å¦æœ‰alternateå±æ€§ã€‚å¦‚æœæ˜¯å¤ç”¨fiberNodeï¼Œä¹Ÿå°±æ˜¯Mapé‡Œé¢èƒ½æ‰¾åˆ°æ—§fiberNodeçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æƒ…å†µåªéœ€è¦åšæ’åºï¼Œæ­¤æ—¶æ‰¾åˆ°äº†å°±è¦ä»åŸæ¥Mapé‡Œé¢åˆ é™¤å®ƒï¼Œç„¶åä½¿ç”¨placeChildæ‰§è¡Œæ’åºã€‚</p>
<p>æœ€åï¼Œå¦‚æœMapç»“æ„é‡Œé¢è¿˜æœ‰å¤šä½™çš„Itemï¼Œç›´æ¥åˆ é™¤å®ƒï¼Œæ–°çš„childrené‡Œé¢æ²¡æœ‰ä»–ä»¬ï¼Œæ‰€ä»¥å…¨éƒ¨æ ‡è®°åˆ é™¤ã€‚</p>
<h5 id="ä¾‹å­äºŒ"><a href="#ä¾‹å­äºŒ" class="headerlink" title="ä¾‹å­äºŒ"></a>ä¾‹å­äºŒ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Test extends React.Component&#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    const text &#x3D; this.props.children;</span><br><span class="line">    return text &#x3D;&#x3D;&#x3D; &#39;Text&#39; ? &lt;div&gt;</span><br><span class="line">          &lt;div&gt;1&lt;&#x2F;div&gt;</span><br><span class="line">          &lt;span&gt;4&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;div&gt; : &lt;div&gt;</span><br><span class="line">          &lt;span&gt;4&lt;&#x2F;span&gt;</span><br><span class="line">          &lt;div&gt;1&lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦è¯´å®ƒå’Œä¾‹å­åˆä»€ä¹ˆåŒºåˆ«ï¼Œé‚£å°±æ˜¯å®ƒæ²¡æœ‰keyäº†ã€‚æ­¤æ—¶å®ƒä¼šç›´æ¥åœ¨ç¬¬ä¸€é“å¾ªç¯çš„å®Œæˆdivå’Œspanå¯¹åº”fiberNodeçš„éå†(å¯¹HostComponentæ¥è¯´ï¼ŒupdateSlotä¼šè¿”å›updateElementæ‰§è¡Œç»“æœè€Œä¸æ˜¯null)ã€‚è¿™ä¸¤é“æµç¨‹é‡Œé¢éƒ½æ˜¯èµ°çš„åˆ›å»ºæ–°çš„ï¼Œæ›¿æ¢æ—§çš„å¤„ç†ï¼Œå®Œæ¯•ä¹‹åå°†åˆ›å»ºå‡ºæ¥çš„fiberNodeä½¿ç”¨siblingè¿æ¥èµ·æ¥ï¼Œå› ä¸ºå…¶éå†åˆ°åº•äº†ï¼Œæ‰€ä»¥ä»¥ä¸‹åˆ†æ”¯ä¼šè¢«æ‰§è¡Œã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">  deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">  <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆï¼ŒworkInProgress.childä¼šè¢«èµ‹å€¼ä¸ºresultingFirstChildã€‚</p>
<h5 id="é‡è¦è¡¥å……-placeChild"><a href="#é‡è¦è¡¥å……-placeChild" class="headerlink" title="é‡è¦è¡¥å……: placeChild"></a>é‡è¦è¡¥å……: placeChild</h5><p>ä¸€æ—¦æˆ‘ä»¬é€šè¿‡updateSlotè·å¾—ä¸€ä¸ªfiberNodeã€‚ä¸‹ä¸€æ­¥å¯èƒ½å°±æ˜¯ä¸€ä¸ªé‡å¤´æˆäº†ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼Œå¦å¤–lastPlacedIndexçš„åˆå§‹å€¼æ˜¯0ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lastPlacedIndex: number,</span></span></span><br><span class="line"><span class="function"><span class="params">  newIndex: number,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  newFiber.index = newIndex;</span><br><span class="line">  <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Noop.</span></span><br><span class="line">    <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> current = newFiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123; <span class="comment">// å¦‚æœnewFiber.alternateæœ‰å€¼ é‚£ä¹ˆåˆ¤å®šæ˜¯ç§»åŠ¨è¿˜æ˜¯ä¸ç®¡</span></span><br><span class="line">    <span class="keyword">const</span> oldIndex = current.index;</span><br><span class="line">    <span class="keyword">if</span> (oldIndex &lt; lastPlacedIndex) &#123;</span><br><span class="line">      <span class="comment">// This is a move.</span></span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;	<span class="comment">// åŸåœ°ä¸åŠ¨</span></span><br><span class="line">      <span class="comment">// This item can stay in place.</span></span><br><span class="line">      <span class="keyword">return</span> oldIndex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™è¿™æ˜¯ä¸€ä¸ªæ’å…¥åŠ¨ä½œ</span></span><br><span class="line">    <span class="comment">// This is an insertion.</span></span><br><span class="line">    newFiber.effectTag = Placement;</span><br><span class="line">    <span class="keyword">return</span> lastPlacedIndex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºè¿™ä¸ªå‡½æ•°ï¼Œæœ‰å‡ ç‚¹è¦æ˜ç¡®ã€‚</p>
<ul>
<li>é¦–å…ˆæ˜¯alternateï¼ŒfiberNodeä¸Šçš„alternateå®è´¨ä¸Šæ˜¯newTreeèŠ‚ç‚¹å¯¹oldTreeæˆ–è€…å«åšcurrentTreeæ ‘çš„èŠ‚ç‚¹çš„é“¾æ¥ã€‚è¿™é‡ŒnewFiberåˆ™æ˜¯ä¸å‰é¢æåˆ°çš„Treeç›¸å¯¹åº”çš„workInProgress(newTree)æ ‘ä¸Šçš„èŠ‚ç‚¹ã€‚</li>
<li>æ‰€ä»¥è¿™é‡ŒoldIndexå°±çœŸçš„æ˜¯oldIndex, ä½†æ˜¯lastPlacedIndexå´å¹¶ä¸èƒ½è¯´æ˜¯æ–°Indexã€‚æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰newIndexçš„æ¦‚å¿µï¼Œä½†æ˜¯å¯ä»¥å¾ˆè‡ªç„¶çš„æ¨æµ‹å®ƒè‚¯å®šä¹Ÿæœ‰ç±»ä¼¼é€»è¾‘ï¼Œè¿™é‡Œéœ€è¦æ¨æ¼”å‡ºæ¥ã€‚</li>
<li>å¦‚æœalternateä¸ä¸ºç©ºè¯´æ˜å¯ä»¥è¿›è¡Œç§»åŠ¨ã€ä¿æŒã€æ›´æ–°ç­‰å¤„ç†ï¼Œå¦åˆ™è¯´æ˜æ˜¯ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œè¦æ ‡è®°æ’å…¥</li>
</ul>
<p>å®ƒè¿™é‡Œé€»è¾‘æ˜¯æ€æ ·çš„, è¿˜æ˜¯å‡è®¾ABCD(0123-æ—§)åˆ°BADC(1032-æ–°)è¿›è¡Œå˜åŒ–(ä¾‹å­ä¸€)ã€‚å› ä¸ºè¿™é‡Œæ˜¯å¯¹newChildren(reconcileChildrenArrayä¸­)è¿›è¡Œéå†ï¼Œæ‰€ä»¥è¿™ä¸ªéå†å¯¹æ¯”æµç¨‹é¡ºåºæ˜¯: B-A-D-Cã€‚</p>
<p>ç¬¬ä¸€é:</p>
<p>â€‹    B: æ­¤æ—¶oldIndex = 1, lastPlacedIndex = 0; æ­¤æ—¶Bä¸åŠ¨ï¼ŒlastPlacedIndexèµ‹å€¼ä¸º1</p>
<p>ç¬¬äºŒé</p>
<p>â€‹    A:æ­¤æ—¶oldIndex = 0, lastPlacedIndex = 1; æ­¤æ—¶Aæ ‡è®°ç§»åŠ¨ï¼ŒlastPlacedIndexèµ‹å€¼ä¸º1</p>
<p>ç¬¬ä¸‰é:</p>
<p>â€‹    D:æ­¤æ—¶oldIndex = 3 , lastPlacedIndex = 1; æ­¤æ—¶Dä¸åŠ¨ï¼ŒlastPlacedIndexèµ‹å€¼ä¸º3</p>
<p>ç¬¬å››é:</p>
<p>â€‹    C:æ­¤æ—¶oldIndex = 2 , lastPlacedIndex = 3; æ­¤æ—¶Cæ ‡è®°ï¼ŒlastPlacedIndexèµ‹å€¼ä¸º3</p>
<p>åŸç†:</p>
<p>è¿™é‡Œæœ‰å¿…è¦å°†alternateå¯¹æ–°æ—§fiberNodeçš„é“¾æ¥æ·±å…¥ç†è§£ã€‚è¿™é‡Œè¿›è¡Œå¤„ç†æ—¶å€™å°†ç¬¬ä¸€ä¸ªå…ƒç´ Bä½œä¸ºäº†åˆå§‹åŸºå‡†ï¼ŒåŸºå‡†å€¼å–å…¶æ—§index: 1, æ­¤åAå› ä¸ºåŸæ¥ä½ç½®æ¯”é å‰(æ—§index &lt; åŸºå‡†å€¼)ï¼Œä½†æ˜¯æ–°é¡ºåºå´é åï¼Œæ‰€ä»¥æŒ‰ç…§ä»å·¦å¾€åçš„é¡ºåºï¼Œå®ƒå¿…é¡»ç§»åŠ¨ï¼Œå®Œæ¯•ååŸºå‡†è¿˜æ˜¯Bï¼Œç»§ç»­å¤„ç†Dï¼Œæ­¤æ—¶D.indexå¤§äºåŸºå‡†å€¼ï¼Œåœ¨æ–°çš„é¡ºåºé‡Œé¢ä¹Ÿåœ¨Båé¢ï¼Œæ‰€ä»¥å®ƒä¸åŠ¨ï¼Œæ”¹å˜åŸºå‡†å€¼ä¸ºD.index: 3ã€‚ç»§ç»­å¤„ç†C, å®ƒå’ŒAä¸€æ ·ï¼ŒåŸæ¥ä½ç½®é å‰(æ—§index &lt; åŸºå‡†å€¼)ï¼Œä½†æ˜¯å´åœ¨Dåé¢ï¼Œæ‰€ä»¥éœ€è¦æ ‡è®°ç§»åŠ¨ã€‚</p>
<p><strong>ä½†æ˜¯è¿™é‡Œä»…ä»…æ˜¯æ ‡è®°äº†æ“ä½œåŠæ³•ï¼Œç´¢å¼•è¿˜æ²¡å¤„ç†ã€‚</strong>å®ƒçš„ç´¢å¼•ï¼Œåˆ™æ˜¯é€šè¿‡resultingFirstChildå˜é‡å®ç°çš„ã€‚æ¯æ¬¡å¾—åˆ°æ–°çš„å€¼ï¼Œå®ƒä¼šæŒ‚è½½ä¸Šä¸€ä¸ªè·å–åˆ°çš„fiberNodeçš„siblingå±æ€§ä¸Šï¼Œè¿™ä¸ªsiblingä¸€è·¯é“¾ä¸‹æ¥ï¼Œå°±æ˜¯å®è´¨æ€§çš„indexã€‚</p>
<h5 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h5><p>è¿™é‡Œç®—æ³•å’Œv15æœ‰äº†å¾ˆå¤šå˜åŒ–ã€‚å®ç°ç»†èŠ‚ä¸Šå·²ç»å‡ ä¹æ²¡æœ‰ç›¸åŒåœ°æ–¹äº†ã€‚</p>
<p>é’ˆå¯¹keyçš„treeå¯¹æ¯”è¿™é‡Œè¿˜æ˜¯æœ‰ï¼Œæ€è·¯ä¸€è‡´ï¼Œä¸è¿‡å·²ç»æ”¹ç”¨Mapç»“æ„æ¥ä¿å­˜äº†ï¼Œç„¶åç§»åŠ¨è®¡ç®—ä¸ŠåŸºäºupdateFromMap-&gt;updateElementçš„æ–¹å¼æ¥å®ç°äº†ã€‚</p>
<p>è€Œç´¢å¼•ï¼Œè¿™é‡Œçš„è°ƒå’Œç®—æ³•ä¸Šï¼Œå®è´¨å·²ç»æ²¡æœ‰è¿™ä¸ªä¸œè¥¿äº†ï¼Œå®ƒä¾æ‰˜fiberNodeçš„siblingå°±å®ç°äº†ã€‚</p>
<p>ä¸€å¥—éå†èµ°ä¸‹æ¥ï¼Œå¦‚æœMapæ•°æ®é‡Œé¢è¿˜æœ‰å¤šä½™ï¼Œå°±æ˜¯è¡¥è¶³äº†ä¹‹å‰v15 Tree Diffè¿‡ç¨‹ä¸­å¯¹Deleteçš„æ ‡è®°ï¼Œç›´æ¥éå†Mapè¿›è¡Œåˆ é™¤æ ‡è®°å³å¯ã€‚</p>
<p>å…¶ä»–æƒ…å†µï¼ŒFragmentéƒ½æ˜¯èµ°çš„ç›´æ¥åˆ›å»ºæ–°çš„ç„¶åæ ‡è®°æ’å…¥ï¼Œæœ€åæ ‡è®°ç§»é™¤æ—§çš„ã€‚</p>
<h3 id="HostComponent"><a href="#HostComponent" class="headerlink" title="HostComponent"></a>HostComponent</h3><p>å‡ºäº†å¸¸è§çš„ClassComponentï¼ŒHostComponentåœ¨æµè§ˆå™¨ç¯å¢ƒæ˜¾ç„¶æ˜¯æ›´åŠ åŸºç¡€çš„ç»„ä»¶è¡¨ç¤ºå½¢å¼ï¼Œå®é™…ä¸Šæ‰€æœ‰çš„ClassComponentï¼Œéƒ½æ˜¯å¯¹HostComponentç»„ä»¶çš„å¼•ç”¨å’Œæ‰©å±•ã€‚</p>
<p>v16å°†v15é‡Œé¢çš„ReactDomComponentç§°ä¹‹ä¸ºHostComponentï¼Œå¸¸è§çš„divã€spanéƒ½ä¼šè½¬æ¢ä¸ºHostComponentã€‚</p>
<p>åœ¨beginWorké‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œé¢å¯¹HostComponentã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HostComponent: &#123; </span><br><span class="line">    <span class="keyword">return</span> updateHostComponent(current$$1, workInProgress, renderExpirationTime)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>updateHostComponentå‡½æ•°é‡Œé¢åŒ…å«äº†contextã€refå’ŒexpirationTimeä¹‹ç±»çš„å¤„ç†ã€‚ä½†æ˜¯æœ€æ ¸å¿ƒçš„è¿˜æ˜¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">reconcileChildren(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> workInProgress.child;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¿™é‡Œåˆèµ°äº†ClassComponentçš„è°ƒç”¨æ ˆã€‚å…¶ä¸­ç»†èŠ‚è¿™é‡Œä¸å†å¤è¿°ã€‚</p>
<h3 id="FunctionComponent"><a href="#FunctionComponent" class="headerlink" title="FunctionComponent"></a>FunctionComponent</h3><p>å‡ ä¹ç­‰åŒHostComponentæƒ…å†µã€‚æ ¸å¿ƒè°ƒç”¨éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p>
<h1 id="Diffç®—æ³•å°æ€»ç»“"><a href="#Diffç®—æ³•å°æ€»ç»“" class="headerlink" title="Diffç®—æ³•å°æ€»ç»“"></a>Diffç®—æ³•å°æ€»ç»“</h1><p>å®è´¨ä¸Šåœ¨beginWorké‡Œé¢å¯¹ç®—æ³•å·²ç»æœ‰äº†å¾ˆæ˜æ˜¾çš„è¯´æ˜äº†ã€‚ä½†æ˜¯è¿™é‡Œè¿˜æ˜¯è¦å•ç‹¬æŠ½å‡ºæ¥è®²ä¸€è®²ã€‚</p>
<p>æˆ‘ä»¬çš„ComponentDiffã€TreeDiffå’ŒElementDiffå®é™…ä¸Šè¿™é‡Œä»ç„¶é€‚ç”¨ã€‚</p>
<h2 id="Component-Diff"><a href="#Component-Diff" class="headerlink" title="Component Diff"></a>Component Diff</h2><p>è¿™ä¸ªç®—æ³•çš„æ„ä¹‰åœ¨äºï¼Œå½“ClassComponentæ²¡æœ‰å˜åŒ–æ—¶å€™ï¼Œä¸æ›´æ–°ï¼Œå˜åŒ–äº†ï¼Œå°±æ•´ä½“æ›¿æ¢ã€‚</p>
<p>placeSingleChildå‡½æ•°ä¸ºæ‰€æœ‰çš„SingleChildåšäº†æ›¿æ¢æ ‡è®°ã€‚</p>
<ul>
<li>å½“åˆ¤å®šä¸éœ€è¦æ›´æ–°ï¼Œä¸”æ²¡æœ‰æŠ›å‡ºé”™è¯¯çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªSingleChildä¼šå°†å®ƒè‡ªèº«çš„childå…¨éƒ¨é€’å½’åšä¸€ä¸ªå‰¯æœ¬(å‰¯æœ¬ä¹‹å‰ä¿æŒfiberNodeé“¾æ¥)ï¼Œå¹¶è¿”å›childã€‚</li>
<li>å¦åˆ™ï¼Œé€‚ç”¨reconcileChildrenå¤„ç†åé¢é€»è¾‘</li>
</ul>
<h2 id="Tree-Diff"><a href="#Tree-Diff" class="headerlink" title="Tree Diff"></a>Tree Diff</h2><p>è¿™é‡Œå®è´¨æ˜¯åŒå±‚çº§çš„å…ƒç´ çš„keyå¯¹æ¯”ã€‚æ ¸å¿ƒé€»è¾‘åœ¨reconcileChildrenArrayå‡½æ•°é‡Œé¢ã€‚</p>
<p>å®ƒæ˜¯è¿™æ ·åšçš„ã€‚å¦‚æœè¿™ä¸ªChildrenArrayä¸ŠItemæœ‰key propsã€‚é‚£ä¹ˆnewFiber = updateSlot(args) = nullã€‚ç„¶åè·³å‡ºå¾ªç¯å°†æ—§çš„FiberNodeå…¨éƒ¨æ”¾åˆ°Mapç»“æ„é‡Œé¢ï¼Œéå†æ–°çš„childrenæŸ¥æ‰¾å¯¹åº”keyçš„FiberNodeã€‚</p>
<p>æ²¡æ‰¾åˆ°ä¸€ä¸ªï¼Œå°±ä»Mapé‡Œé¢åˆ é™¤ä¸€ä¸ªï¼Œéå†å®Œæˆåï¼Œè¿˜åœ¨Mapé‡Œé¢çš„å°±å…¨éƒ¨æ ‡è®°åˆ é™¤ã€‚</p>
<h2 id="Element-Diff"><a href="#Element-Diff" class="headerlink" title="Element Diff"></a>Element Diff</h2><p>è¿™é‡Œä¸»è¦æ˜¯ä¸Šé¢reconcileChildrenArrayå‡½æ•°é‡Œé¢ï¼Œç¬¬ä¸‰é“å¾ªç¯é‡Œé¢å¤„ç†çš„ã€‚</p>
<p>å¦‚æœkeyå­˜åœ¨ï¼Œé‚£ä¹ˆå¤ç”¨ä¹‹å‰FiberNodeï¼Œå¦åˆ™æ ¹æ®æ–°çš„childrenåˆ›å»ºfiberNodeã€‚æˆ‘ä»¬éå†çš„æ˜¯newChildrenArrayï¼Œéå†è¿‡ç¨‹ä¸­å¾—åˆ°çš„æ–°çš„FiberNodeä¼šæŒ¨ä¸ªè¢«ä¸Šä¸€ä¸ªFiberNode.siblingé“¾æ¥èµ·æ¥,è¿™æ ·indexå°±èƒ½å¯¹åº”èµ·æ¥äº†ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/React-v16/" rel="tag"># React v16</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/08/07/react-v16-ChildReconciler/" rel="prev" title="react-v16-ChildReconciler">
      <i class="fa fa-chevron-left"></i> react-v16-ChildReconciler
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/08/28/v16-Scheduling-in-React/" rel="next" title="Reactçš„è°ƒåº¦-v16">
      Reactçš„è°ƒåº¦-v16 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">æ­£æ–‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#findHighestPriorityRoot"><span class="nav-number">2.1.</span> <span class="nav-text">findHighestPriorityRoot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E6%95%88%E8%8A%82%E7%82%B9%E6%B8%85%E9%99%A4"><span class="nav-number">2.1.1.</span> <span class="nav-text">æ— æ•ˆèŠ‚ç‚¹æ¸…é™¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E4%BC%98%E5%85%88%E8%8A%82%E7%82%B9"><span class="nav-number">2.1.2.</span> <span class="nav-text">è¿”å›ä¼˜å…ˆèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">2.1.3.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performWork"><span class="nav-number">2.2.</span> <span class="nav-text">performWork</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performWorkOnRoot"><span class="nav-number">2.3.</span> <span class="nav-text">performWorkOnRoot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderRoot"><span class="nav-number">2.4.</span> <span class="nav-text">renderRoot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#workLoop"><span class="nav-number">2.5.</span> <span class="nav-text">workLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beginWork"><span class="nav-number">2.6.</span> <span class="nav-text">beginWork</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ClassComponent"><span class="nav-number">2.6.1.</span> <span class="nav-text">ClassComponent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9Children"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">å•èŠ‚ç‚¹Children</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%8A%82%E7%82%B9children"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">å¤šèŠ‚ç‚¹children</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80"><span class="nav-number">2.6.1.2.1.</span> <span class="nav-text">ä¾‹å­ä¸€</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C"><span class="nav-number">2.6.1.2.2.</span> <span class="nav-text">ä¾‹å­äºŒ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E8%A6%81%E8%A1%A5%E5%85%85-placeChild"><span class="nav-number">2.6.1.2.3.</span> <span class="nav-text">é‡è¦è¡¥å……: placeChild</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">2.6.1.2.4.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HostComponent"><span class="nav-number">2.6.2.</span> <span class="nav-text">HostComponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FunctionComponent"><span class="nav-number">2.6.3.</span> <span class="nav-text">FunctionComponent</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Diff%E7%AE%97%E6%B3%95%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">Diffç®—æ³•å°æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Component-Diff"><span class="nav-number">3.1.</span> <span class="nav-text">Component Diff</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tree-Diff"><span class="nav-number">3.2.</span> <span class="nav-text">Tree Diff</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Element-Diff"><span class="nav-number">3.3.</span> <span class="nav-text">Element Diff</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">que01</p>
  <div class="site-description" itemprop="description">è‡ªå·±çš„å­¦ä¹ è®°å½•</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">que01</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"TXWIywcTsrMfVKtclog3CxDl-gzGzoHsz","app_key":"987dqIR4vvX2mQJjmAV86Qp0","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
