<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Microsoft YaHei, Verdana, sans-serif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.que01.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"AL4M83H31B","apiKey":"d30226bc78f2b15b834d9fc9993e3c42","indexName":"hexo","hits":{"per_page":10}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"bounceDownIn","post_body":"bounceDownIn","coll_header":"slideLeftIn","sidebar":"fadeInUp"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这篇整体分析了一下Redux在React中的生态，包括react-Redux、redux-saga脉络、原理(但并不包含redux代码和原理上的分析)。">
<meta property="og:type" content="article">
<meta property="og:title" content="react-redux-saga">
<meta property="og:url" content="http://www.que01.top/2019/06/15/react-redux-saga/index.html">
<meta property="og:site_name" content="Que&#39;s Blog">
<meta property="og:description" content="这篇整体分析了一下Redux在React中的生态，包括react-Redux、redux-saga脉络、原理(但并不包含redux代码和原理上的分析)。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-06-15T03:07:05.000Z">
<meta property="article:modified_time" content="2020-12-17T13:21:55.659Z">
<meta property="article:author" content="que01">
<meta property="article:tag" content="react">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.que01.top/2019/06/15/react-redux-saga/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react-redux-saga | Que's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Que's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WebFrontEnd Development</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.que01.top/2019/06/15/react-redux-saga/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="que01">
      <meta itemprop="description" content="自己的学习记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Que's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react-redux-saga
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-15 11:07:05" itemprop="dateCreated datePublished" datetime="2019-06-15T11:07:05+08:00">2019-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-17 21:21:55" itemprop="dateModified" datetime="2020-12-17T21:21:55+08:00">2020-12-17</time>
              </span>

          
            <span id="/2019/06/15/react-redux-saga/" class="post-meta-item leancloud_visitors" data-flag-title="react-redux-saga" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <div class="post-description">这篇整体分析了一下Redux在React中的生态，包括react-Redux、redux-saga脉络、原理(但并不包含redux代码和原理上的分析)。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="react-redux追索"><a href="#react-redux追索" class="headerlink" title="react-redux追索"></a>react-redux追索</h1><p>不管如何，react-redux是在redux的基础上的封装。</p>
<h1 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a>react-redux</h1><p>这里确定一下版本号 这里版本号是<strong>v5.1.1</strong>。后面版本有一些变化，我们后面再看看。</p>
<p>react-redux大致上和router一样 也是走的HOC(高阶组件) &amp;&amp; context的线路。不过这里还是简单了解一下。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(rootReducer)</span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;Route path=<span class="string">&quot;/&quot;</span> component=&#123;App&#125;&gt;</span><br><span class="line">        &lt;Route path=<span class="string">&quot;foo&quot;</span> component=&#123;Foo&#125;/&gt;</span><br><span class="line">        &lt;Route path=<span class="string">&quot;bar&quot;</span> component=&#123;Bar&#125;/&gt;</span><br><span class="line">      &lt;/Route&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这里<code>Provider</code>必须和<code>connect</code>配合使用。</p>
<p><a target="_blank" rel="noopener" href="https://codesandbox.io/s/github/reactjs/redux/tree/master/examples/todos">TODO例子</a></p>
<h1 id="Provider组件"><a href="#Provider组件" class="headerlink" title="Provider组件"></a>Provider组件</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Children &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">&#x27;prop-types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; storeShape, subscriptionShape &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/PropTypes&#x27;</span></span><br><span class="line"><span class="keyword">import</span> warning <span class="keyword">from</span> <span class="string">&#x27;../utils/warning&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> didWarnAboutReceivingStore = <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">warnAboutReceivingStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (didWarnAboutReceivingStore) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  didWarnAboutReceivingStore = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>(<span class="params">storeKey = <span class="string">&#x27;store&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> subscriptionKey = <span class="string">`<span class="subst">$&#123;storeKey&#125;</span>Subscription`</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="title">getChildContext</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123; [storeKey]: <span class="built_in">this</span>[storeKey], [subscriptionKey]: <span class="literal">null</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">constructor</span>(<span class="params">props, context</span>)</span> &#123;</span><br><span class="line">          <span class="built_in">super</span>(props, context)</span><br><span class="line">          <span class="built_in">this</span>[storeKey] = props.store;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> Children.only(<span class="built_in">this</span>.props.children)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Provider.propTypes = &#123;</span><br><span class="line">        store: storeShape.isRequired,</span><br><span class="line">        children: PropTypes.element.isRequired,</span><br><span class="line">    &#125;</span><br><span class="line">    Provider.childContextTypes = &#123;</span><br><span class="line">        [storeKey]: storeShape.isRequired,</span><br><span class="line">        [subscriptionKey]: subscriptionShape,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Provider</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createProvider()</span><br></pre></td></tr></table></figure>

<p>这里的核心还是context相关的代码——<code>getChildContext</code> &amp;&amp; <code>childContextTypes</code>。这里Provider导出的是<code>createProvider()</code>。返回的就是一个初始化了的，带有名为store的context的组件。</p>
<h1 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h1><h2 id="项目使用简况"><a href="#项目使用简况" class="headerlink" title="项目使用简况"></a>项目使用简况</h2><p>看看connect在一个react-redux项目中是怎么使用的，常见的就是在Container(页面级别)对组件进行一重包装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@connect(</span><br><span class="line">  (state: RootState, ownProps): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">dashBoard</span>: state.dashBoard &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  (dispatch: Dispatch): <span class="function"><span class="params">any</span> =&gt;</span> (&#123;</span><br><span class="line">    actions: bindActionCreators(omit(dashBoardActions, <span class="string">&#x27;Type&#x27;</span>), dispatch),</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">DashBoard</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">DashBoard</span>.<span class="title">Props</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>经过包装后的组件，就可以在组件内部引用到this.props.dashBoard属性，并且可以调用this.props.actions.xxxActions。</p>
<p>可以看出connect这个注解的作用，主要是第一个函数(mapStateToProps)给props挂载了函数一返回的属性，第二个函数(mapDispatchToProps)这挂载了相关的actions到props上。</p>
<hr>
<h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2><p>下面我们看看connect函数内容。</p>
<p><code>connect</code>最后返回的实质上是一个HOC。</p>
<h3 id="createConnect"><a href="#createConnect" class="headerlink" title="createConnect"></a>createConnect</h3><p>通过这个HOC方法，监听reduxStore，然后把下级组件需要的state(通过mapStateToProps获取)和action creator(通过mapDispatchToProps)。并绑定到wrappedComponent的props。</p>
<p>这一块的代码比较多，所以仅仅遴选最关键的逻辑节点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  connectHOC = connectAdvanced,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergePropsFactories = defaultMergePropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory = defaultSelectorFactory</span></span></span><br><span class="line"><span class="function"><span class="params">&#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      pure = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">      areStatesEqual = strictEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areOwnPropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areStatePropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areMergedPropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      ...extraOptions</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">&#x27;mapStateToProps&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">&#x27;mapDispatchToProps&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">&#x27;mergeProps&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, &#123;</span><br><span class="line">      methodName: <span class="string">&#x27;connect&#x27;</span>,</span><br><span class="line">      getDisplayName: <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Connect(<span class="subst">$&#123;name&#125;</span>)`</span>,</span><br><span class="line">      shouldHandleStateChanges: <span class="built_in">Boolean</span>(mapStateToProps),</span><br><span class="line">      initMapStateToProps,</span><br><span class="line">      initMapDispatchToProps,</span><br><span class="line">      initMergeProps,</span><br><span class="line">      pure,</span><br><span class="line">      areStatesEqual,</span><br><span class="line">      areOwnPropsEqual,</span><br><span class="line">      areStatePropsEqual,</span><br><span class="line">      areMergedPropsEqual,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createConnect()</span><br></pre></td></tr></table></figure>

<p>所以默认导出的就是<code>return function connect(...)&#123;...&#125;</code>这一块的代码。</p>
<h3 id="connectAdvanced"><a href="#connectAdvanced" class="headerlink" title="connectAdvanced"></a>connectAdvanced</h3><p>connect的操作实质指向了connectAdvanced。其代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    getDisplayName = name =&gt; <span class="string">`ConnectAdvanced(<span class="subst">$&#123;name&#125;</span>)`</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    methodName = <span class="string">&#x27;connectAdvanced&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderCountProp = <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldHandleStateChanges = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    storeKey = <span class="string">&#x27;store&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    withRef = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    ...connectOptions</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> subscriptionKey = storeKey + <span class="string">&#x27;Subscription&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> version = hotReloadingVersion++</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> contextTypes = &#123;</span><br><span class="line">    [storeKey]: storeShape,</span><br><span class="line">    [subscriptionKey]: subscriptionShape,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> childContextTypes = &#123;</span><br><span class="line">    [subscriptionKey]: subscriptionShape,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> wrappedComponentName = WrappedComponent.displayName</span><br><span class="line">      || WrappedComponent.name</span><br><span class="line">      || <span class="string">&#x27;Component&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> displayName = getDisplayName(wrappedComponentName)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> selectorFactoryOptions = &#123;</span><br><span class="line">      ...connectOptions,</span><br><span class="line">      getDisplayName,</span><br><span class="line">      methodName,</span><br><span class="line">      renderCountProp,</span><br><span class="line">      shouldHandleStateChanges,</span><br><span class="line">      storeKey,</span><br><span class="line">      withRef,</span><br><span class="line">      displayName,</span><br><span class="line">      wrappedComponentName,</span><br><span class="line">      WrappedComponent</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* eslint-enable react/no-deprecated */</span></span><br><span class="line"></span><br><span class="line">    Connect.WrappedComponent = WrappedComponent</span><br><span class="line">    Connect.displayName = displayName</span><br><span class="line">    Connect.childContextTypes = childContextTypes</span><br><span class="line">    Connect.contextTypes = contextTypes</span><br><span class="line">    Connect.propTypes = contextTypes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hoistStatics(Connect, WrappedComponent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而经过@connect注解后的组件，实质上是调用了connectAdvanced中返回的wrapWithConnect对组件进行了操作。</p>
<h3 id="wrapWithConnect"><a href="#wrapWithConnect" class="headerlink" title="wrapWithConnect"></a>wrapWithConnect</h3><p>hoistStatics因为涉及最终返回结果的包装处理，所以必须首先看看。<a target="_blank" rel="noopener" href="https://github.com/reactjs/reactjs.org/blob/master/content/docs/higher-order-components.md">这个hoistStatics实质上是解决HOC中一个缺陷而诞生的</a>。它的作用是将被包装组件的静态属性、方法等非react属性放到HOC上去，这样被包装组件上的静态属性在HOC上也就可以正常访问了。</p>
<p>这里hoistStatics函数是将WrappedComponent上帝静态属性放到Connect组件上并返回修改后的Connect组件。这里回忆一下我们写React页面时候很多时候会设定静态的属性就很容易理解了。</p>
<h4 id="Connect组件"><a href="#Connect组件" class="headerlink" title="Connect组件"></a>Connect组件</h4><p>截下来是研究一下关键的Connect组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="title">constructor</span>(<span class="params">props, context</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">super</span>(props, context)</span><br><span class="line"></span><br><span class="line">     <span class="built_in">this</span>.version = version</span><br><span class="line">     <span class="built_in">this</span>.state = &#123;&#125;</span><br><span class="line">     <span class="built_in">this</span>.renderCount = <span class="number">0</span></span><br><span class="line">     <span class="built_in">this</span>.store = props[storeKey] || context[storeKey]</span><br><span class="line">     <span class="built_in">this</span>.propsMode = <span class="built_in">Boolean</span>(props[storeKey])</span><br><span class="line">     <span class="built_in">this</span>.setWrappedInstance = <span class="built_in">this</span>.setWrappedInstance.bind(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line">     invariant(<span class="built_in">this</span>.store,</span><br><span class="line">       <span class="string">`Could not find &quot;<span class="subst">$&#123;storeKey&#125;</span>&quot; in either the context or props of `</span> +</span><br><span class="line">       <span class="string">`&quot;<span class="subst">$&#123;displayName&#125;</span>&quot;. Either wrap the root component in a &lt;Provider&gt;, `</span> +</span><br><span class="line">       <span class="string">`or explicitly pass &quot;<span class="subst">$&#123;storeKey&#125;</span>&quot; as a prop to &quot;<span class="subst">$&#123;displayName&#125;</span>&quot;.`</span></span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line">     <span class="built_in">this</span>.initSelector()</span><br><span class="line">     <span class="built_in">this</span>.initSubscription()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">getChildContext</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> subscription = <span class="built_in">this</span>.propsMode ? <span class="literal">null</span> : <span class="built_in">this</span>.subscription</span><br><span class="line">     <span class="keyword">return</span> &#123; [subscriptionKey]: subscription || <span class="built_in">this</span>.context[subscriptionKey] &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></span><br><span class="line">     <span class="built_in">this</span>.subscription.trySubscribe()</span><br><span class="line">     <span class="built_in">this</span>.selector.run(<span class="built_in">this</span>.props)</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.selector.shouldComponentUpdate) <span class="built_in">this</span>.forceUpdate()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.selector.run(nextProps)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.selector.shouldComponentUpdate</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.subscription) <span class="built_in">this</span>.subscription.tryUnsubscribe()</span><br><span class="line">     <span class="built_in">this</span>.subscription = <span class="literal">null</span></span><br><span class="line">     <span class="built_in">this</span>.notifyNestedSubs = noop</span><br><span class="line">     <span class="built_in">this</span>.store = <span class="literal">null</span></span><br><span class="line">     <span class="built_in">this</span>.selector.run = noop</span><br><span class="line">     <span class="built_in">this</span>.selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">getWrappedInstance</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     invariant(withRef,</span><br><span class="line">       <span class="string">`To access the wrapped instance, you need to specify `</span> +</span><br><span class="line">       <span class="string">`&#123; withRef: true &#125; in the options argument of the <span class="subst">$&#123;methodName&#125;</span>() call.`</span></span><br><span class="line">     )</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.wrappedInstance</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">setWrappedInstance</span>(<span class="params">ref</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.wrappedInstance = ref</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">initSelector</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> sourceSelector = selectorFactory(<span class="built_in">this</span>.store.dispatch, selectorFactoryOptions)</span><br><span class="line">     <span class="built_in">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="built_in">this</span>.store)</span><br><span class="line">     <span class="built_in">this</span>.selector.run(<span class="built_in">this</span>.props)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">initSubscription</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></span><br><span class="line">     <span class="keyword">const</span> parentSub = (<span class="built_in">this</span>.propsMode ? <span class="built_in">this</span>.props : <span class="built_in">this</span>.context)[subscriptionKey]</span><br><span class="line">     <span class="built_in">this</span>.subscription = <span class="keyword">new</span> Subscription(<span class="built_in">this</span>.store, parentSub, <span class="built_in">this</span>.onStateChange.bind(<span class="built_in">this</span>))</span><br><span class="line">     <span class="built_in">this</span>.notifyNestedSubs = <span class="built_in">this</span>.subscription.notifyNestedSubs.bind(<span class="built_in">this</span>.subscription)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">onStateChange</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.selector.run(<span class="built_in">this</span>.props)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">this</span>.selector.shouldComponentUpdate) &#123;</span><br><span class="line">       <span class="built_in">this</span>.notifyNestedSubs()</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.componentDidUpdate = <span class="built_in">this</span>.notifyNestedSubsOnComponentDidUpdate</span><br><span class="line">       <span class="built_in">this</span>.setState(dummyState)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">notifyNestedSubsOnComponentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.componentDidUpdate = <span class="literal">undefined</span></span><br><span class="line">     <span class="built_in">this</span>.notifyNestedSubs()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">isSubscribed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="built_in">this</span>.subscription) &amp;&amp; <span class="built_in">this</span>.subscription.isSubscribed()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">addExtraProps</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (!withRef &amp;&amp; !renderCountProp &amp;&amp; !(<span class="built_in">this</span>.propsMode &amp;&amp; <span class="built_in">this</span>.subscription)) <span class="keyword">return</span> props</span><br><span class="line">     <span class="keyword">const</span> withExtras = &#123; ...props &#125;</span><br><span class="line">     <span class="keyword">if</span> (withRef) withExtras.ref = <span class="built_in">this</span>.setWrappedInstance</span><br><span class="line">     <span class="keyword">if</span> (renderCountProp) withExtras[renderCountProp] = <span class="built_in">this</span>.renderCount++</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.propsMode &amp;&amp; <span class="built_in">this</span>.subscription) withExtras[subscriptionKey] = <span class="built_in">this</span>.subscription</span><br><span class="line">     <span class="keyword">return</span> withExtras</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> selector = <span class="built_in">this</span>.selector</span><br><span class="line">     selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (selector.error) &#123;</span><br><span class="line">       <span class="keyword">throw</span> selector.error</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> createElement(WrappedComponent, <span class="built_in">this</span>.addExtraProps(selector.props))</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>查看完它的源代码可以很容易知道，这个组件本质上呢，是将WrappedComponent加入了一些新的props属性后作为一个children的HOC，所以相关更新逻辑，都在Connect里面。</p>
<h4 id="initSelector-amp-amp-redux回顾"><a href="#initSelector-amp-amp-redux回顾" class="headerlink" title="initSelector &amp;&amp; redux回顾"></a>initSelector &amp;&amp; redux回顾</h4><p>关于initSelector这个，必须关联redux来看。当我们进行订阅时候实质上是在依赖redux进行订阅，而react-redux这里的订阅只是基于此的包装。我们在Provider组件中传入的store这个props，它的初始值由redux包里面的createStore函数而来。</p>
<p>关于这个函数，可以看看它最后的return部分和ReadMe里面的最简用例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  dispatch,</span><br><span class="line">  subscribe,</span><br><span class="line">  getState,</span><br><span class="line">  replaceReducer,</span><br><span class="line">  [$$observable]: observable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">counter</span>(<span class="params">state = <span class="number">0</span>, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INCREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DECREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> store = createStore(counter)</span><br><span class="line">store.subscribe(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(store.getState()))</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;) <span class="comment">// 1</span></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;) <span class="comment">// 2</span></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;) <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>initSelector这个函数中selectorFactory函数指向selectorFactory.js中的finalPropsSelectorFactory。</p>
<p>当我们在页面内运行this.props.dispatch实际上是在执行redux上的dispatch, 那么可以看看这个dispatch是如何挂载到HOC的props上的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params">dispatch, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  ...options</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    verifySubselectors(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.pure</span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selectorFactory(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合initSelector的代码，可以相对容易理解这一点。</p>
<h4 id="initSubscription"><a href="#initSubscription" class="headerlink" title="initSubscription"></a>initSubscription</h4><p>关于initSubscription函数呢，他做的事情很明显是利用redux的dispatch来触发我们的组件重新加载，这里按图索骥看看这个操作是如何达成的。</p>
<p>首先是更新这块的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">onStateChange</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.selector.run(<span class="built_in">this</span>.props)</span><br><span class="line">  <span class="comment">// 如果不需要更新直接发布 有些store变量没有被组件引用</span></span><br><span class="line">  <span class="comment">// 否则设置组件componentDidUpdate生命周期方法 并使用setState空数据进行更新</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.selector.shouldComponentUpdate) &#123; </span><br><span class="line">    <span class="built_in">this</span>.notifyNestedSubs()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// notifyNestedSubsOnComponentDidUpdate</span></span><br><span class="line">    <span class="built_in">this</span>.componentDidUpdate = <span class="built_in">this</span>.notifyNestedSubsOnComponentDidUpdate</span><br><span class="line">    <span class="built_in">this</span>.setState(dummyState)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">notifyNestedSubsOnComponentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 当`onStateChange`确定需要发布嵌套的subs时，`componentDidUpdate`是有条件触发的 </span></span><br><span class="line">    <span class="comment">// 一旦这个函数被调用，`componentDidUpdate`不会直接被调用，直到进一步发生状态变化才会被调用。 </span></span><br><span class="line">    <span class="comment">// 采用这样做法相比使用永久的`componentDidUpdate`每次进行布尔值检查</span></span><br><span class="line">    <span class="comment">// 避免了大部分场景下的不必要的方法调用 从而带来一些性能提升。</span></span><br><span class="line">    <span class="built_in">this</span>.componentDidUpdate = <span class="literal">undefined</span></span><br><span class="line">    <span class="built_in">this</span>.notifyNestedSubs()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个notifyNestedSubsOnComponentDidUpdate的注释怎么理解呢？当我们后面调用this.setState({})后，将会触发组件的更新行为。</p>
<p>假设有一个嵌套发布行为，如果每次发布直接手动计算要不要继续发布(意思是直接发布还是更新组件后再发布)，势必每次都要计算这个布尔值。</p>
<p>而通过对componentDidUpdate进行处理，每次发布后只有更新了 才会继续跟进发布。<strong>简而言之，这里是一个有条件的遍历行为，只不过利用了componentDidUpdate生命周期。</strong>这里的遍历行为基本是onStateChange函数依托componentDidUpdate&amp;&amp;notifyNestedSubs进行的。</p>
<p>他的遍历路径大致是这样的：</p>
<p><strong>首先， onStateChange被触发，如果经过计算，需要更新组件，那么设置componentDidUpdate为notifyNestedSubsOnComponentDidUpdate，并使用setState进行更新，更新完毕之后notifyNestedSubsOnComponentDidUpdate被react生命周期componentDidUpdate调用(同时会设置ComponentDid为undefined防止下次被无故调用)，它执行的notifyNestedSubs会再次触发onStateChange，如此循环遍历直到不再需要进行组件更新。</strong></p>
<p>到这里这个更新环节如何运行的基本就有脉络了。<strong>现在的问题在于订阅后是如何调用到onStateChange的</strong>。</p>
<hr>
<p>这里订阅如何引起onStateChange？这里在initSubscription这里找找路径。这里主要代码是react-redux/src/utils/Subscription.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">store, parentSub, onStateChange</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.store = store</span><br><span class="line">    <span class="built_in">this</span>.parentSub = parentSub</span><br><span class="line">    <span class="built_in">this</span>.onStateChange = onStateChange</span><br><span class="line">    <span class="built_in">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">    <span class="built_in">this</span>.listeners = nullListeners</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">addNestedSub</span>(<span class="params">listener</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.trySubscribe()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.listeners.subscribe(listener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">trySubscribe</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="built_in">this</span>.unsubscribe = <span class="built_in">this</span>.parentSub</span><br><span class="line">        ? <span class="built_in">this</span>.parentSub.addNestedSub(<span class="built_in">this</span>.onStateChange)</span><br><span class="line">        : <span class="built_in">this</span>.store.subscribe(<span class="built_in">this</span>.onStateChange)</span><br><span class="line"> </span><br><span class="line">      <span class="built_in">this</span>.listeners = createListenerCollection()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里核心部分是trySubscribe和addNestedSub里面的<code>this.store.subscribe(this.onStateChange)</code>和<code>this.listeners.subscribe(listener)</code>部分。对比之前提到的redux简单用例，可以发现这里就完成了整体的过程的追索。这里的unsubscribe赋值只是从闭包中缓存一个解除订阅的函数指针，这个函数可以方便的直接解除订阅(退订)。</p>
<h1 id="一个成熟项目的结构"><a href="#一个成熟项目的结构" class="headerlink" title="一个成熟项目的结构"></a>一个成熟项目的结构</h1><p>前面扯了那么多，最后还是看看一个成熟项目是如何应用react-redux的, 这里代码基本保留主体，删除无关redux代码。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: App.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; configureStore &#125; <span class="keyword">from</span> <span class="string">&#x27;app/store&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> store = configureStore();</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;App /&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// file: app/store/index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Store, createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RootState, rootReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;app/reducers&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; rootSaga &#125; <span class="keyword">from</span> <span class="string">&#x27;../sagas&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">initialState?: RootState</span>): <span class="title">Store</span>&lt;<span class="title">RootState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> sagaMiddleware = createSagaMiddleware();</span><br><span class="line">  <span class="keyword">const</span> store = createStore(rootReducer <span class="keyword">as</span> any, initialState <span class="keyword">as</span> any, middleware) <span class="keyword">as</span> Store&lt;</span><br><span class="line">    RootState</span><br><span class="line">  &gt;</span><br><span class="line">  sagaMiddleware.run(rootSaga);</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// file: app/reducers/index.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> rootReducer = combineReducers&lt;RootState&gt;(&#123;</span><br><span class="line">  routing: routerReducer,</span><br><span class="line">  <span class="built_in">global</span>: globalReducer <span class="keyword">as</span> any,</span><br><span class="line">  dashBoard: dashBoardReducer <span class="keyword">as</span> any,</span><br><span class="line">  ......</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState: RootState.DashBoardState = <span class="keyword">from</span>(&#123;</span><br><span class="line">  loading: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// file: dashBoardReducer.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dashBoardReducer = handleActions&lt;RootState.DashBoardState, DashBoardModel&gt;(</span><br><span class="line">  &#123;</span><br><span class="line">    [dashBoardActions.Type.SAVE]: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> state.merge(action.payload || &#123;&#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    [dashBoardActions.Type.RESET]: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> initialState;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  initialState,</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里项目里面用到了Typescript, 不过忽略它，看看当前redux主流的应用，基本都是基于这个结构了。</p>
<p>关于redux.createReducer在前面已经提到过了，这里就不再说，主要是combineReducers可能要简单提一下，他本质上是将对个对象合并为一个对象，然后传入到createReduce使用。仔细思考一下，其实这样就和前面提到的一模一样了。</p>
<h1 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h1><p>这里还需要提到的是redux-saga。redux相关操作都是实时的，那么异步只靠它也就无能为力了，但是它定义了中间件接口。通过这个中间件，它可以实现异步的处理。</p>
<p>Redux 的中间件提供的是位于 <code>action</code> 被发起之后，到达 <code>reducer</code> 之前的扩展点，换而言之，原本 <code>view -&gt; action -&gt; reducer -&gt; store</code> 的数据流加上中间件后变成了 <code>view -&gt; action -&gt; middleware -&gt; reducer -&gt; store</code> ，在这一环节我们可以做一些 “副作用” 的操作，如 异步请求、打印日志。</p>
<p>一个简单的中间件:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logger: Middleware = <span class="function">(<span class="params">store</span>) =&gt;</span> <span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(action);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里不对redux-sagas做太多的分析，我们看看一个简单的sagas是怎样写的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">getUserSagas</span>(<span class="params">action: any</span>): <span class="title">Iterator</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = action.payload;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">yield</span> call(AuthApi.getUserDetail, id);</span><br><span class="line">    <span class="keyword">yield</span> put(accountEditActions.saveAction(&#123; <span class="attr">user</span>: data &#125;));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">watchFetchData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> takeEvery(accountEditActions.Type.GET_USER, getUserSagas);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当GET_USER这个action被触发，那么getUserSagas也会被触发。这里非常值得关注的，是这里的generate函数。</p>
<p>这里我们来看看applyMiddleware函数是如何实现的，以便对redux-sagas的实现进行一些分析。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(...args)</span><br><span class="line">    <span class="keyword">let</span> dispatch = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Dispatching while constructing your middleware is not allowed. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Other middleware would not be applied to this dispatch.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// compose Function</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> a(b(...args)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用参考</span></span><br><span class="line"><span class="keyword">let</span> middleware = applyMiddleware(loggerMiddleware);</span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer <span class="keyword">as</span> any, initialState <span class="keyword">as</span> any, middleware) <span class="keyword">as</span> Store&lt;</span><br><span class="line">RootState</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>除了这些不妨看看redux源码里面createStore里面关于第三个函数的处理:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综合起来看看这个调用路径做一些思考。思考一下这个体系中他们整体的调用路径:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">applyMiddleware(loggerMiddleware)-----------+</span><br><span class="line">    							            ↓</span><br><span class="line">createStore(rootReducer, initialState, sagaMiddleware)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看看applyMiddleware的代码结构:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(...middlewares) =&gt; <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...store,</span><br><span class="line">        dispatch</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当middleware被传入到createStore时候，他的结构脱去一层 变成了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> M = <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...store,</span><br><span class="line">        dispatch</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时如果设变量M为这个函数那么<code>const store = createStore(rootReducer, initialState, middleware)</code>实质上是执行了<code>M(createStore)(rootReducer, initialState)</code>。</p>
<p>那么，此处rootReducer, initialState就是作为…args参数执行进来了。此时呢,middlewares.map(() =&gt; {})这块代码又开始有些绕起来了,每个middleware(middlewareAPI)实质上都是这个函数结构被执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(store) =&gt; <span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>chain最终返回的结构式这样的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chain: <span class="built_in">Array</span>&lt;<span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;&gt;</span><br></pre></td></tr></table></figure>

<p>多看看compose函数，假设我们有多个中间件被传入进来，会发生什么呢？</p>
<p>这个变量M里面的<code>dispatch = compose(...chain)(store.dispatch)</code>最终是这样的一个逻辑:</p>
<p>假设我们最终有个ABC三个中间件，那么dispath最终调用链条是A(B(C(store.dispatch)))。这里一层一层的调用，在执行环节上从里面到外面。对于C来说next是store.dispatch，对于B来说next是C(store.dispatch)，对于A来说next是B(C(store.dispatch))。</p>
<p><strong>但是无论如何，最终所有的ABC都获取到了action</strong>，并且这个action并没有什么不同(假设这个action没有被认为修改的话)。</p>
<p>而对于store.dispatch来讲新的dispatch函数(在最终节点 它是store.dispatch(action)这样的调用),其实是在上游对原料做了有点小修改，但是并没有对后面的dispatch操作有任何干涉。</p>
<p><strong>也就是说redux中间件环节上并没有对genertor函数有依赖</strong>，理解这块对redux-sagas的工作范围有不小帮助。</p>
<h2 id="redux-saga追索"><a href="#redux-saga追索" class="headerlink" title="redux-saga追索"></a>redux-saga追索</h2><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>项目中可能写了很多很多saga代码了，大概可以了解到，redux-saga本质上是对generator函数的深入应用。</p>
<p>结合generator特性(即：generator会返回一个迭代器对象，而不是立即执行)、迭代器相关知识、以及redux中间件的理解，可以对saga的原理做出一些猜想(如果对Generator、Iterator了解不够的值得回程票去了解这块)。</p>
<p>这里的猜想是：saga本质上是利用generator函数返回一个根节点迭代器(设其名称为RootSaga)，这个迭代器可以通过中间件每次触发事件时候进行完整的遍历，并触发和当前action对应的generator函数(设名称为UserSaga)，并在generator利用yield关键词可以在这个函数中像写同步代码一样写相关回调。</p>
<p>在最后也会完整遍历这个UserSaga生成的迭代器。在这个UsserSaga中因为中间件缘故可以获取到state也可以获取dispatch，所以可以对state做读取，也可以做修改，这样就当里面的异步行为完成之后，可以实现异步对redux的state做变更。</p>
<h3 id="探寻"><a href="#探寻" class="headerlink" title="探寻"></a>探寻</h3><p>这里找到了最新的提交记录(commit: 10fc193f56f5db05a5ac45140642dbc6a4eed087)</p>
<h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><p>这里来个实际项目里面redux-saga如何注册的代码。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">initialState?: RootState</span>): <span class="title">Store</span>&lt;<span class="title">RootState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// create the saga middleware</span></span><br><span class="line">  <span class="keyword">const</span> sagaMiddleware = createSagaMiddleware();</span><br><span class="line">  <span class="keyword">let</span> middleware = applyMiddleware(loggerMiddleware, sagaMiddleware);</span><br><span class="line">  <span class="keyword">const</span> store = createStore(rootReducer <span class="keyword">as</span> any, initialState <span class="keyword">as</span> any, middleware) <span class="keyword">as</span> Store&lt;</span><br><span class="line">    RootState</span><br><span class="line">  &gt;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then run the saga</span></span><br><span class="line">  sagaMiddleware.run(rootSaga);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.tsx</span></span><br><span class="line"><span class="keyword">const</span> store = configureStore();</span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;App /&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>),</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里看看createSagaMiddleware。这里它实质上redux-saga的default导出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sagaMiddlewareFactory</span>(<span class="params">&#123; context = &#123;&#125;, channel = stdChannel(), sagaMonitor, ...options &#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> boundRunSaga</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sagaMiddleware</span>(<span class="params">&#123; getState, dispatch &#125;</span>) </span>&#123;</span><br><span class="line">    boundRunSaga = runSaga.bind(<span class="literal">null</span>, &#123;</span><br><span class="line">      ...options,</span><br><span class="line">      context,</span><br><span class="line">      channel,</span><br><span class="line">      dispatch,</span><br><span class="line">      getState,</span><br><span class="line">      sagaMonitor,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (sagaMonitor &amp;&amp; sagaMonitor.actionDispatched) &#123;</span><br><span class="line">        sagaMonitor.actionDispatched(action)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> result = next(action) <span class="comment">// hit reducers</span></span><br><span class="line">      channel.put(action)</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sagaMiddleware.run = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> boundRunSaga(...args)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sagaMiddleware.setContext = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">    assignWithSymbols(context, props)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sagaMiddleware</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本质上它的返回值和之前提到的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(store) =&gt; <span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构并无二致。<code>&#123; getState, dispatch &#125;</code>也无非是对store解构赋值。</p>
<p>后面的sagaMiddleware.run(rootSaga)则实质上调用了boundRunSaga，这个boundRunSaga是对runSaga进行了上下文绑定和传参，但是没有执行。runSaga函数如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runSaga</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; channel = stdChannel(), dispatch, getState, context = &#123;&#125;, sagaMonitor, effectMiddlewares, onError = logError &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  saga,</span></span></span><br><span class="line"><span class="function"><span class="params">  ...args</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> iterator = saga(...args)</span><br><span class="line">  <span class="keyword">const</span> effectId = nextSagaId()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...略过若干</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> env = &#123;</span><br><span class="line">    channel,</span><br><span class="line">    dispatch: wrapSagaDispatch(dispatch),</span><br><span class="line">    getState,</span><br><span class="line">    sagaMonitor,</span><br><span class="line">    onError,</span><br><span class="line">    finalizeRunEffect,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> immediately(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> task = proc(env, iterator, context, effectId, getMetaInfo(saga), <span class="comment">/* isRoot */</span> <span class="literal">true</span>, noop)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sagaMonitor) &#123;</span><br><span class="line">      sagaMonitor.effectResolved(effectId, task)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其返回值是immediately(cb), 这个immediately正常情况下会将cb原样返回。也就是说，正常情况下返回值是<code>proc(env, iterator, context, effectId, getMetaInfo(saga), /* isRoot */ true, noop)</code>。而proc返回值，又是newTask函数的返回值，这是一个预先定义好的task对象。</p>
<p>也就是说<code>sagaMiddleware.run</code>、<code>runSaga</code>、<code>proc</code>执行后都返回了一个「task」的对象。</p>
<p>其中我们编写的saga业务代码都在iterator中，这是其中需要重点理解的地方。proc函数是整个redux-saga里面很关键的一个函数，不过这之前，先看看业务代码里面的saga，以及承担分发任务的takeEvery和takeLatest。</p>
<h4 id="分发-takeEvery-amp-amp-takeLatest"><a href="#分发-takeEvery-amp-amp-takeLatest" class="headerlink" title="分发:takeEvery &amp;&amp; takeLatest"></a>分发:takeEvery &amp;&amp; takeLatest</h4><p>这两个分发函数区别在于takeEvery允许多个异步任务同时触发，而takeLatest则一次只能触发一个异步任务，当已有异步任务执行中，那么新的将会被取消。</p>
<p>下面是它们的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// takeEvery</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">takeEvery</span>(<span class="params">patternOrChannel, worker, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> yTake = &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: take(patternOrChannel) &#125;</span><br><span class="line">  <span class="keyword">const</span> yFork = <span class="function"><span class="params">ac</span> =&gt;</span> (&#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: fork(worker, ...args, ac) &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> action,</span><br><span class="line">    setAction = <span class="function"><span class="params">ac</span> =&gt;</span> (action = ac)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fsmIterator(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">q1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q2&#x27;</span>, <span class="attr">effect</span>: yTake, <span class="attr">stateUpdater</span>: setAction &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">q2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q1&#x27;</span>, <span class="attr">effect</span>: yFork(action) &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;q1&#x27;</span>,</span><br><span class="line">    <span class="string">`takeEvery(<span class="subst">$&#123;safeName(patternOrChannel)&#125;</span>, <span class="subst">$&#123;worker.name&#125;</span>)`</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// takeLatest</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">takeLatest</span>(<span class="params">patternOrChannel, worker, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> yTake = &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: take(patternOrChannel) &#125;</span><br><span class="line">  <span class="keyword">const</span> yFork = <span class="function"><span class="params">ac</span> =&gt;</span> (&#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: fork(worker, ...args, ac) &#125;)</span><br><span class="line">  <span class="keyword">const</span> yCancel = <span class="function"><span class="params">task</span> =&gt;</span> (&#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: cancel(task) &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> task, action</span><br><span class="line">  <span class="keyword">const</span> setTask = <span class="function"><span class="params">t</span> =&gt;</span> (task = t)</span><br><span class="line">  <span class="keyword">const</span> setAction = <span class="function"><span class="params">ac</span> =&gt;</span> (action = ac)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fsmIterator(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">q1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q2&#x27;</span>, <span class="attr">effect</span>: yTake, <span class="attr">stateUpdater</span>: setAction &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">q2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> task</span><br><span class="line">          ? &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q3&#x27;</span>, <span class="attr">effect</span>: yCancel(task) &#125;</span><br><span class="line">          : &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q1&#x27;</span>, <span class="attr">effect</span>: yFork(action), <span class="attr">stateUpdater</span>: setTask &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">q3</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q1&#x27;</span>, <span class="attr">effect</span>: yFork(action), <span class="attr">stateUpdater</span>: setTask &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;q1&#x27;</span>,</span><br><span class="line">    <span class="string">`takeLatest(<span class="subst">$&#123;safeName(patternOrChannel)&#125;</span>, <span class="subst">$&#123;worker.name&#125;</span>)`</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里fsmIterator函数是关键。它生成了一个Iterator，并为这个Iterator自定义了一个next</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">fsmIterator</span>(<span class="params">fsm, startState, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> stateUpdater,</span><br><span class="line">    errorState,</span><br><span class="line">    effect,</span><br><span class="line">    nextState = startState</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">arg, error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextState === qEnd) &#123;</span><br><span class="line">      <span class="keyword">return</span> done(arg)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; !errorState) &#123;</span><br><span class="line">      nextState = qEnd</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      stateUpdater &amp;&amp; stateUpdater(arg)</span><br><span class="line">      <span class="keyword">const</span> currentState = error ? fsm[errorState](error) : fsm[nextState]()</span><br><span class="line">      ;(&#123; nextState, effect, stateUpdater, errorState &#125; = currentState)</span><br><span class="line">      <span class="keyword">return</span> nextState === qEnd ? done(arg) : effect</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> makeIterator(next, <span class="function"><span class="params">error</span> =&gt;</span> next(<span class="literal">null</span>, error), name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>makeIterator这个函数比较简单，这里只简单说下，它主要接收三个三个参数，next函数、抛错函数、name, 根据这个返回一个迭代器对象回来。</p>
<p>那么这里可以返回fsmIterator思考一下它做了什么。仔细观察这个next函数，以及其返回值，可以很容易发现:无论何种原因和状况，只有在nextState === qEnd时候才会才会返回{done: true, value}(done函数返回值)，而其他情况下呢，只会<strong>不断地执行stateUpdater(q1,q2, q3里面定义的，如果有的话)，并返回effect</strong>(也是q1,q2, q3里面的)——永不停止，直到有一天，它抛出错误，捕获然后执行done——这时候所有后面所有的异步都不会再执行了，换句话说，你的应用，依赖异步的部分，全挂了。</p>
<p>这个过程如果足够完美，takeEvery地路径是q1-&gt;q2-&gt;q1-&gt;q2….，takeLastet地路径有分支并不固定，但是也是在当前的nextState中，如此循环往复永不歇止。</p>
<p><strong>这种不会停止的遍历循环，正是redux-saga之所以注册一次就可以不断异步响应action的精髓所在。而它一旦停止下来，整个应用也就随之戛然而止——也许大家都有遇到过在一个sagas文件里面没有try…catch捕获错误而导致整个应用所有异步请求全挂的经历。</strong></p>
<h4 id="Side-Effect"><a href="#Side-Effect" class="headerlink" title="Side Effect"></a>Side Effect</h4><p>之所以单独小章节来说，还是因为takeEvery&amp;takeLastest循环往复的遍历过程中会不会的调用到fork、take、cancel这些。</p>
<p>Side Effect包括take|fork|cancel|put|select|call等等这些。</p>
<p>这些都是redux-saga使用时候可以用到的Side Effect，这其中呢，call, select, put尤其常用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// put</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">channel, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (is.undef(action)) &#123;</span><br><span class="line">    action = channel</span><br><span class="line">    <span class="comment">// `undefined` instead of `null` to make default parameter work</span></span><br><span class="line">    channel = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> makeEffect(effectTypes.PUT, &#123; channel, action &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// call</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">fnDescriptor, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> makeEffect(effectTypes.CALL, getFnCallDescriptor(fnDescriptor, args))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// select</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">selector = identity, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> makeEffect(effectTypes.SELECT, &#123; selector, args &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// makeEffect</span></span><br><span class="line"><span class="keyword">const</span> makeEffect = <span class="function">(<span class="params">type, payload</span>) =&gt;</span> (&#123;</span><br><span class="line">  [IO]: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// this property makes all/race distinguishable in generic manner from other effects</span></span><br><span class="line">  <span class="comment">// currently it&#x27;s not used at runtime at all but it&#x27;s here to satisfy type systems</span></span><br><span class="line">  combinator: <span class="literal">false</span>,</span><br><span class="line">  type,</span><br><span class="line">  payload,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// getFnCallDescriptor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFnCallDescriptor</span>(<span class="params">fnDescriptor, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> context = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">let</span> fn</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is.func(fnDescriptor)) &#123;</span><br><span class="line">    fn = fnDescriptor</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.array(fnDescriptor)) &#123;</span><br><span class="line">      ;[context, fn] = fnDescriptor</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ;(&#123; context, fn &#125; = fnDescriptor)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context &amp;&amp; is.string(fn) &amp;&amp; is.func(context[fn])) &#123;</span><br><span class="line">      fn = context[fn]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; context, fn, args &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后返回的结构大致如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@@redux-saga/IO&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;combinator&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;PUT&quot;</span>,</span><br><span class="line">  <span class="string">&quot;payload&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;channel&quot;</span>: <span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;action&quot;</span>: <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="proc函数"><a href="#proc函数" class="headerlink" title="proc函数"></a>proc函数</h4><p>proc应该可以拎出来单独说说，前面提到了takeEvery&amp;takelatest返回的迭代器正常情况是一个无限向后遍历的迭代器，但是这个迭代器之前又在另外一个迭代器rootSaga里面，所以我们还需要一个引子来开个头点个火。proc干的就是这事。</p>
<p><strong>他本质上和for…of遍历迭代器没啥区别</strong>，不过内部还是有很多细节处理。</p>
<p>当我们编写的业务异步代码被执行的时候，执行各种put、call、select各种Side Effect的时候，实质上所有的返回值最后都会返回Side Effect的返回值作为迭代器next的返回值给proc函数。也就是上面提到的那个大致结构。到最后各种情况，风也好雨也罢，最终会执行到effectRunner函数。这个函数来自effectRunnerMap，这是一个Map结构，可以根据上面那个数据结构的type返回一个函数effectRunner，并做出最终处理的调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> effectRunnerMap = &#123;</span><br><span class="line">  [effectTypes.TAKE]: runTakeEffect,</span><br><span class="line">  [effectTypes.PUT]: runPutEffect,</span><br><span class="line">  [effectTypes.ALL]: runAllEffect,</span><br><span class="line">  [effectTypes.RACE]: runRaceEffect,</span><br><span class="line">  [effectTypes.CALL]: runCallEffect,</span><br><span class="line">  [effectTypes.CPS]: runCPSEffect,</span><br><span class="line">  [effectTypes.FORK]: runForkEffect,</span><br><span class="line">  [effectTypes.JOIN]: runJoinEffect,</span><br><span class="line">  [effectTypes.CANCEL]: runCancelEffect,</span><br><span class="line">  [effectTypes.SELECT]: runSelectEffect,</span><br><span class="line">  [effectTypes.ACTION_CHANNEL]: runChannelEffect,</span><br><span class="line">  [effectTypes.CANCELLED]: runCancelledEffect,</span><br><span class="line">  [effectTypes.FLUSH]: runFlushEffect,</span><br><span class="line">  [effectTypes.GET_CONTEXT]: runGetContextEffect,</span><br><span class="line">  [effectTypes.SET_CONTEXT]: runSetContextEffect,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="部分effectRunner"><a href="#部分effectRunner" class="headerlink" title="部分effectRunner"></a>部分effectRunner</h5><p>这里看最常见的<strong>yield call</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCallEffect</span>(<span class="params">env, &#123; context, fn, args &#125;, cb, &#123; task &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// catch synchronous failures; see #152</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = fn.apply(context, args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is.promise(result)) &#123;</span><br><span class="line">      resolvePromise(result, cb)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is.iterator(result)) &#123;</span><br><span class="line">      <span class="comment">// resolve iterator</span></span><br><span class="line">      proc(env, result, task.context, currentEffectId, getMetaInfo(fn), <span class="comment">/* isRoot */</span> <span class="literal">false</span>, cb)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb(result)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    cb(error, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有fn和args，分别是我们写的generator函数里面传入call的两个参数，可以看到这里call不仅可以接受Promise，它还能接一个一个generator函数这样返回的迭代器可以用proc来遍历。这里generator操作可能会比Promise更加灵活，例如，我们初始化一个3级的级联菜单初始值，如果用promise可能要saga里面手动写三个yield call(PromiseFunction, args), 而generator里面可以直接放三个yield PromiseFunction(args)然后通过proc遍历就可以了。</p>
<p>再看看<strong>yield put</strong>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runPutEffect</span>(<span class="params">env, &#123; channel, action, resolve &#125;, cb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   Schedule the put in case another saga is holding a lock.</span></span><br><span class="line"><span class="comment">   The put will be executed atomically. ie nested puts will execute after</span></span><br><span class="line"><span class="comment">   this put has terminated.</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  asap(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = (channel ? channel.put : env.dispatch)(action)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      cb(error, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resolve &amp;&amp; is.promise(result)) &#123;</span><br><span class="line">      resolvePromise(result, cb)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cb(result)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// Put effects are non cancellables</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般项目里面正常情况put都是直接接到一个action然后执行redux的dispatch(action)。</p>
<p>asap这个函数很常见，主要是用来调度微任务，让当前任务立刻排到当前微任务队列最后面以尽可能快的速度执行。在此处的话，如果我们yield put里面还嵌套一个yield put的话，因为函数执行都是先里层后外层，所以内部嵌套的put会排在前面被先执行。</p>
<p><strong>select</strong>的比较简单就不提及了。</p>
<h5 id="saga的注册"><a href="#saga的注册" class="headerlink" title="saga的注册"></a>saga的注册</h5><p>这里需要串联一下前面所有的内容。主要是以下几点</p>
<ul>
<li><p><code>sagaMiddleware.run(rootSaga)</code>最终调用<code>proc</code>函数</p>
</li>
<li><p><code>rootSaga</code>最终执行返回的迭代最终是<code>takeEvery & takeLatest</code>返回值</p>
</li>
<li><p><code>takeEvery & takeLatest</code>无限遍历，返回值是<code>Side Effect</code></p>
</li>
<li><p><code>Side Effect</code>最终结构为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@@redux-saga/IO&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;combinator&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Fork&quot;</span>,</span><br><span class="line">  <span class="string">&quot;payload&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;channel&quot;</span>: <span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;action&quot;</span>: <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>effectRunner会接收这个参数并做出响应。</p>
</li>
</ul>
<p>鉴于takeEvery里面调用到了take、fork，所以这里最后分析一下下面代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> yTake = &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: take(patternOrChannel) &#125;</span><br><span class="line"><span class="keyword">const</span> yFork = <span class="function"><span class="params">ac</span> =&gt;</span> (&#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: fork(worker, ...args, ac) &#125;)</span><br><span class="line"><span class="keyword">return</span> fsmIterator(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="title">q1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q2&#x27;</span>, <span class="attr">effect</span>: yTake, <span class="attr">stateUpdater</span>: setAction &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">q2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">nextState</span>: <span class="string">&#x27;q1&#x27;</span>, <span class="attr">effect</span>: yFork(action) &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;q1&#x27;</span>,</span><br><span class="line">  <span class="string">`takeEvery(<span class="subst">$&#123;safeName(patternOrChannel)&#125;</span>, <span class="subst">$&#123;worker.name&#125;</span>)`</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h6 id="take相关"><a href="#take相关" class="headerlink" title="take相关"></a>take相关</h6><p>通常来说take(patternOrChannel)返回值是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  @@redux-saga/IO: <span class="literal">true</span>,</span><br><span class="line">  combinator: <span class="literal">false</span>,</span><br><span class="line">  type: <span class="string">&#x27;TAKE&#x27;</span>,</span><br><span class="line">  payload: &#123; <span class="attr">pattern</span>: patternOrChannel &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看看对应的runTakeEffect</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runTakeEffect</span>(<span class="params">env, &#123; channel = env.channel, pattern, maybe &#125;, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> takeCb = <span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">      cb(input, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isEnd(input) &amp;&amp; !maybe) &#123;</span><br><span class="line">      cb(TERMINATE)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    cb(input)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    channel.take(takeCb, is.notUndef(pattern) ? matcher(pattern) : <span class="literal">null</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    cb(err, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  cb.cancel = takeCb.cancel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的代码还是chanel.take的调用。这里channel常规情况下有一个默认值，来自stdChannel函数的返回值，而这个函数中返回值又来自multicastChannel函数(这两个函数都在packages/core/src/internal/channel.js)。</p>
<p>它返回了一个有put|take|close三个方法的对象。</p>
<p><strong>take所做的事基本就是将cb也就是runTakeEffect函数中的takeCb存到nextTakers中，这个nextTakers在闭包中，可以被其他地方调用put调用到</strong>。这个时候，回头去看看<code>sagaMiddlewareFactory</code>函数，看看里面的这一块代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sagaMiddleware</span>(<span class="params">&#123; getState, dispatch &#125;</span>) </span>&#123;</span><br><span class="line">  boundRunSaga = runSaga.bind(<span class="literal">null</span>, &#123;</span><br><span class="line">    ...options,</span><br><span class="line">    context,</span><br><span class="line">    channel,</span><br><span class="line">    dispatch,</span><br><span class="line">    getState,</span><br><span class="line">    sagaMonitor,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sagaMonitor &amp;&amp; sagaMonitor.actionDispatched) &#123;</span><br><span class="line">      sagaMonitor.actionDispatched(action)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = next(action) <span class="comment">// hit reducers</span></span><br><span class="line">    channel.put(action)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关注点放到<code>channel.put(action)</code>,一切就尽在不言中了——他用于针对特定action注册好函数调用，当中间件收到这个action就立刻调用这个函数。</p>
<p>return这里有个<code>stateUpdater</code>参数需要注意，我们的迭代(fsmIterator)里面的自定义next函数会判断它，如果有就会被执行，那么在这里，<strong>yFork还会通过闭包获取上次take执行时候传进来的action</strong>。</p>
<p>但是这里还有一个地方需要思考，这个回调函数，是如何进一步迭代这个迭代器的呢？要知道，迭代器虽然可以不断遍历，但是仍然需要一只手时不时拨动一下让它不断往下走。这里需要进行参数追溯。其路径是这样：</p>
<p>proc函数中定义了一个next函数作为迭代器自定义的next，其中核心代码是<code>digestEffect(result.value, parentEffectId, next)</code>,当proc头一次运行时候执行了一次next，然后有一下调用路径：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">digestEffect-&gt;finalRunEffect-&gt;runEffect-&gt;RunTakeEffect-&gt;channel.take</span><br></pre></td></tr></table></figure>

<p>这样next函数通过这一条调用链，被digestEffect函数传参一直被传入到了channel.take里面，然后通过take缓存到了takers数组中，最后被put调用到了的同时，通过遍历takers数组并执行数组中符合action判定的函数——next函数的执行，便能将这个迭代器，每次接到新的action时候往前推进一步。同时，结合刚才提到的<code>stateUpdater</code>缓存action，我们也能进一步将目光放到fork上了。</p>
<h6 id="fork相关"><a href="#fork相关" class="headerlink" title="fork相关"></a>fork相关</h6><p>take看完之后得看看fork, 但是接上文的，我们可以明白take函数呢，至少是在当前这一步最多是执行的将action、next函数缓存下来，对函数执行并没有什么直接的调用，所以这个异步函数的执行，最终还是看fork函数或者更后面的调用。</p>
<p>我们接着take的逻辑往下推，当put执行的时候调用next，然后我们的迭代器被这个函数里面的往前执行了一步，当它执行这个操作的时候，它正停在take对应的q1上，向下一步之后就到了q2, 观察一下源代码发现又走到了runForkEffect(SideEffect)这条线上了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runForkEffect</span>(<span class="params">env, &#123; context, fn, args, detached &#125;, cb, &#123; task: parent &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> taskIterator = createTaskIterator(&#123; context, fn, args &#125;)</span><br><span class="line">  <span class="keyword">const</span> meta = getIteratorMetaInfo(taskIterator, fn)</span><br><span class="line"></span><br><span class="line">  immediately(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = proc(env, taskIterator, parent.context, currentEffectId, meta, detached, noop)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (detached) &#123;</span><br><span class="line">      cb(child)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (child.isRunning()) &#123;</span><br><span class="line">        parent.queue.addTask(child)</span><br><span class="line">        cb(child)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isAborted()) &#123;</span><br><span class="line">        parent.queue.abort(child.error())</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cb(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// Fork effects are non cancellables</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个createTaskIterator函数，就最简单的应用来讲<sup>注1</sup>，我们这里传进去的fn是我们写的业务代码generator函数，此时返回的就是一个业务generator函数生成的迭代器，同时action、SideEffect相关信息也被传入进去了。因为这个迭代器和takeEvery生成的不同它是有终点的，所以这个生成的child Task到了最后会被完整执行并停止。</p>
<p>这里先返回这个函数来讲，首先是child这个事proc返回一个Task对象，然后执行到后面isRuning() === true,接下来在cb(child)，这个cb之前有讲过，实质上是对proc函数内部的next的封装。当我们执行cb(task)时候，这里会触发一个对child迭代器的遍历。这里的脉络是:</p>
<ul>
<li><p>cb首先是proc函数传下来的next函数，执行他，如果我们使用takeEvery来注册绑定，那么此时会从q2回到q1。</p>
</li>
<li><p>基于上一条，fork会读取到闭包里面的take Action，这样会触发runTakeEffect,take动作此时才会被执行。</p>
</li>
<li><p>cb也就是next执行时候会触发内部那条<code>result = iterator.next(arg)</code>,然后这个iterator(业务代码生产的迭代器)就开始往下走，如果它的done值不为true，那么将会由digestEffect来触发runEffect函数，进而触发到达runForkEffect等等，而这些函数里面都会继续进而调用next直到这个迭代器done===true。</p>
</li>
</ul>
<h5 id="思考-1"><a href="#思考-1" class="headerlink" title="思考"></a>思考</h5><p>takeEvery不是必须。</p>
<p>实现同一个逻辑，我们可以有不同的写法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  takeEvery(<span class="string">&#x27;INCREMENT_ASYNC&#x27;</span>, incrementAsync)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> take(<span class="string">&#x27;INCREMENT_ASYNC&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> incrementAsync()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方法二 如果需要参数...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">yield</span> take(globalActions.Type.LOGIN);</span><br><span class="line">    <span class="keyword">yield</span> loginSaga(action);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方法三 如果需要参数...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">yield</span> take(globalActions.Type.LOGIN);</span><br><span class="line">    <span class="keyword">yield</span> fork(<span class="function">() =&gt;</span> loginSaga(action));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以试想一下，</p>
<ul>
<li><p>为什么takeEvery可以不用while(true){}这种写法？而后面需要？</p>
<p>如果我们后面不写while(true){}这种语法，那么会导致我们的异步仅仅会被触发一次。</p>
<p>当使用了这种写法，按照js语法那肯定是死循环了，但是在generator函数中，配合yield就可以进行中断，可以保证这个迭代器永远不会有done===true那一刻。</p>
<p>为什么redux-saga内部采用这种简单省事的做法？因为redux-saga里面有对异步任务的cancel机制，我们可以需要一个异步任务的执行，如果采用这种机制，则没有取消的余地——takeLatest就是采用了这种机制。</p>
</li>
<li><p>yield fork(() =&gt; sagaGeneraotor())和直接yield sagaGeneraotor()调用有什么区别？</p>
<p>这点其实在分析fork函数行为中已经可见一斑了，fork会在next执行过程中采用新建task的方式进行插队并立刻执行，而不用等待后面相关action的完成。</p>
</li>
</ul>
<h1 id="一些有用的包"><a href="#一些有用的包" class="headerlink" title="一些有用的包"></a>一些有用的包</h1><h2 id="redux-actions"><a href="#redux-actions" class="headerlink" title="redux-actions"></a>redux-actions</h2><p>mapDispatchToProps的编写是挺折腾人的。举个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    changePickerTarget: <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(changePickTarget(index));</span><br><span class="line">      dispatch(changePickState());</span><br><span class="line">    &#125;,</span><br><span class="line">    changeRoute: <span class="function">(<span class="params">url</span>) =&gt;</span> dispatch(push(url)),</span><br><span class="line">    togglePick: <span class="function">() =&gt;</span> dispatch(changePickState()),</span><br><span class="line">    toggleDatePick: <span class="function">() =&gt;</span> dispatch(changeDatePickState()),</span><br><span class="line">    fetchPickData: <span class="function">() =&gt;</span> dispatch(fetchPickData()),</span><br><span class="line">    fetchStoreInfo: <span class="function">() =&gt;</span> dispatch(fetchStoreInfo()),</span><br><span class="line">    fetchProjectData: <span class="function">() =&gt;</span> dispatch(fetchProjectData()),</span><br><span class="line">    changeSubmitData: <span class="function">(<span class="params">idx, val</span>) =&gt;</span> dispatch(changeSubmitData(idx, val)),</span><br><span class="line">    changePickText: <span class="function">(<span class="params">idx, val</span>) =&gt;</span> dispatch(changePickText(idx, val)),</span><br><span class="line">    submitData: <span class="function">() =&gt;</span> dispatch(submitData()),</span><br><span class="line">    submitCallback: <span class="function">(<span class="params">data</span>) =&gt;</span> dispatch(submitCallback(data)),</span><br><span class="line">    dispatch,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>actions的编写也挺烦：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setSubmitStatus</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: CHANGE_SUBMIT_STATUS,</span><br><span class="line">    bool,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过redux-actions我们可以做很大的简化:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// actions</span></span><br><span class="line"><span class="keyword">export</span> namespace carInfoListActions &#123;</span><br><span class="line">  <span class="keyword">export</span> enum Type &#123;</span><br><span class="line">    GETLIST = <span class="string">&#x27;carInfoList/GETLIST&#x27;</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> getListAction = createAction&lt;Partial&lt;CarInfoListModel&gt;&gt;(Type.GETLIST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type carInfoListActions = Omit&lt;<span class="keyword">typeof</span> carInfoListActions, <span class="string">&#x27;Type&#x27;</span>&gt;;</span><br><span class="line"><span class="comment">// Page.tsx</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = (dispatch: Dispatch): <span class="function"><span class="params">any</span> =&gt;</span> (&#123;</span><br><span class="line">   actions: bindActionCreators(omit(carInfoListActions, <span class="string">&#x27;Type&#x27;</span>), dispatch),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="built_in">this</span>.props.actions.getListAction(params);</span><br></pre></td></tr></table></figure>





<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://hookey.cc/react/p/6376b912d6209066045402df6275dc6f.html">Redux-Saga原始碼解析 - 初始化和take</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react/" rel="tag"># react</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/06/15/react-Transaction/" rel="prev" title="React Transaction">
      <i class="fa fa-chevron-left"></i> React Transaction
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/06/15/react-route/" rel="next" title="react-route">
      react-route <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#react-redux%E8%BF%BD%E7%B4%A2"><span class="nav-number">1.</span> <span class="nav-text">react-redux追索</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#react-redux"><span class="nav-number">2.</span> <span class="nav-text">react-redux</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Provider%E7%BB%84%E4%BB%B6"><span class="nav-number">3.</span> <span class="nav-text">Provider组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#connect"><span class="nav-number">4.</span> <span class="nav-text">connect</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E7%AE%80%E5%86%B5"><span class="nav-number">4.1.</span> <span class="nav-text">项目使用简况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">4.2.</span> <span class="nav-text">源码剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createConnect"><span class="nav-number">4.2.1.</span> <span class="nav-text">createConnect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connectAdvanced"><span class="nav-number">4.2.2.</span> <span class="nav-text">connectAdvanced</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wrapWithConnect"><span class="nav-number">4.2.3.</span> <span class="nav-text">wrapWithConnect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Connect%E7%BB%84%E4%BB%B6"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">Connect组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initSelector-amp-amp-redux%E5%9B%9E%E9%A1%BE"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">initSelector &amp;&amp; redux回顾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initSubscription"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">initSubscription</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E6%88%90%E7%86%9F%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">5.</span> <span class="nav-text">一个成熟项目的结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Middleware"><span class="nav-number">6.</span> <span class="nav-text">Middleware</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#redux-saga%E8%BF%BD%E7%B4%A2"><span class="nav-number">6.1.</span> <span class="nav-text">redux-saga追索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-number">6.1.1.</span> <span class="nav-text">思考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E5%AF%BB"><span class="nav-number">6.1.2.</span> <span class="nav-text">探寻</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%8F%91-takeEvery-amp-amp-takeLatest"><span class="nav-number">6.1.2.2.</span> <span class="nav-text">分发:takeEvery &amp;&amp; takeLatest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Side-Effect"><span class="nav-number">6.1.2.3.</span> <span class="nav-text">Side Effect</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#proc%E5%87%BD%E6%95%B0"><span class="nav-number">6.1.2.4.</span> <span class="nav-text">proc函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E5%88%86effectRunner"><span class="nav-number">6.1.2.4.1.</span> <span class="nav-text">部分effectRunner</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#saga%E7%9A%84%E6%B3%A8%E5%86%8C"><span class="nav-number">6.1.2.4.2.</span> <span class="nav-text">saga的注册</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#take%E7%9B%B8%E5%85%B3"><span class="nav-number">6.1.2.4.2.1.</span> <span class="nav-text">take相关</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#fork%E7%9B%B8%E5%85%B3"><span class="nav-number">6.1.2.4.2.2.</span> <span class="nav-text">fork相关</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%9D%E8%80%83-1"><span class="nav-number">6.1.2.4.3.</span> <span class="nav-text">思考</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E6%9C%89%E7%94%A8%E7%9A%84%E5%8C%85"><span class="nav-number">7.</span> <span class="nav-text">一些有用的包</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#redux-actions"><span class="nav-number">7.1.</span> <span class="nav-text">redux-actions</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">8.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">que01</p>
  <div class="site-description" itemprop="description">自己的学习记录</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">que01</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"TXWIywcTsrMfVKtclog3CxDl-gzGzoHsz","app_key":"987dqIR4vvX2mQJjmAV86Qp0","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
